<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>CRIMSON | ENTERPRISE</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* ===== SEU CSS ORIGINAL (INTACTO) ===== */
:root {
    --primary:#ff0033;
    --primary-glow:rgba(255,0,51,.4);
    --bg:#000;
    --surface:#0a0a0b;
    --card:#141417;
    --border:#27272a;
    --text:#fff;
    --text-dim:#a1a1aa;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
body{background:var(--bg);color:var(--text);height:100dvh;display:flex;justify-content:center;overflow:hidden}
#app{width:100%;max-width:500px;height:100%;position:relative;display:flex;flex-direction:column}

/* ===== ADD: CALL AVATAR + CONTROLS ===== */
.call-avatar{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    z-index:2;
}
.call-avatar .avatar{
    width:140px;
    height:140px;
    font-size:48px;
}
.call-controls button{
    width:60px;
    height:60px;
    border-radius:50%;
    border:none;
    font-size:22px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
}
.mute-btn{background:#333;color:#fff}
.volume{
    width:120px;
    accent-color:var(--primary);
}
</style>
</head>

<body>
<div id="app">

<!-- ===== CALL UI ===== -->
<div id="call-ui" class="call-ui">
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay muted playsinline></video>

    <!-- AVATAR NA CHAMADA DE VOZ -->
    <div id="call-avatar" class="call-avatar">
        <div class="avatar" id="call-avatar-img"></div>
    </div>

    <div class="call-controls">
        <button class="mute-btn" onclick="sys.toggleMute()">
            <i id="mute-icon" class="ri-mic-fill"></i>
        </button>

        <input type="range" min="0" max="1" step="0.01" value="1"
               class="volume" onchange="sys.setVolume(this.value)">

        <button class="end-call" onclick="sys.endCall()">
            <i class="ri-phone-fill" style="transform:rotate(135deg)"></i>
        </button>
    </div>
</div>

<script>
/* ===== SEU JS ORIGINAL ===== */
const sys = {
peer:null,uid:null,db:{},activeConns:{},currentChat:null,
callStream:null,incomingCall:null,muted:false,

init(){
 const raw=localStorage.getItem('crimson_db');
 this.db=raw?JSON.parse(raw):{};
 const s=localStorage.getItem('crimson_session');
 if(s&&this.db[s]){this.uid=s;this.setupPeer()}
},

setupPeer(){
 this.peer=new Peer(this.uid);

 this.peer.on('call',call=>{
  if(confirm(`Recebendo chamada de ${call.peer}. Aceitar?`)){
    this.incomingCall=call;
    this.answerCall(false);
  }
 });
},

async getStream(video){
 return await navigator.mediaDevices.getUserMedia({video, audio:true});
},

async call(isVideo){
 const s=await this.getStream(isVideo);
 this.callStream=s;
 document.getElementById('local-video').srcObject=s;
 document.getElementById('call-ui').classList.add('active');

 if(!isVideo) this.showCallAvatar(this.currentChat);

 const c=this.peer.call(this.currentChat,s);
 this.handleMediaCall(c,isVideo);
},

async answerCall(isVideo){
 const s=await this.getStream(isVideo);
 this.callStream=s;
 document.getElementById('local-video').srcObject=s;
 document.getElementById('call-ui').classList.add('active');

 if(!isVideo) this.showCallAvatar(this.incomingCall.peer);

 this.incomingCall.answer(s);
 this.handleMediaCall(this.incomingCall,isVideo);
},

handleMediaCall(call,isVideo){
 call.on('stream',rs=>{
   const rv=document.getElementById('remote-video');
   rv.srcObject=rs;
   rv.volume=1;
   rv.play();
   if(isVideo){
     document.getElementById('call-avatar').style.display='none';
   }
 });
 call.on('close',()=>this.endCall(true));
},

toggleMute(){
 if(!this.callStream) return;
 this.muted=!this.muted;
 this.callStream.getAudioTracks().forEach(t=>t.enabled=!this.muted);
 document.getElementById('mute-icon').className=
   this.muted?'ri-mic-off-fill':'ri-mic-fill';
},

setVolume(v){
 document.getElementById('remote-video').volume=v;
},

showCallAvatar(id){
 const f=this.db[this.uid]?.friends?.[id];
 const el=document.getElementById('call-avatar-img');
 el.innerHTML=f?.pic?`<img src="${f.pic}">`:id[0].toUpperCase();
 document.getElementById('call-avatar').style.display='flex';
},

endCall(){
 if(this.incomingCall) this.incomingCall.close();
 if(this.callStream) this.callStream.getTracks().forEach(t=>t.stop());
 document.getElementById('call-ui').classList.remove('active');
 document.getElementById('call-avatar').style.display='none';
 this.callStream=null;
 this.incomingCall=null;
}
};

sys.init();
</script>
</body>
</html>
