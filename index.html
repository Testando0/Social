<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CRIMSON | ENTERPRISE</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #ff0033;
            --primary-glow: rgba(255, 0, 51, 0.4);
            --bg: #000000;
            --surface: #0a0a0b;
            --card: #141417;
            --border: #27272a;
            --text: #ffffff;
            --text-dim: #a1a1aa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; background: var(--bg); border-left: 1px solid var(--border); border-right: 1px solid var(--border); }

        /* AUTH */
        #auth-screen { position: absolute; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .auth-content { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }
        
        /* HEADER */
        header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(10,10,11,0.9); border-bottom: 1px solid var(--border); z-index: 800; backdrop-filter: blur(10px); }
        .user-meta { display: flex; align-items: center; gap: 12px; cursor: pointer; }

        .avatar { width: 44px; height: 44px; border-radius: 14px; background: var(--card); border: 1.5px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* VIEWS */
        .view { position: absolute; inset: 0; background: var(--bg); z-index: 900; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .view.active { transform: translateX(0); }

        /* CHAT */
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .sent { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        /* INPUT BAR - CORRIGIDO */
        .input-bar { padding: 15px; display: flex; gap: 10px; background: var(--surface); border-top: 1px solid var(--border); align-items: center; }
        .field { flex: 1; background: var(--bg); border: 1.5px solid var(--border); border-radius: 12px; color: #fff; padding: 14px; font-size: 15px; outline: none; height: 50px; }
        .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; }
        
        .fab { position: absolute; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; box-shadow: 0 8px 20px var(--primary-glow); cursor: pointer; z-index: 500; }

        /* CALL UI */
        .call-ui { position: fixed; inset: 0; z-index: 99999; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .call-ui.active { display: flex; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
        #local-video { width: 100px; height: 150px; position: absolute; bottom: 120px; right: 20px; border-radius: 12px; border: 2px solid var(--primary); object-fit: cover; z-index: 10; background: #111; }
        .call-info { position: relative; z-index: 5; text-align: center; margin-bottom: 20px; }
        .call-controls { position: absolute; bottom: 40px; display: flex; gap: 20px; z-index: 20; }
        .end-call { width: 65px; height: 65px; border-radius: 50%; background: #ff3b30; border: none; color: white; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <div style="margin-bottom: 40px; text-align: center;">
            <i class="ri-shield-keyhole-fill" style="font-size: 64px; color: var(--primary);"></i>
            <h1>CRIMSON</h1>
            <p style="color: var(--text-dim);">ENTERPRISE EDITION</p>
        </div>
        <div class="auth-content">
            <input type="text" id="auth-id" class="field" placeholder="ID do Usuário" style="text-align:center;">
            <input type="password" id="auth-pass" class="field" placeholder="Senha" style="text-align:center;">
            <button class="btn" onclick="sys.auth(false)">ENTRAR</button>
            <button class="btn" onclick="sys.auth(true)" style="background: var(--card); border: 1px solid var(--border);">CRIAR CONTA</button>
        </div>
    </div>

    <header>
        <div class="user-meta" onclick="sys.openView('view-me')">
            <div class="avatar" id="header-av"></div>
            <div>
                <div id="header-name" style="font-weight: 700;">...</div>
                <div style="font-size: 11px; color: var(--primary);">ONLINE</div>
            </div>
        </div>
        <i class="ri-settings-4-line" style="font-size: 24px; color: var(--text-dim);" onclick="sys.openView('view-me')"></i>
    </header>

    <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
    <div class="fab" onclick="sys.openView('view-add')"><i class="ri-user-add-line"></i></div>

    <div id="view-chat" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeChat()" style="font-size: 28px; cursor: pointer;"></i>
            <div style="flex:1; display:flex; align-items:center; gap:10px; margin-left:10px;" onclick="sys.showContact()">
                <div class="avatar" id="chat-av" style="width:36px; height:36px;"></div>
                <div id="chat-name" style="font-weight: 700;">Nome</div>
            </div>
            <div style="display:flex; gap:20px; font-size: 22px; color: var(--primary);">
                <i class="ri-phone-fill" onclick="sys.call(false)"></i>
                <i class="ri-vidicon-fill" onclick="sys.call(true)"></i>
            </div>
        </header>
        <div id="messages" class="chat-area"></div>
        <div class="input-bar">
            <input type="text" id="msg-input" class="field" placeholder="Mensagem...">
            <button class="btn" style="width:50px; height:50px; flex-shrink:0; padding:0;" onclick="sys.send()">
                <i class="ri-send-plane-fill" style="font-size: 20px;"></i>
            </button>
        </div>
    </div>

    <div id="view-add" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-add')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; margin-right:28px;">Adicionar</h3>
        </header>
        <div style="padding: 30px;">
            <input type="text" id="target-id" class="field" placeholder="ID do destinatário" style="width:100%; margin-bottom:20px;">
            <button class="btn" style="width:100%;" onclick="sys.addContact()">CONECTAR</button>
        </div>
    </div>

    <div id="view-me" class="view">
        <header><i class="ri-arrow-left-s-line" onclick="sys.closeView('view-me')" style="font-size: 28px;"></i></header>
        <div style="padding:20px; display:flex; flex-direction:column; align-items:center;">
            <div class="avatar" id="me-large-av" style="width:100px; height:100px; margin-bottom:20px; font-size:30px;"></div>
            <input type="text" id="edit-name" class="field" placeholder="Nome" style="width:100%; margin-bottom:10px;">
            <input type="text" id="edit-pic" class="field" placeholder="URL da Foto" style="width:100%; margin-bottom:20px;">
            <button class="btn" style="width:100%;" onclick="sys.saveProfile()">SALVAR</button>
            <button class="btn" style="width:100%; margin-top:10px; background:#222;" onclick="sys.logout()">SAIR</button>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <div class="call-info">
            <div id="call-status" style="font-size:18px; color:var(--primary); font-weight:bold; letter-spacing:2px;">CHAMADA EM CURSO</div>
        </div>
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-controls">
            <button class="end-call" onclick="sys.endCall()"><i class="ri-phone-fill" style="transform: rotate(135deg);"></i></button>
        </div>
    </div>
</div>

<script>
const sys = {
    peer: null, uid: null, db: {}, activeConns: {}, currentChat: null, callStream: null, incomingCall: null,

    init() {
        const raw = localStorage.getItem('crimson_db');
        this.db = raw ? JSON.parse(raw) : {};
        const session = localStorage.getItem('crimson_session');
        if(session && this.db[session]) { this.uid = session; this.startApp(); }
        document.getElementById('msg-input').onkeydown = (e) => { if(e.key === 'Enter') this.send(); };
    },

    auth(reg) {
        const id = document.getElementById('auth-id').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value.trim();
        if(!id || !pass) return;
        if(reg) {
            if(this.db[id]) return alert("ID ocupado");
            this.db[id] = { pass, name: id, pic: "", friends: {} };
            this.saveDb(); alert("Criado!");
        } else {
            if(!this.db[id] || this.db[id].pass !== pass) return alert("Erro");
            this.uid = id; localStorage.setItem('crimson_session', id); this.startApp();
        }
    },

    startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        this.peer = new Peer(this.uid);
        this.peer.on('connection', c => this.setupConn(c));
        this.peer.on('call', call => { if(confirm("Atender chamada?")) { this.incomingCall = call; this.answerCall(true); } });
        this.updateHeader(); this.renderHome();
    },

    setupConn(conn) {
        this.activeConns[conn.peer] = conn;
        conn.on('data', data => {
            if(data.type === 'msg') {
                this.pushMsg(conn.peer, conn.peer, data.text);
                if(this.currentChat === conn.peer) this.renderMessages(); else this.renderHome();
            }
        });
    },

    send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text || !this.currentChat) return;
        this.pushMsg(this.currentChat, this.uid, text);
        this.renderMessages();
        input.value = '';

        let conn = this.activeConns[this.currentChat];
        if(conn && conn.open) {
            conn.send({ type: 'msg', text });
        } else {
            conn = this.peer.connect(this.currentChat);
            conn.on('open', () => { this.activeConns[this.currentChat] = conn; conn.send({ type: 'msg', text }); });
            this.setupConn(conn);
        }
    },

    pushMsg(fId, sId, text) {
        if(!this.db[this.uid].friends[fId]) this.db[this.uid].friends[fId] = { history: [] };
        this.db[this.uid].friends[fId].history.push({ sender: sId, text, time: Date.now() });
        this.saveDb();
    },

    // --- CHAMADAS CORRIGIDAS ---
    async getStream(videoRequested) {
        try {
            return await navigator.mediaDevices.getUserMedia({ video: videoRequested, audio: true });
        } catch(e) {
            alert("Erro ao acessar mídia. Verifique o HTTPS e permissões.");
            return null;
        }
    },

    async call(isVideo) {
        const stream = await this.getStream(isVideo);
        if(!stream) return;
        this.callStream = stream;
        
        const localVid = document.getElementById('local-video');
        localVid.style.display = isVideo ? 'block' : 'none';
        if(isVideo) localVid.srcObject = stream;

        document.getElementById('call-ui').classList.add('active');
        const call = this.peer.call(this.currentChat, stream);
        this.handleMediaCall(call, isVideo);
    },

    async answerCall(isVideo) {
        const stream = await this.getStream(isVideo);
        if(!stream) return;
        this.callStream = stream;
        
        const localVid = document.getElementById('local-video');
        localVid.style.display = isVideo ? 'block' : 'none';
        if(isVideo) localVid.srcObject = stream;

        document.getElementById('call-ui').classList.add('active');
        this.incomingCall.answer(stream);
        this.handleMediaCall(this.incomingCall, isVideo);
    },

    handleMediaCall(call, isVideo) {
        this.incomingCall = call;
        call.on('stream', rs => {
            const rv = document.getElementById('remote-video');
            rv.srcObject = rs;
            rv.style.display = isVideo ? 'block' : 'none';
        });
        call.on('close', () => this.endCall());
    },

    endCall() {
        if(this.incomingCall) this.incomingCall.close();
        if(this.callStream) this.callStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-ui').classList.remove('active');
    },

    // UI
    renderHome() {
        const list = document.getElementById('chat-list'); list.innerHTML = '';
        Object.keys(this.db[this.uid].friends).forEach(id => {
            const div = document.createElement('div');
            div.style.padding = '15px 20px'; div.style.borderBottom = '1px solid #111'; div.innerText = id;
            div.onclick = () => this.openChat(id); list.appendChild(div);
        });
    },
    openChat(id) { this.currentChat = id; document.getElementById('chat-name').innerText = id; this.renderMessages(); this.openView('view-chat'); },
    renderMessages() {
        const area = document.getElementById('messages'); area.innerHTML = '';
        (this.db[this.uid].friends[this.currentChat].history || []).forEach(m => {
            const d = document.createElement('div'); d.className = `bubble ${m.sender === this.uid ? 'sent' : 'received'}`;
            d.innerText = m.text; area.appendChild(d);
        });
        area.scrollTop = area.scrollHeight;
    },
    saveDb() { localStorage.setItem('crimson_db', JSON.stringify(this.db)); },
    updateHeader() { const me = this.db[this.uid]; document.getElementById('header-name').innerText = me.name; },
    addContact() { const id = document.getElementById('target-id').value.trim(); if(id) { this.pushMsg(id, 'system', 'Conectado'); this.renderHome(); this.closeView('view-add'); } },
    openView(id) { document.getElementById(id).classList.add('active'); },
    closeView(id) { document.getElementById(id).classList.remove('active'); },
    closeChat() { this.currentChat = null; this.closeView('view-chat'); },
    logout() { localStorage.removeItem('crimson_session'); location.reload(); }
};

sys.init();
</script>
</body>
</html>
