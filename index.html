<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Crimson">
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/106/106195.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/106/106195.png">
    
    <title>CRIMSON | ENTERPRISE</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #ff0033;
            --primary-glow: rgba(255, 0, 51, 0.4);
            --bg: #000000;
            --surface: #0a0a0b;
            --card: #141417;
            --border: #27272a;
            --text: #ffffff;
            --text-dim: #a1a1aa;
            --bubble-sent: #ff0033;
            --bubble-rec: #1f1f22;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* APP CONTAINER */
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; background: var(--bg); border-left: 1px solid var(--border); border-right: 1px solid var(--border); }

        /* AUTH SCREEN */
        #auth-screen { position: absolute; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; transition: 0.5s; }
        .auth-content { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }
        
        /* HEADER */
        header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(10,10,11,0.95); border-bottom: 1px solid var(--border); z-index: 800; backdrop-filter: blur(10px); height: 70px; }
        .user-meta { display: flex; align-items: center; gap: 12px; cursor: pointer; }

        /* AVATARS */
        .avatar { width: 44px; height: 44px; border-radius: 14px; background: var(--card); border: 1.5px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); overflow: hidden; flex-shrink: 0; position: relative; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* VIEWS */
        .view { position: absolute; inset: 0; background: var(--bg); z-index: 900; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .view.active { transform: translateX(0); }

        /* CHAT */
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 30px; }
        .bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; display: flex; flex-direction: column; user-select: text; }
        .sent { align-self: flex-end; background: var(--bubble-sent); color: #fff; border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--bubble-rec); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        .msg-meta { font-size: 10px; margin-top: 4px; display: flex; align-items: center; gap: 4px; align-self: flex-end; opacity: 0.8; }
        .tick { font-size: 14px; }
        .tick.queued { color: #a1a1aa; } /* Relógio/Pendente */
        .tick.sent { color: #d1d1d6; } /* 1 Check */
        .tick.delivered { color: #4ade80; } /* 2 Checks */

        /* INPUTS */
        .input-bar { padding: 15px; display: flex; gap: 10px; background: var(--surface); border-top: 1px solid var(--border); align-items: center; }
        .field { flex: 1; background: var(--bg); border: 1.5px solid var(--border); border-radius: 12px; color: #fff; padding: 14px; font-size: 15px; outline: none; transition: 0.2s; height: 50px; }
        .field:focus { border-color: var(--primary); }
        .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        
        /* PROFILES */
        .profile-hero { display: flex; flex-direction: column; align-items: center; padding: 40px 20px; text-align: center; overflow-y: auto; }
        .big-av { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--card); outline: 2px solid var(--primary); margin-bottom: 20px; overflow: hidden; background: var(--card); display: flex; align-items: center; justify-content: center; }
        .big-av img { width: 100%; height: 100%; object-fit: cover; }
        .info-box { background: var(--card); padding: 20px; border-radius: 16px; width: 100%; margin-top: 20px; text-align: left; border: 1px solid var(--border); }
        
        /* FAB */
        .fab { position: absolute; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; box-shadow: 0 8px 20px var(--primary-glow); cursor: pointer; z-index: 500; transition: 0.3s; }
        .fab:hover { transform: scale(1.05); }

        /* SELEÇÃO DE GRUPO */
        .contact-select-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .contact-select-item.selected { background: rgba(255,0,51,0.1); }
        .checkbox-fake { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-dim); display: flex; align-items: center; justify-content: center; }
        .selected .checkbox-fake { background: var(--primary); border-color: var(--primary); }
        .selected .checkbox-fake::after { content: '✔'; font-size: 14px; color: white; }

        /* CALL UI */
        .call-ui { position: fixed; inset: 0; z-index: 99999; background: #0c0c0c; display: none; flex-direction: column; }
        .call-ui.active { display: flex; }
        
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 150px; position: absolute; bottom: 120px; right: 20px; border-radius: 12px; border: 2px solid var(--primary); object-fit: cover; background: #222; z-index: 10; transition: 0.3s; }

        /* CALL UI - VOICE MODE */
        .call-ui.voice-mode { background: #1a1a1a; justify-content: space-between; padding-top: 80px; padding-bottom: 40px; }
        .call-ui.voice-mode #remote-video, 
        .call-ui.voice-mode #local-video { display: none; }
        
        .voice-info { display: none; flex-direction: column; align-items: center; width: 100%; }
        .call-ui.voice-mode .voice-info { display: flex; animation: fadeIn 0.5s; }
        
        .voice-avatar-container { width: 160px; height: 160px; border-radius: 50%; overflow: hidden; border: 4px solid var(--border); margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; }
        .voice-avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        .voice-avatar-pulse { position: absolute; inset: 0; border-radius: 50%; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; border: 2px solid var(--primary); }

        .call-name { font-size: 28px; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .call-status { color: var(--text-dim); font-size: 16px; }

        .call-controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 40px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; justify-content: center; align-items: center; gap: 30px; border-radius: 30px 30px 0 0; }
        .ctrl-btn { width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.15); border: none; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: 0.2s; }
        .ctrl-btn:active { transform: scale(0.9); }
        .ctrl-btn.active { background: #fff; color: #000; }
        .end-call { width: 64px; height: 64px; background: #ff3b30; color: white; font-size: 28px; }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* FAB MENU */
        .fab-menu { position: absolute; bottom: 90px; right: 30px; display: flex; flex-direction: column; gap: 15px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 490; }
        .fab-menu.show { opacity: 1; pointer-events: all; bottom: 100px; }
        .fab-item { display: flex; align-items: center; gap: 10px; justify-content: flex-end; }
        .fab-btn-mini { width: 48px; height: 48px; border-radius: 14px; background: var(--card); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* ONLINE STATUS ANIMATION */
        .online-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-offline { color: var(--text-dim); }
        .status-online { color: #4ade80; font-weight: 700; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <div style="margin-bottom: 40px; text-align: center;">
            <i class="ri-shield-keyhole-fill" style="font-size: 64px; color: var(--primary);"></i>
            <h1 style="font-size: 28px; font-weight: 800;">CRIMSON</h1>
            <p style="color: var(--text-dim); font-size: 14px;">ENTERPRISE EDITION</p>
        </div>
        <div class="auth-content">
            <input type="text" id="auth-id" class="field" placeholder="Usuário (ID)" style="text-align:center;">
            <input type="password" id="auth-pass" class="field" placeholder="Senha" style="text-align:center;">
            <button class="btn" onclick="sys.auth(false)">ENTRAR</button>
            <button class="btn" onclick="sys.auth(true)" style="background: var(--card); border: 1px solid var(--border);">CRIAR CONTA</button>
        </div>
    </div>

    <header>
        <div class="user-meta" onclick="sys.openView('view-me')">
            <div class="avatar" id="header-av"></div>
            <div>
                <div id="header-name" style="font-weight: 700; font-size: 15px;">...</div>
                <div style="font-size: 11px; color: var(--primary); font-weight: 700;">ONLINE</div>
            </div>
        </div>
        <i class="ri-settings-4-line" style="font-size: 24px; color: var(--text-dim);" onclick="sys.openView('view-me')"></i>
    </header>

    <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
    
    <div class="fab-menu" id="fab-menu">
        <div class="fab-item" onclick="sys.openView('view-create-group'); sys.toggleFab();">
            <span style="font-size:13px; font-weight:600; background:rgba(0,0,0,0.8); padding:4px 8px; border-radius:6px;">Novo Grupo</span>
            <div class="fab-btn-mini"><i class="ri-group-line"></i></div>
        </div>
        <div class="fab-item" onclick="sys.openView('view-add'); sys.toggleFab();">
            <span style="font-size:13px; font-weight:600; background:rgba(0,0,0,0.8); padding:4px 8px; border-radius:6px;">Novo Contato</span>
            <div class="fab-btn-mini"><i class="ri-user-add-line"></i></div>
        </div>
    </div>
    <div class="fab" onclick="sys.toggleFab()"><i class="ri-add-line" id="fab-icon" style="transition:0.3s"></i></div>

    <div id="view-chat" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeChat()" style="font-size: 28px; padding-right: 10px; cursor: pointer;"></i>
            <div style="flex:1; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="sys.showContact()">
                <div class="avatar" id="chat-av" style="width:36px; height:36px;"></div>
                <div>
                    <div id="chat-name" style="font-weight: 700; font-size: 15px;">Nome</div>
                    <div id="chat-status-text" style="font-size: 11px; color: var(--text-dim);">...</div>
                </div>
            </div>
            <div style="display:flex; gap:15px; font-size: 22px; color: var(--primary);">
                <i class="ri-phone-fill" onclick="sys.call(false)"></i>
                <i class="ri-vidicon-fill" onclick="sys.call(true)"></i>
            </div>
        </header>
        <div id="messages" class="chat-area"></div>
        <div class="input-bar">
            <input type="text" id="msg-input" class="field" placeholder="Mensagem...">
            <button class="btn" style="width:50px; height:50px; padding:0; flex-shrink:0;" onclick="sys.send()"><i class="ri-send-plane-fill" style="font-size:20px;"></i></button>
        </div>
    </div>

    <div id="view-add" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-add')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Nova Conexão</h3>
        </header>
        <div style="padding: 30px;">
            <p style="color:var(--text-dim); margin-bottom:10px;">ID do Usuário</p>
            <input type="text" id="target-id" class="field" style="margin-bottom: 20px;">
            <button class="btn" style="width:100%;" onclick="sys.addContact()">CONECTAR</button>
        </div>
    </div>

    <div id="view-create-group" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-create-group')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Novo Grupo</h3>
        </header>
        <div style="padding: 20px; flex:1; display:flex; flex-direction:column;">
            <input type="text" id="group-name-input" class="field" placeholder="Nome do Grupo" style="margin-bottom:20px;">
            <h4 style="color:var(--text-dim); margin-bottom:10px; font-size:12px;">SELECIONAR MEMBROS</h4>
            <div id="group-contact-list" style="flex:1; overflow-y:auto; border:1px solid var(--border); border-radius:12px; margin-bottom:20px;"></div>
            <button class="btn" style="width:100%;" onclick="sys.createGroup()">CRIAR GRUPO</button>
        </div>
    </div>

    <div id="view-me" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-me')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Editar Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="me-large-av"></div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">NOME DE EXIBIÇÃO</label>
                <input type="text" id="edit-name" class="field" style="width:100%; margin-top:5px; background:var(--bg);">
            </div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">RECADO (BIO)</label>
                <input type="text" id="edit-bio" class="field" style="width:100%; margin-top:5px; background:var(--bg);">
            </div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">FOTO DE PERFIL (URL)</label>
                <input type="text" id="edit-pic" class="field" style="width:100%; margin-top:5px; background:var(--bg);" placeholder="https://...">
            </div>
            <button class="btn" style="width:100%; margin-top:30px;" onclick="sys.saveProfile()">SALVAR</button>
            <button class="btn" style="width:100%; margin-top:15px; background:transparent; border:1px solid #ff3b30; color:#ff3b30;" onclick="sys.logout()">SAIR DA CONTA</button>
        </div>
    </div>

    <div id="view-contact" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-contact')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="contact-large-av"></div>
            <h2 id="contact-real-name" style="margin-bottom:5px;">Nome</h2>
            <div id="contact-real-id" style="color:var(--primary); font-family:monospace; background:rgba(255,0,51,0.1); padding:4px 10px; border-radius:6px;">@id</div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px; font-weight:bold;">RECADO</label>
                <p id="contact-real-bio" style="margin-top:10px; line-height:1.5; color:#fff;">...</p>
            </div>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="voice-info">
            <div class="voice-avatar-container">
                <div class="voice-avatar-pulse"></div>
                <img id="voice-call-img" src="" alt="User">
            </div>
            <div class="call-name" id="voice-call-name">Usuário</div>
            <div class="call-status" id="voice-call-status">Chamada de Voz Crimsom</div>
        </div>
        <div class="call-controls">
            <button class="ctrl-btn" id="btn-mic" onclick="sys.toggleMic()"><i class="ri-mic-fill"></i></button>
            <button class="ctrl-btn" id="btn-speaker" onclick="sys.toggleSpeaker()"><i class="ri-volume-up-fill"></i></button>
            <button class="ctrl-btn end-call" onclick="sys.endCall()"><i class="ri-phone-fill" style="transform: rotate(135deg);"></i></button>
        </div>
    </div>
</div>

<script>
// PWA Manifest Injection
const manifest = {
  "name": "Crimson Enterprise",
  "short_name": "Crimson",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#000000",
  "orientation": "portrait",
  "icons": [
    { "src": "https://cdn-icons-png.flaticon.com/512/106/106195.png", "sizes": "192x192", "type": "image/png" },
    { "src": "https://cdn-icons-png.flaticon.com/512/106/106195.png", "sizes": "512x512", "type": "image/png" }
  ]
};
const link = document.createElement('link');
link.rel = 'manifest';
link.href = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
document.head.appendChild(link);

const sys = {
    peer: null,
    uid: null,
    db: {}, 
    activeConns: {}, 
    currentChat: null,
    callStream: null,
    incomingCall: null,
    isVoiceOnly: false,
    fabOpen: false,
    selectedGroupMembers: [],
    micEnabled: true,
    speakerEnabled: true,
    statusInterval: null,

    init() {
        const raw = localStorage.getItem('crimson_db');
        this.db = raw ? JSON.parse(raw) : {};
        const session = localStorage.getItem('crimson_session');
        if(session && this.db[session]) {
            this.uid = session;
            this.startApp();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
        document.getElementById('msg-input').onkeydown = (e) => {
            if(e.key === 'Enter') this.send();
        };
    },

    auth(isRegister) {
        const id = document.getElementById('auth-id').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value.trim();
        if(id.length < 3 || pass.length < 3) return alert("Mínimo 3 caracteres");

        if(isRegister) {
            if(this.db[id]) return alert("ID já existe");
            // Adicionado 'pending' para msgs offline
            this.db[id] = { pass, name: id, bio: "Crimson User", pic: "", friends: {}, groups: {}, pending: {} };
            this.saveDb();
            alert("Conta criada! Clique em Entrar.");
        } else {
            if(!this.db[id] || this.db[id].pass !== pass) return alert("Credenciais inválidas");
            this.uid = id;
            if(!this.db[id].pending) this.db[id].pending = {}; // Migração
            localStorage.setItem('crimson_session', id);
            this.startApp();
        }
    },

    startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        this.setupPeer();
        this.updateHeader();
        this.renderHome();
        // Loop para atualizar status "Visto há X minutos"
        this.statusInterval = setInterval(() => {
            if(this.currentChat && !this.currentChat.startsWith('group_')) {
                this.updateChatStatusUI(this.currentChat);
            }
        }, 60000);
    },

    logout() {
        localStorage.removeItem('crimson_session');
        location.reload();
    },

    saveDb() {
        localStorage.setItem('crimson_db', JSON.stringify(this.db));
    },

    setupPeer() {
        this.peer = new Peer(this.uid);
        
        this.peer.on('open', (id) => {
            console.log('Online:', id);
            this.checkAndFlushPending(); // Envia mensagens que ficaram na fila
        });

        this.peer.on('connection', (conn) => {
            this.setupConnectionEvents(conn);
        });

        this.peer.on('call', (call) => {
            if(confirm(`Chamada de ${call.peer}. Aceitar?`)) {
                this.incomingCall = call;
                this.answerCall();
            }
        });
        
        this.peer.on('error', err => {
            console.log("Peer Error:", err.type);
            // Se falhar ao conectar para enviar mensagem, já foi salvo como pendente no 'send'
        });
    },

    setupConnectionEvents(conn) {
        this.activeConns[conn.peer] = conn;
        
        conn.on('open', () => {
            // Se conectou, o usuário está online
            this.updateUserStatus(conn.peer, 'online');
            this.sendProfile(conn);
            this.flushPendingToPeer(conn.peer); // Se eu tenho msg pra ele, envio agora
        });

        conn.on('data', (data) => this.handleData(conn.peer, data));
        
        conn.on('close', () => {
            this.updateUserStatus(conn.peer, 'offline');
        });

        conn.on('error', () => {
             this.updateUserStatus(conn.peer, 'offline');
        });
    },

    // --- LÓGICA DE STATUS E OFFLINE ---
    updateUserStatus(id, status) {
        if(!this.db[this.uid].friends[id]) return;
        const friend = this.db[this.uid].friends[id];
        
        friend.status = status;
        if(status === 'offline') {
            friend.lastSeen = Date.now();
        }
        this.saveDb();
        
        if(this.currentChat === id) {
            this.updateChatStatusUI(id);
        }
    },

    updateChatStatusUI(id) {
        if(id.startsWith('group_')) return;
        const f = this.db[this.uid].friends[id];
        const statusEl = document.getElementById('chat-status-text');
        
        if(this.activeConns[id] && this.activeConns[id].open) {
             statusEl.innerHTML = '<span class="online-dot"></span>Online';
             statusEl.className = 'status-online';
        } else {
            const time = f.lastSeen ? new Date(f.lastSeen).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'Desconhecido';
            const date = f.lastSeen ? new Date(f.lastSeen).toLocaleDateString() : '';
            const today = new Date().toLocaleDateString();
            const displayDate = date === today ? 'hoje' : date;
            
            statusEl.innerText = `Visto ${displayDate} às ${time}`;
            statusEl.className = 'status-offline';
        }
    },

    // --- MENSAGENS ---
    handleData(senderId, data) {
        // Recibo (Tick Duplo)
        if(data.type === 'receipt') {
            this.markAsDelivered(senderId, data.msgId);
            return;
        }

        // Mensagem Texto
        if(data.type === 'msg') {
            const conn = this.activeConns[senderId];
            if(conn && conn.open) conn.send({ type: 'receipt', msgId: data.id }); // Confirma recebimento

            if(data.groupId) {
                this.handleGroupMessage(data);
                return;
            }

            this.pushMessage(senderId, senderId, data.text, 'received', data.id);
            if(this.currentChat === senderId) this.renderMessages();
            else this.renderHome();
        }

        // Sync Perfil
        if(data.type === 'sync') {
            if(!this.db[this.uid].friends[senderId]) {
                this.db[this.uid].friends[senderId] = { history: [] };
            }
            const f = this.db[this.uid].friends[senderId];
            f.name = data.name; f.bio = data.bio; f.pic = data.pic;
            this.saveDb();
            this.renderHome();
            if(this.currentChat === senderId) this.updateChatHeader(senderId);
        }
        
        // Voz
        if(data.type === 'call_type' && data.mode === 'voice') {
            this.isVoiceOnly = true;
            this.updateCallUI();
        }
    },

    send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        const target = this.currentChat;
        if(!text || !target) return;

        const msgId = Date.now() + Math.random().toString(36).substr(2, 9);
        input.value = '';

        if(target.startsWith('group_')) {
            const grp = this.db[this.uid].groups[target];
            grp.history.push({ sender: this.uid, text, time: Date.now(), status: 'sent', id: msgId });
            this.saveDb();
            this.renderMessages();

            grp.members.forEach(memberId => {
                if(memberId !== this.uid) {
                    this.sendMessageToPeer(memberId, {
                        type: 'msg', text, id: msgId, groupId: target, groupName: grp.name, senderId: this.uid
                    });
                }
            });
        } else {
            // Privado
            // Status inicial: 'queued' (pendente)
            this.pushMessage(target, this.uid, text, 'queued', msgId);
            this.renderMessages();
            
            // Tenta enviar
            this.sendMessageToPeer(target, { type: 'msg', text, id: msgId });
        }
        this.renderHome();
    },

    sendMessageToPeer(targetId, payload) {
        // Se conectado, envia direto
        if(this.activeConns[targetId] && this.activeConns[targetId].open) {
            this.activeConns[targetId].send(payload);
            // Atualiza status local para 'sent' (1 tick)
            if(!payload.groupId) this.markAsSent(targetId, payload.id);
        } else {
            // Se não conectado, salva na fila pendente
            this.queueMessage(targetId, payload);
            
            // Tenta conectar (se conseguir, o evento 'open' vai disparar flushPendingToPeer)
            const conn = this.peer.connect(targetId);
            this.setupConnectionEvents(conn);
        }
    },

    queueMessage(targetId, payload) {
        if(!this.db[this.uid].pending[targetId]) {
            this.db[this.uid].pending[targetId] = [];
        }
        this.db[this.uid].pending[targetId].push(payload);
        this.saveDb();
    },

    flushPendingToPeer(peerId) {
        const queue = this.db[this.uid].pending[peerId];
        if(queue && queue.length > 0) {
            const conn = this.activeConns[peerId];
            if(conn && conn.open) {
                // Envia todas
                queue.forEach(payload => {
                    conn.send(payload);
                    if(!payload.groupId) this.markAsSent(peerId, payload.id);
                });
                // Limpa fila
                delete this.db[this.uid].pending[peerId];
                this.saveDb();
                if(this.currentChat === peerId) this.renderMessages();
            }
        }
    },
    
    checkAndFlushPending() {
        // Varre todos pendentes e tenta reconectar
        Object.keys(this.db[this.uid].pending).forEach(targetId => {
            if(!this.activeConns[targetId] || !this.activeConns[targetId].open) {
                const conn = this.peer.connect(targetId);
                this.setupConnectionEvents(conn);
            }
        });
    },

    markAsSent(friendId, msgId) {
        const f = this.db[this.uid].friends[friendId];
        if(f) {
            const msg = f.history.find(m => m.id === msgId);
            if(msg) {
                msg.status = 'sent';
                this.saveDb();
                if(this.currentChat === friendId) this.renderMessages();
            }
        }
    },

    markAsDelivered(friendId, msgId) {
        const f = this.db[this.uid].friends[friendId];
        if(f) {
            const msg = f.history.find(m => m.id === msgId);
            if(msg) {
                msg.status = 'delivered';
                this.saveDb();
                if(this.currentChat === friendId) this.renderMessages();
            }
        }
    },

    pushMessage(friendId, senderId, text, status, id) {
        if(!this.db[this.uid].friends[friendId]) {
            this.db[this.uid].friends[friendId] = { history: [] };
        }
        this.db[this.uid].friends[friendId].history.push({
            sender: senderId, text, time: Date.now(), status, id
        });
        this.saveDb();
    },

    handleGroupMessage(data) {
        let groups = this.db[this.uid].groups || {};
        if(!groups[data.groupId]) {
            groups[data.groupId] = { name: data.groupName, members: data.members || [], history: [] };
        }
        groups[data.groupId].history.push({
            sender: data.senderId, text: data.text, time: Date.now(), status: 'read', id: data.id
        });
        this.db[this.uid].groups = groups;
        this.saveDb();
        if(this.currentChat === data.groupId) this.renderMessages();
        else this.renderHome();
    },

    // --- UI HELPERS ---
    sendProfile(conn) {
        const me = this.db[this.uid];
        conn.send({ type: 'sync', name: me.name, bio: me.bio, pic: me.pic });
    },

    renderMessages() {
        const area = document.getElementById('messages');
        area.innerHTML = '';
        let msgs = [];
        if(this.currentChat.startsWith('group_')) {
            msgs = this.db[this.uid].groups[this.currentChat].history || [];
        } else {
            msgs = this.db[this.uid].friends[this.currentChat].history || [];
        }
        
        msgs.forEach(m => {
            const isMe = m.sender === this.uid;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'sent' : 'received'}`;
            
            let ticks = '';
            if(isMe && !this.currentChat.startsWith('group_')) {
                let icon = '<i class="ri-time-line"></i>'; // Default queued
                let cls = 'tick queued';
                
                if(m.status === 'sent') { icon = '<i class="ri-check-line"></i>'; cls = 'tick sent'; }
                if(m.status === 'delivered') { icon = '<i class="ri-check-double-line"></i>'; cls = 'tick delivered'; }
                
                ticks = `<span class="${cls}">${icon}</span>`;
            }

            let senderName = '';
            if(!isMe && this.currentChat.startsWith('group_')) {
                 const f = this.db[this.uid].friends[m.sender];
                 senderName = `<div style="font-size:10px; color:var(--primary); font-weight:bold; margin-bottom:2px;">${f ? f.name : m.sender}</div>`;
            }

            div.innerHTML = `${senderName}${m.text}<div class="msg-meta"><span>${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>${ticks}</div>`;
            area.appendChild(div);
        });
        area.scrollTop = area.scrollHeight;
    },

    renderHome() {
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        const friends = this.db[this.uid].friends || {};
        const groups = this.db[this.uid].groups || {};
        let allChats = [];

        Object.keys(friends).forEach(id => {
            const f = friends[id];
            const last = f.history.length ? f.history[f.history.length-1] : null;
            allChats.push({ id, name: f.name || id, pic: f.pic, lastMsg: last ? last.text : 'Nova conexão', time: last ? last.time : 0, type: 'user' });
        });

        Object.keys(groups).forEach(id => {
            const g = groups[id];
            const last = g.history.length ? g.history[g.history.length-1] : null;
            allChats.push({ id, name: g.name, pic: null, lastMsg: last ? `${last.sender}: ${last.text}` : 'Grupo criado', time: last ? last.time : 0, type: 'group' });
        });

        allChats.sort((a,b) => b.time - a.time);

        allChats.forEach(c => {
            const htmlAv = c.pic ? `<img src="${c.pic}">` : (c.type === 'group' ? '<i class="ri-group-fill"></i>' : c.name[0].toUpperCase());
            const div = document.createElement('div');
            div.style.cssText = "display:flex; align-items:center; gap:15px; padding:16px 20px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;";
            div.innerHTML = `
                <div class="avatar">${htmlAv}</div>
                <div style="flex:1; overflow:hidden;">
                    <div style="font-weight:600; font-size:15px; margin-bottom:2px;">${c.name}</div>
                    <div style="color:var(--text-dim); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.lastMsg}</div>
                </div>
            `;
            div.onclick = () => this.openChat(c.id);
            list.appendChild(div);
        });
    },

    // --- OTHER FUNCS ---
    openChat(id) {
        this.currentChat = id;
        this.updateChatHeader(id);
        this.renderMessages();
        this.openView('view-chat');
        if(!id.startsWith('group_')) {
            // Tenta reconectar e atualizar status UI
            if(!this.activeConns[id] || !this.activeConns[id].open) {
                const conn = this.peer.connect(id);
                this.setupConnectionEvents(conn);
            } else {
                this.updateChatStatusUI(id);
            }
        }
    },

    updateChatHeader(id) {
        let name, pic;
        if(id.startsWith('group_')) {
            const g = this.db[this.uid].groups[id];
            name = g.name; pic = null;
            document.getElementById('chat-status-text').innerText = `${g.members.length} membros`;
            document.getElementById('chat-status-text').className = 'status-offline';
        } else {
            const f = this.db[this.uid].friends[id];
            name = f.name || id; pic = f.pic;
            this.updateChatStatusUI(id);
        }
        document.getElementById('chat-name').innerText = name;
        document.getElementById('chat-av').innerHTML = pic ? `<img src="${pic}">` : (id.startsWith('group_') ? '<i class="ri-group-fill"></i>' : name[0].toUpperCase());
    },

    closeChat() {
        this.currentChat = null;
        this.closeView('view-chat');
        this.renderHome();
    },

    addContact() {
        const id = document.getElementById('target-id').value.trim().toLowerCase();
        if(id === this.uid) return alert("Erro: Auto-adição.");
        if(id) {
            if(!this.db[this.uid].friends[id]) {
                this.db[this.uid].friends[id] = { name: id, history: [], bio: '', pic: '', lastSeen: 0 };
                this.saveDb();
            }
            this.closeView('view-add');
            this.openChat(id);
        }
    },

    // --- GRUPOS ---
    renderCreateGroup() {
        const list = document.getElementById('group-contact-list');
        list.innerHTML = '';
        this.selectedGroupMembers = [];
        Object.keys(this.db[this.uid].friends).forEach(id => {
            const f = this.db[this.uid].friends[id];
            const div = document.createElement('div');
            div.className = 'contact-select-item';
            div.onclick = () => {
                div.classList.toggle('selected');
                if(this.selectedGroupMembers.includes(id)) this.selectedGroupMembers = this.selectedGroupMembers.filter(m => m !== id);
                else this.selectedGroupMembers.push(id);
            };
            div.innerHTML = `<div class="checkbox-fake"></div><div style="font-weight:600;">${f.name || id}</div>`;
            list.appendChild(div);
        });
    },

    createGroup() {
        const name = document.getElementById('group-name-input').value.trim();
        if(name.length < 1 || this.selectedGroupMembers.length < 1) return alert("Preencha o nome e selecione membros");
        const gid = 'group_' + Date.now();
        const members = [this.uid, ...this.selectedGroupMembers];
        
        if(!this.db[this.uid].groups) this.db[this.uid].groups = {};
        this.db[this.uid].groups[gid] = { name, members, history: [] };
        this.saveDb();
        this.closeView('view-create-group');
        this.openChat(gid);
    },

    // --- PERFIL ---
    saveProfile() {
        const me = this.db[this.uid];
        me.name = document.getElementById('edit-name').value;
        me.bio = document.getElementById('edit-bio').value;
        me.pic = document.getElementById('edit-pic').value;
        this.saveDb();
        this.updateHeader();
        this.closeView('view-me');
        Object.values(this.activeConns).forEach(conn => { if(conn.open) this.sendProfile(conn); });
    },

    updateHeader() {
        const me = this.db[this.uid];
        document.getElementById('header-name').innerText = me.name || this.uid;
        document.getElementById('edit-name').value = me.name || "";
        document.getElementById('edit-bio').value = me.bio || "";
        document.getElementById('edit-pic').value = me.pic || "";
        const html = me.pic ? `<img src="${me.pic}">` : this.uid[0].toUpperCase();
        document.getElementById('header-av').innerHTML = html;
        document.getElementById('me-large-av').innerHTML = html.replace('width:100%', 'width:100%');
    },

    showContact() {
        if(!this.currentChat || this.currentChat.startsWith('group_')) return;
        const f = this.db[this.uid].friends[this.currentChat];
        document.getElementById('contact-real-name').innerText = f.name || this.currentChat;
        document.getElementById('contact-real-id').innerText = '@' + this.currentChat;
        document.getElementById('contact-real-bio').innerText = f.bio || "Sem recado.";
        const html = f.pic ? `<img src="${f.pic}">` : `<span style="font-size:40px; color:var(--primary); font-weight:bold;">${this.currentChat[0].toUpperCase()}</span>`;
        document.getElementById('contact-large-av').innerHTML = html;
        this.openView('view-contact');
    },

    // --- CHAMADAS ---
    async call(isVideo) {
        if(this.currentChat.startsWith('group_')) return alert("Sem chamadas em grupo.");
        this.isVoiceOnly = !isVideo;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
            this.callStream = stream;
            this.updateCallUI();
            if(this.isVoiceOnly && this.activeConns[this.currentChat]) {
                this.activeConns[this.currentChat].send({ type: 'call_type', mode: 'voice' });
            }
            const call = this.peer.call(this.currentChat, stream);
            this.handleMediaCall(call);
        } catch(e) { alert("Erro mídia/HTTPS."); }
    },

    async answerCall() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: !this.isVoiceOnly, audio: true });
            this.callStream = stream;
            this.updateCallUI();
            this.incomingCall.answer(stream);
            this.handleMediaCall(this.incomingCall);
        } catch(e) { alert("Erro ao atender."); }
    },

    handleMediaCall(call) {
        this.incomingCall = call;
        call.on('stream', remoteStream => {
            document.getElementById('remote-video').srcObject = remoteStream;
            document.getElementById('remote-video').play();
        });
        call.on('close', () => this.endCall(true));
    },

    updateCallUI() {
        const ui = document.getElementById('call-ui');
        ui.classList.add('active');
        document.getElementById('btn-mic').className = 'ctrl-btn active';
        document.getElementById('btn-speaker').className = 'ctrl-btn active';
        this.micEnabled = true;

        if(this.isVoiceOnly) {
            ui.classList.add('voice-mode');
            const f = this.db[this.uid].friends[this.currentChat] || { name: this.incomingCall?.peer || '...', pic: '' };
            document.getElementById('voice-call-name').innerText = f.name || f.peer;
            document.getElementById('voice-call-img').src = f.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        } else {
            ui.classList.remove('voice-mode');
            document.getElementById('local-video').srcObject = this.callStream;
        }
    },

    toggleMic() {
        if(!this.callStream) return;
        const track = this.callStream.getAudioTracks()[0];
        this.micEnabled = !this.micEnabled;
        track.enabled = this.micEnabled;
        const btn = document.getElementById('btn-mic');
        btn.innerHTML = this.micEnabled ? '<i class="ri-mic-fill"></i>' : '<i class="ri-mic-off-fill"></i>';
        btn.classList.toggle('active');
    },

    toggleSpeaker() {
        const vid = document.getElementById('remote-video');
        this.speakerEnabled = !this.speakerEnabled;
        vid.muted = !this.speakerEnabled;
        const btn = document.getElementById('btn-speaker');
        btn.innerHTML = this.speakerEnabled ? '<i class="ri-volume-up-fill"></i>' : '<i class="ri-volume-mute-fill"></i>';
        btn.classList.toggle('active');
    },

    endCall(remoteClosed) {
        if(this.incomingCall) this.incomingCall.close();
        if(this.callStream) this.callStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-ui').classList.remove('active', 'voice-mode');
        this.incomingCall = null;
        this.callStream = null;
        this.isVoiceOnly = false;
    },

    // UTILS
    toggleFab() {
        this.fabOpen = !this.fabOpen;
        document.getElementById('fab-menu').classList.toggle('show');
        const icon = document.getElementById('fab-icon');
        icon.classList.toggle('ri-add-line');
        icon.classList.toggle('ri-close-line');
        icon.style.transform = this.fabOpen ? "rotate(90deg)" : "rotate(0deg)";
    },
    openView(id) { 
        if(id === 'view-create-group') this.renderCreateGroup();
        document.getElementById(id).classList.add('active'); 
    },
    closeView(id) { document.getElementById(id).classList.remove('active'); }
};

sys.init();
</script>
</body>
            </html>
