<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Crimson">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/106/106195.png"> <title>CRIMSON | ENTERPRISE</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #ff0033;
            --primary-glow: rgba(255, 0, 51, 0.4);
            --bg: #000000;
            --surface: #0a0a0b;
            --card: #141417;
            --border: #27272a;
            --text: #ffffff;
            --text-dim: #a1a1aa;
            --bubble-sent: #ff0033;
            --bubble-rec: #1f1f22;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* APP CONTAINER */
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; background: var(--bg); border-left: 1px solid var(--border); border-right: 1px solid var(--border); }

        /* AUTH SCREEN */
        #auth-screen { position: absolute; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; transition: 0.5s; }
        .auth-content { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }
        
        /* HEADER */
        header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(10,10,11,0.95); border-bottom: 1px solid var(--border); z-index: 800; backdrop-filter: blur(10px); height: 70px; }
        .user-meta { display: flex; align-items: center; gap: 12px; cursor: pointer; }

        /* AVATARS */
        .avatar { width: 44px; height: 44px; border-radius: 14px; background: var(--card); border: 1.5px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); overflow: hidden; flex-shrink: 0; position: relative; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* VIEWS */
        .view { position: absolute; inset: 0; background: var(--bg); z-index: 900; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .view.active { transform: translateX(0); }

        /* CHAT */
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 30px; }
        .bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; display: flex; flex-direction: column; }
        .sent { align-self: flex-end; background: var(--bubble-sent); color: #fff; border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--bubble-rec); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        .msg-meta { font-size: 10px; margin-top: 4px; display: flex; align-items: center; gap: 4px; align-self: flex-end; opacity: 0.8; }
        .tick { font-size: 14px; }
        .tick.read { color: #4ade80; } /* Verde quando lido/entregue (simulação) */

        /* INPUTS */
        .input-bar { padding: 15px; display: flex; gap: 10px; background: var(--surface); border-top: 1px solid var(--border); align-items: center; }
        .field { flex: 1; background: var(--bg); border: 1.5px solid var(--border); border-radius: 12px; color: #fff; padding: 14px; font-size: 15px; outline: none; transition: 0.2s; height: 50px; }
        .field:focus { border-color: var(--primary); }
        .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        
        /* PROFILES */
        .profile-hero { display: flex; flex-direction: column; align-items: center; padding: 40px 20px; text-align: center; overflow-y: auto; }
        .big-av { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--card); outline: 2px solid var(--primary); margin-bottom: 20px; overflow: hidden; background: var(--card); display: flex; align-items: center; justify-content: center; }
        .big-av img { width: 100%; height: 100%; object-fit: cover; }
        .info-box { background: var(--card); padding: 20px; border-radius: 16px; width: 100%; margin-top: 20px; text-align: left; border: 1px solid var(--border); }
        
        /* FAB */
        .fab { position: absolute; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; box-shadow: 0 8px 20px var(--primary-glow); cursor: pointer; z-index: 500; transition: 0.3s; }
        .fab:hover { transform: scale(1.05); }

        /* SELEÇÃO DE GRUPO */
        .contact-select-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .contact-select-item.selected { background: rgba(255,0,51,0.1); }
        .checkbox-fake { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-dim); display: flex; align-items: center; justify-content: center; }
        .selected .checkbox-fake { background: var(--primary); border-color: var(--primary); }
        .selected .checkbox-fake::after { content: '✔'; font-size: 14px; color: white; }

        /* CALL UI - GERAL */
        .call-ui { position: fixed; inset: 0; z-index: 99999; background: #0c0c0c; display: none; flex-direction: column; }
        .call-ui.active { display: flex; }
        
        /* ELEMENTOS DE VÍDEO */
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 150px; position: absolute; bottom: 120px; right: 20px; border-radius: 12px; border: 2px solid var(--primary); object-fit: cover; background: #222; z-index: 10; transition: 0.3s; }

        /* CALL UI - VOICE MODE (WHATSAPP STYLE) */
        .call-ui.voice-mode { background: #1a1a1a; justify-content: space-between; padding-top: 80px; padding-bottom: 40px; }
        .call-ui.voice-mode #remote-video, 
        .call-ui.voice-mode #local-video { display: none; } /* Esconde câmeras */
        
        .voice-info { display: none; flex-direction: column; align-items: center; width: 100%; }
        .call-ui.voice-mode .voice-info { display: flex; animation: fadeIn 0.5s; }
        
        .voice-avatar-container { width: 160px; height: 160px; border-radius: 50%; overflow: hidden; border: 4px solid var(--border); margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; }
        .voice-avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        .voice-avatar-pulse { position: absolute; inset: 0; border-radius: 50%; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; border: 2px solid var(--primary); }

        .call-name { font-size: 28px; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .call-status { color: var(--text-dim); font-size: 16px; }

        /* CONTROLES DA CHAMADA */
        .call-controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 40px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; justify-content: center; align-items: center; gap: 30px; border-radius: 30px 30px 0 0; }
        .ctrl-btn { width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.15); border: none; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: 0.2s; }
        .ctrl-btn:active { transform: scale(0.9); }
        .ctrl-btn.active { background: #fff; color: #000; }
        .end-call { width: 64px; height: 64px; background: #ff3b30; color: white; font-size: 28px; }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* TABS GRUPO/CHAT */
        .fab-menu { position: absolute; bottom: 90px; right: 30px; display: flex; flex-direction: column; gap: 15px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 490; }
        .fab-menu.show { opacity: 1; pointer-events: all; bottom: 100px; }
        .fab-item { display: flex; align-items: center; gap: 10px; justify-content: flex-end; }
        .fab-btn-mini { width: 48px; height: 48px; border-radius: 14px; background: var(--card); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <div style="margin-bottom: 40px; text-align: center;">
            <i class="ri-shield-keyhole-fill" style="font-size: 64px; color: var(--primary);"></i>
            <h1 style="font-size: 28px; font-weight: 800;">CRIMSON</h1>
            <p style="color: var(--text-dim); font-size: 14px;">ENTERPRISE EDITION</p>
        </div>
        <div class="auth-content">
            <input type="text" id="auth-id" class="field" placeholder="Usuário (ID)" style="text-align:center;">
            <input type="password" id="auth-pass" class="field" placeholder="Senha" style="text-align:center;">
            <button class="btn" onclick="sys.auth(false)">ENTRAR</button>
            <button class="btn" onclick="sys.auth(true)" style="background: var(--card); border: 1px solid var(--border);">CRIAR CONTA</button>
        </div>
    </div>

    <header>
        <div class="user-meta" onclick="sys.openView('view-me')">
            <div class="avatar" id="header-av"></div>
            <div>
                <div id="header-name" style="font-weight: 700; font-size: 15px;">...</div>
                <div style="font-size: 11px; color: var(--primary); font-weight: 700;">ONLINE</div>
            </div>
        </div>
        <i class="ri-settings-4-line" style="font-size: 24px; color: var(--text-dim);" onclick="sys.openView('view-me')"></i>
    </header>

    <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
    
    <div class="fab-menu" id="fab-menu">
        <div class="fab-item" onclick="sys.openView('view-create-group'); sys.toggleFab();">
            <span style="font-size:13px; font-weight:600; background:rgba(0,0,0,0.8); padding:4px 8px; border-radius:6px;">Novo Grupo</span>
            <div class="fab-btn-mini"><i class="ri-group-line"></i></div>
        </div>
        <div class="fab-item" onclick="sys.openView('view-add'); sys.toggleFab();">
            <span style="font-size:13px; font-weight:600; background:rgba(0,0,0,0.8); padding:4px 8px; border-radius:6px;">Novo Contato</span>
            <div class="fab-btn-mini"><i class="ri-user-add-line"></i></div>
        </div>
    </div>
    <div class="fab" onclick="sys.toggleFab()"><i class="ri-add-line" id="fab-icon" style="transition:0.3s"></i></div>

    <div id="view-chat" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeChat()" style="font-size: 28px; padding-right: 10px; cursor: pointer;"></i>
            <div style="flex:1; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="sys.showContact()">
                <div class="avatar" id="chat-av" style="width:36px; height:36px;"></div>
                <div>
                    <div id="chat-name" style="font-weight: 700; font-size: 15px;">Nome</div>
                    <div id="chat-status-text" style="font-size: 11px; color: var(--text-dim);">Toque para ver perfil</div>
                </div>
            </div>
            <div style="display:flex; gap:15px; font-size: 22px; color: var(--primary);">
                <i class="ri-phone-fill" onclick="sys.call(false)"></i> <i class="ri-vidicon-fill" onclick="sys.call(true)"></i> </div>
        </header>
        <div id="messages" class="chat-area"></div>
        <div class="input-bar">
            <input type="text" id="msg-input" class="field" placeholder="Mensagem...">
            <button class="btn" style="width:50px; height:50px; padding:0; flex-shrink:0;" onclick="sys.send()"><i class="ri-send-plane-fill" style="font-size:20px;"></i></button>
        </div>
    </div>

    <div id="view-add" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-add')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Nova Conexão</h3>
        </header>
        <div style="padding: 30px;">
            <p style="color:var(--text-dim); margin-bottom:10px;">ID do Usuário</p>
            <input type="text" id="target-id" class="field" style="margin-bottom: 20px;">
            <button class="btn" style="width:100%;" onclick="sys.addContact()">CONECTAR</button>
        </div>
    </div>

    <div id="view-create-group" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-create-group')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Novo Grupo</h3>
        </header>
        <div style="padding: 20px; flex:1; display:flex; flex-direction:column;">
            <input type="text" id="group-name-input" class="field" placeholder="Nome do Grupo" style="margin-bottom:20px;">
            <h4 style="color:var(--text-dim); margin-bottom:10px; font-size:12px;">SELECIONAR MEMBROS</h4>
            <div id="group-contact-list" style="flex:1; overflow-y:auto; border:1px solid var(--border); border-radius:12px; margin-bottom:20px;"></div>
            <button class="btn" style="width:100%;" onclick="sys.createGroup()">CRIAR GRUPO</button>
        </div>
    </div>

    <div id="view-me" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-me')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Editar Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="me-large-av"></div>
            
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">NOME DE EXIBIÇÃO</label>
                <input type="text" id="edit-name" class="field" style="width:100%; margin-top:5px; background:var(--bg);">
            </div>

            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">RECADO (BIO)</label>
                <input type="text" id="edit-bio" class="field" style="width:100%; margin-top:5px; background:var(--bg);">
            </div>

            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">FOTO DE PERFIL (URL)</label>
                <input type="text" id="edit-pic" class="field" style="width:100%; margin-top:5px; background:var(--bg);" placeholder="https://...">
            </div>

            <button class="btn" style="width:100%; margin-top:30px;" onclick="sys.saveProfile()">SALVAR</button>
            <button class="btn" style="width:100%; margin-top:15px; background:transparent; border:1px solid #ff3b30; color:#ff3b30;" onclick="sys.logout()">SAIR DA CONTA</button>
        </div>
    </div>

    <div id="view-contact" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-contact')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="contact-large-av"></div>
            <h2 id="contact-real-name" style="margin-bottom:5px;">Nome</h2>
            <div id="contact-real-id" style="color:var(--primary); font-family:monospace; background:rgba(255,0,51,0.1); padding:4px 10px; border-radius:6px;">@id</div>
            
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px; font-weight:bold;">RECADO</label>
                <p id="contact-real-bio" style="margin-top:10px; line-height:1.5; color:#fff;">...</p>
            </div>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        
        <div class="voice-info">
            <div class="voice-avatar-container">
                <div class="voice-avatar-pulse"></div>
                <img id="voice-call-img" src="" alt="User">
            </div>
            <div class="call-name" id="voice-call-name">Usuário</div>
            <div class="call-status" id="voice-call-status">Chamada de Voz Crimsom</div>
        </div>

        <div class="call-controls">
            <button class="ctrl-btn" id="btn-mic" onclick="sys.toggleMic()"><i class="ri-mic-fill"></i></button>
            <button class="ctrl-btn" id="btn-speaker" onclick="sys.toggleSpeaker()"><i class="ri-volume-up-fill"></i></button>
            <button class="ctrl-btn end-call" onclick="sys.endCall()"><i class="ri-phone-fill" style="transform: rotate(135deg);"></i></button>
        </div>
    </div>
</div>

<script>
// --- PWA MANIFEST DYNAMIC INJECTION ---
const manifest = {
  "name": "Crimson Enterprise",
  "short_name": "Crimson",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#000000",
  "icons": [
    { "src": "https://cdn-icons-png.flaticon.com/512/106/106195.png", "sizes": "192x192", "type": "image/png" },
    { "src": "https://cdn-icons-png.flaticon.com/512/106/106195.png", "sizes": "512x512", "type": "image/png" }
  ]
};
const content = encodeURIComponent(JSON.stringify(manifest));
const link = document.createElement('link');
link.rel = 'manifest';
link.href = 'data:application/manifest+json,' + content;
document.head.appendChild(link);

// Register Fake SW for install prompt eligibility
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => console.log('SW not needed for demo'));
}

const sys = {
    // Estado Global
    peer: null,
    uid: null,
    db: {}, 
    activeConns: {}, 
    currentChat: null,
    callStream: null,
    incomingCall: null,
    isVoiceOnly: false,
    fabOpen: false,
    selectedGroupMembers: [],
    
    // Configurações de chamada
    micEnabled: true,
    speakerEnabled: true,

    init() {
        const raw = localStorage.getItem('crimson_db');
        this.db = raw ? JSON.parse(raw) : {};
        
        const session = localStorage.getItem('crimson_session');
        if(session && this.db[session]) {
            this.uid = session;
            this.startApp();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }

        document.getElementById('msg-input').onkeydown = (e) => {
            if(e.key === 'Enter') this.send();
        };
    },

    // --- AUTENTICAÇÃO ---
    auth(isRegister) {
        const id = document.getElementById('auth-id').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value.trim();

        if(id.length < 3 || pass.length < 3) return alert("Mínimo 3 caracteres");

        if(isRegister) {
            if(this.db[id]) return alert("ID já existe");
            this.db[id] = { pass, name: id, bio: "Olá, estou usando Crimson.", pic: "", friends: {}, groups: {} };
            this.saveDb();
            alert("Conta criada! Clique em Entrar.");
        } else {
            if(!this.db[id] || this.db[id].pass !== pass) return alert("Credenciais inválidas");
            this.uid = id;
            localStorage.setItem('crimson_session', id);
            this.startApp();
        }
    },

    startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        this.setupPeer();
        this.updateHeader();
        this.renderHome();
    },

    logout() {
        localStorage.removeItem('crimson_session');
        location.reload();
    },

    saveDb() {
        localStorage.setItem('crimson_db', JSON.stringify(this.db));
    },

    // --- REDE (PEERJS) ---
    setupPeer() {
        this.peer = new Peer(this.uid);
        
        this.peer.on('open', (id) => {
            console.log('Online:', id);
            this.flushPendingMessages(); // Tenta enviar mensagens offline
        });

        this.peer.on('connection', (conn) => {
            this.activeConns[conn.peer] = conn;
            conn.on('data', (data) => this.handleData(conn.peer, data));
            conn.on('open', () => {
                this.sendProfile(conn);
                this.flushPendingMessages(conn.peer);
            });
        });

        this.peer.on('call', (call) => {
            // Detecta tipo de chamada pelo metadata (simplificado: pergunta ao usuário)
            // Para UI perfeita, assumimos video por padrão mas verificaremos metadata se implementado
            // Como peerjs vanilla nao passa metadata facil no call, usaremos um truque:
            // O chamador enviou uma conexao de dados antes.
            
            if(confirm(`Recebendo chamada de ${call.peer}. Aceitar?`)) {
                this.incomingCall = call;
                // Por padrão aceita com vídeo, mas UI ajusta se for voz
                // O ideal seria um handshake antes, mas aqui simplificamos:
                this.answerCall();
            }
        });
        
        this.peer.on('error', err => console.log(err));
    },

    // --- MENSAGENS E DADOS ---
    sendProfile(conn) {
        const me = this.db[this.uid];
        conn.send({ type: 'sync', name: me.name, bio: me.bio, pic: me.pic });
    },

    handleData(senderId, data) {
        // 1. Recibo de Entrega (Tick Duplo)
        if(data.type === 'receipt') {
            this.markAsDelivered(senderId, data.msgId);
            return;
        }

        // 2. Mensagem de Texto
        if(data.type === 'msg') {
            // Mandar recibo de volta
            const conn = this.activeConns[senderId];
            if(conn && conn.open) conn.send({ type: 'receipt', msgId: data.id });

            // Tratar Grupo
            if(data.groupId) {
                this.handleGroupMessage(data);
                return;
            }

            this.pushMessage(senderId, senderId, data.text, 'received', data.id);
            if(this.currentChat === senderId) this.renderMessages();
            else this.renderHome();
        }

        // 3. Sync
        if(data.type === 'sync') {
            if(!this.db[this.uid].friends[senderId]) {
                this.db[this.uid].friends[senderId] = { history: [] };
            }
            const f = this.db[this.uid].friends[senderId];
            f.name = data.name; f.bio = data.bio; f.pic = data.pic;
            this.saveDb();
            this.renderHome();
            if(this.currentChat === senderId) this.updateChatHeader(senderId);
        }

        // 4. Sinalização de Chamada de Voz
        if(data.type === 'call_type' && data.mode === 'voice') {
            this.isVoiceOnly = true;
            this.updateCallUI();
        }
    },

    handleGroupMessage(data) {
        // Verifica se grupo existe, senão cria
        let groups = this.db[this.uid].groups || {};
        if(!groups[data.groupId]) {
            groups[data.groupId] = {
                name: data.groupName,
                members: data.members,
                history: []
            };
        }
        
        // Adiciona msg
        groups[data.groupId].history.push({
            sender: data.senderId, // Quem mandou de verdade
            text: data.text,
            time: Date.now(),
            status: 'read', // Recebida é lida/entregue
            id: data.id
        });
        
        this.db[this.uid].groups = groups;
        this.saveDb();
        
        if(this.currentChat === data.groupId) this.renderMessages();
        else this.renderHome();
    },

    send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        const target = this.currentChat;
        if(!text || !target) return;

        const msgId = Date.now() + Math.random().toString(36).substr(2, 9);
        input.value = '';

        // LÓGICA DE GRUPO
        if(target.startsWith('group_')) {
            const grp = this.db[this.uid].groups[target];
            // Salvar local
            grp.history.push({ sender: this.uid, text, time: Date.now(), status: 'sent', id: msgId });
            this.saveDb();
            this.renderMessages();

            // Enviar para todos os membros (Broadcast)
            grp.members.forEach(memberId => {
                if(memberId === this.uid) return;
                this.sendMessageToPeer(memberId, {
                    type: 'msg', text, id: msgId,
                    groupId: target, groupName: grp.name, members: grp.members, senderId: this.uid
                });
            });
        } else {
            // CHAT PRIVADO
            this.pushMessage(target, this.uid, text, 'sent', msgId);
            this.renderMessages();
            this.sendMessageToPeer(target, { type: 'msg', text, id: msgId });
        }
        
        this.renderHome();
    },

    sendMessageToPeer(targetId, payload) {
        // Função auxiliar que tenta enviar ou põe na fila se offline
        // Para simplificar "ticks" offline, vamos considerar 'sent' como 1 tick.
        // Se conectar e enviar, o receptor devolve 'receipt' -> 2 ticks.
        
        const send = (conn) => {
            conn.send(payload);
            conn.send({ type: 'sync', name: this.db[this.uid].name, bio: this.db[this.uid].bio, pic: this.db[this.uid].pic });
        };

        if(this.activeConns[targetId] && this.activeConns[targetId].open) {
            send(this.activeConns[targetId]);
        } else {
            // Tenta conectar
            const conn = this.peer.connect(targetId);
            conn.on('open', () => {
                this.activeConns[targetId] = conn;
                conn.on('data', d => this.handleData(targetId, d));
                send(conn);
            });
            // Se falhar, fica como 'sent' (1 tick) e será reenviado no futuro se implementarmos fila persistente complexa.
            // Para este código, a tentativa de conexão é imediata.
        }
    },

    pushMessage(friendId, senderId, text, status, id) {
        if(!this.db[this.uid].friends[friendId]) {
            this.db[this.uid].friends[friendId] = { history: [] };
        }
        this.db[this.uid].friends[friendId].history.push({
            sender: senderId,
            text: text,
            time: Date.now(),
            status: status,
            id: id
        });
        this.saveDb();
    },

    markAsDelivered(friendId, msgId) {
        // Busca em privado
        const f = this.db[this.uid].friends[friendId];
        if(f) {
            const msg = f.history.find(m => m.id === msgId);
            if(msg) {
                msg.status = 'delivered';
                this.saveDb();
                if(this.currentChat === friendId) this.renderMessages();
            }
        }
        // Nota: Ticks em grupo são complexos (n receipts), simplificado para privado aqui.
    },

    flushPendingMessages(specificId) {
        // Funcionalidade avançada: reenvia mensagens com status 'sent' quando reconecta
        // Simplificado aqui para não estourar complexidade
    },

    // --- INTERFACE (UI) ---
    toggleFab() {
        this.fabOpen = !this.fabOpen;
        const menu = document.getElementById('fab-menu');
        const icon = document.getElementById('fab-icon');
        if(this.fabOpen) {
            menu.classList.add('show');
            icon.classList.replace('ri-add-line', 'ri-close-line');
            icon.style.transform = "rotate(90deg)";
        } else {
            menu.classList.remove('show');
            icon.classList.replace('ri-close-line', 'ri-add-line');
            icon.style.transform = "rotate(0deg)";
        }
    },

    renderHome() {
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        const friends = this.db[this.uid].friends || {};
        const groups = this.db[this.uid].groups || {};

        let allChats = [];

        // Coleta Amigos
        Object.keys(friends).forEach(id => {
            const f = friends[id];
            const last = f.history.length ? f.history[f.history.length-1] : null;
            allChats.push({
                id: id,
                name: f.name || id,
                pic: f.pic,
                lastMsg: last ? last.text : 'Nova conexão',
                time: last ? last.time : 0,
                type: 'user'
            });
        });

        // Coleta Grupos
        Object.keys(groups).forEach(id => {
            const g = groups[id];
            const last = g.history.length ? g.history[g.history.length-1] : null;
            allChats.push({
                id: id,
                name: g.name,
                pic: null, // Sem foto de grupo por enquanto
                lastMsg: last ? `${last.sender}: ${last.text}` : 'Grupo criado',
                time: last ? last.time : 0,
                type: 'group'
            });
        });

        // Ordena
        allChats.sort((a,b) => b.time - a.time);

        allChats.forEach(c => {
            const htmlAv = c.pic ? `<img src="${c.pic}">` : (c.type === 'group' ? '<i class="ri-group-fill"></i>' : c.name[0].toUpperCase());
            const div = document.createElement('div');
            div.style.cssText = "display:flex; align-items:center; gap:15px; padding:16px 20px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;";
            div.innerHTML = `
                <div class="avatar">${htmlAv}</div>
                <div style="flex:1; overflow:hidden;">
                    <div style="font-weight:600; font-size:15px; margin-bottom:2px;">${c.name}</div>
                    <div style="color:var(--text-dim); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.lastMsg}</div>
                </div>
            `;
            div.onclick = () => this.openChat(c.id);
            list.appendChild(div);
        });
    },

    // --- GRUPOS ---
    renderCreateGroup() {
        const list = document.getElementById('group-contact-list');
        list.innerHTML = '';
        this.selectedGroupMembers = [];
        
        Object.keys(this.db[this.uid].friends).forEach(id => {
            const f = this.db[this.uid].friends[id];
            const div = document.createElement('div');
            div.className = 'contact-select-item';
            div.onclick = () => {
                div.classList.toggle('selected');
                if(this.selectedGroupMembers.includes(id)) {
                    this.selectedGroupMembers = this.selectedGroupMembers.filter(m => m !== id);
                } else {
                    this.selectedGroupMembers.push(id);
                }
            };
            div.innerHTML = `
                <div class="checkbox-fake"></div>
                <div style="font-weight:600;">${f.name || id}</div>
            `;
            list.appendChild(div);
        });
    },

    createGroup() {
        const name = document.getElementById('group-name-input').value.trim();
        if(name.length < 1) return alert("Digite um nome para o grupo");
        if(this.selectedGroupMembers.length < 1) return alert("Selecione pelo menos 1 membro");

        const gid = 'group_' + Date.now();
        const members = [this.uid, ...this.selectedGroupMembers];
        
        if(!this.db[this.uid].groups) this.db[this.uid].groups = {};
        this.db[this.uid].groups[gid] = {
            name: name,
            members: members,
            history: []
        };
        this.saveDb();
        
        // Notifica membros na primeira mensagem enviada
        this.closeView('view-create-group');
        this.openChat(gid);
    },

    // --- CHAT ---
    addContact() {
        const id = document.getElementById('target-id').value.trim().toLowerCase();
        if(id === this.uid) return alert("Erro: Auto-adição.");
        if(id) {
            if(!this.db[this.uid].friends[id]) {
                this.db[this.uid].friends[id] = { name: id, history: [], bio: '', pic: '' };
                this.saveDb();
            }
            this.closeView('view-add');
            this.openChat(id);
            // Conecta
            const conn = this.peer.connect(id);
            conn.on('open', () => {
                this.activeConns[id] = conn;
                this.sendProfile(conn);
                conn.on('data', d => this.handleData(id, d));
            });
        }
    },

    openChat(id) {
        this.currentChat = id;
        this.updateChatHeader(id);
        this.renderMessages();
        this.openView('view-chat');
        
        if(!id.startsWith('group_')) {
            // Assegura conexão se for privado
            if(!this.activeConns[id] || !this.activeConns[id].open) {
                const conn = this.peer.connect(id);
                conn.on('open', () => {
                    this.activeConns[id] = conn;
                    this.sendProfile(conn);
                    conn.on('data', d => this.handleData(id, d));
                });
            }
        }
    },

    updateChatHeader(id) {
        let name, pic;
        if(id.startsWith('group_')) {
            const g = this.db[this.uid].groups[id];
            name = g.name;
            pic = null;
            document.getElementById('chat-status-text').innerText = `${g.members.length} membros`;
        } else {
            const f = this.db[this.uid].friends[id];
            name = f.name || id;
            pic = f.pic;
            document.getElementById('chat-status-text').innerText = 'Toque para ver perfil';
        }
        
        document.getElementById('chat-name').innerText = name;
        document.getElementById('chat-av').innerHTML = pic ? `<img src="${pic}">` : (id.startsWith('group_') ? '<i class="ri-group-fill"></i>' : name[0].toUpperCase());
    },

    renderMessages() {
        const area = document.getElementById('messages');
        area.innerHTML = '';
        let msgs = [];
        
        if(this.currentChat.startsWith('group_')) {
            msgs = this.db[this.uid].groups[this.currentChat].history || [];
        } else {
            msgs = this.db[this.uid].friends[this.currentChat].history || [];
        }
        
        msgs.forEach(m => {
            const isMe = m.sender === this.uid;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'sent' : 'received'}`;
            
            // Ticks: 1 check (sent), 2 checks (delivered/read)
            let ticks = '';
            if(isMe && !this.currentChat.startsWith('group_')) {
                const checkClass = m.status === 'delivered' ? 'tick read' : 'tick';
                const icon = m.status === 'delivered' ? '<i class="ri-check-double-line"></i>' : '<i class="ri-check-line"></i>';
                ticks = `<span class="${checkClass}">${icon}</span>`;
            }

            // Nome em grupos
            let senderName = '';
            if(!isMe && this.currentChat.startsWith('group_')) {
                 // Tenta achar nome nos amigos, senao usa ID
                 const f = this.db[this.uid].friends[m.sender];
                 senderName = `<div style="font-size:10px; color:var(--primary); font-weight:bold; margin-bottom:2px;">${f ? f.name : m.sender}</div>`;
            }

            div.innerHTML = `
                ${senderName}
                ${m.text}
                <div class="msg-meta">
                    <span>${new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    ${ticks}
                </div>
            `;
            area.appendChild(div);
        });
        area.scrollTop = area.scrollHeight;
    },

    closeChat() {
        this.currentChat = null;
        this.closeView('view-chat');
        this.renderHome();
    },

    // --- PERFIL ---
    saveProfile() {
        const me = this.db[this.uid];
        me.name = document.getElementById('edit-name').value;
        me.bio = document.getElementById('edit-bio').value;
        me.pic = document.getElementById('edit-pic').value;
        this.saveDb();
        this.updateHeader();
        this.closeView('view-me');
        // Propaga
        Object.values(this.activeConns).forEach(conn => {
            if(conn.open) this.sendProfile(conn);
        });
    },

    updateHeader() {
        const me = this.db[this.uid];
        document.getElementById('header-name').innerText = me.name || this.uid;
        document.getElementById('edit-name').value = me.name || "";
        document.getElementById('edit-bio').value = me.bio || "";
        document.getElementById('edit-pic').value = me.pic || "";
        
        const html = me.pic ? `<img src="${me.pic}">` : this.uid[0].toUpperCase();
        document.getElementById('header-av').innerHTML = html;
        document.getElementById('me-large-av').innerHTML = html.replace('width:100%', 'width:100%');
    },

    showContact() {
        if(!this.currentChat || this.currentChat.startsWith('group_')) return;
        const f = this.db[this.uid].friends[this.currentChat];
        
        document.getElementById('contact-real-name').innerText = f.name || this.currentChat;
        document.getElementById('contact-real-id').innerText = '@' + this.currentChat;
        document.getElementById('contact-real-bio').innerText = f.bio || "Sem recado.";
        
        const html = f.pic ? `<img src="${f.pic}">` : `<span style="font-size:40px; color:var(--primary); font-weight:bold;">${this.currentChat[0].toUpperCase()}</span>`;
        document.getElementById('contact-large-av').innerHTML = html;
        
        this.openView('view-contact');
    },

    // --- CHAMADAS (VOZ E VIDEO) ---
    async call(isVideo) {
        if(this.currentChat.startsWith('group_')) return alert("Chamadas em grupo indisponíveis nesta versão.");
        
        this.isVoiceOnly = !isVideo;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
            this.callStream = stream;
            
            this.updateCallUI();
            
            // Sinaliza tipo de chamada antes de iniciar stream
            if(this.isVoiceOnly && this.activeConns[this.currentChat]) {
                this.activeConns[this.currentChat].send({ type: 'call_type', mode: 'voice' });
            }

            const call = this.peer.call(this.currentChat, stream);
            this.handleMediaCall(call);

        } catch(e) {
            console.error(e);
            alert("Erro: Permita acesso a câmera/mic e use HTTPS.");
        }
    },

    async answerCall() {
        try {
            // Se foi marcado como voz apenas na sinalização
            const stream = await navigator.mediaDevices.getUserMedia({ video: !this.isVoiceOnly, audio: true });
            this.callStream = stream;
            this.updateCallUI();
            
            this.incomingCall.answer(stream);
            this.handleMediaCall(this.incomingCall);
        } catch(e) {
            alert("Erro ao atender.");
        }
    },

    handleMediaCall(call) {
        this.incomingCall = call;
        call.on('stream', remoteStream => {
            const vid = document.getElementById('remote-video');
            vid.srcObject = remoteStream;
            vid.play();
        });
        call.on('close', () => this.endCall(true));
    },

    updateCallUI() {
        const ui = document.getElementById('call-ui');
        ui.classList.add('active');
        
        // Reset controls
        document.getElementById('btn-mic').className = 'ctrl-btn active'; // Active style means ON here
        document.getElementById('btn-speaker').className = 'ctrl-btn active';
        this.micEnabled = true;

        if(this.isVoiceOnly) {
            ui.classList.add('voice-mode');
            // Carrega info do usuário
            const f = this.db[this.uid].friends[this.currentChat] || { name: this.incomingCall?.peer || 'Desconhecido', pic: '' };
            document.getElementById('voice-call-name').innerText = f.name || f.peer;
            document.getElementById('voice-call-img').src = f.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            
            // Local stream (mic only)
            // Não precisamos mostrar video local
        } else {
            ui.classList.remove('voice-mode');
            document.getElementById('local-video').srcObject = this.callStream;
        }
    },

    toggleMic() {
        if(!this.callStream) return;
        const track = this.callStream.getAudioTracks()[0];
        this.micEnabled = !this.micEnabled;
        track.enabled = this.micEnabled;
        
        const btn = document.getElementById('btn-mic');
        if(this.micEnabled) {
            btn.classList.add('active');
            btn.innerHTML = '<i class="ri-mic-fill"></i>';
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<i class="ri-mic-off-fill"></i>';
        }
    },

    toggleSpeaker() {
        // Em navegadores móveis/desktop, controle real de speaker é limitado por segurança.
        // Simulamos a UI e tentamos mutar o elemento remoto se desejado.
        const vid = document.getElementById('remote-video');
        this.speakerEnabled = !this.speakerEnabled;
        vid.muted = !this.speakerEnabled;
        
        const btn = document.getElementById('btn-speaker');
        if(this.speakerEnabled) {
            btn.classList.add('active');
            btn.innerHTML = '<i class="ri-volume-up-fill"></i>';
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<i class="ri-volume-mute-fill"></i>';
        }
    },

    endCall(remoteClosed) {
        if(this.incomingCall) this.incomingCall.close();
        if(this.callStream) this.callStream.getTracks().forEach(t => t.stop());
        
        document.getElementById('call-ui').classList.remove('active', 'voice-mode');
        this.incomingCall = null;
        this.callStream = null;
        this.isVoiceOnly = false;
        if(!remoteClosed) {
            // Opcional: play sound
        }
    },

    // UTILS
    openView(id) { 
        if(id === 'view-create-group') this.renderCreateGroup();
        document.getElementById(id).classList.add('active'); 
    },
    closeView(id) { document.getElementById(id).classList.remove('active'); }
};

sys.init();
</script>
</body>
</html>
