<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cris√°lida Ultra | P2P Groups</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0b0b0e; --panel: #16161d; --accent: #00f2ff;
            --purple: #7000ff; --text: #ffffff; --danger: #ff3b30;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* AUTH SCREEN */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box { 
            width: 100%; max-width: 350px; background: var(--panel); padding: 30px; 
            border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); text-align: center;
            box-shadow: 0 0 30px rgba(112,0,255,0.2);
        }
        input { 
            width: 100%; padding: 14px; background: #000; border: 1px solid #333; 
            border-radius: 12px; color: white; margin-bottom: 12px; outline: none; font-size: 16px;
        }
        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; 
            font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-main { background: var(--purple); color: white; }
        .btn-main:active { transform: scale(0.95); }

        /* APP LAYOUT */
        #app { display: none; flex-direction: column; height: 100%; }
        header { 
            height: 70px; background: var(--panel); display: flex; 
            align-items: center; padding: 0 15px; border-bottom: 1px solid #222; 
        }
        #chat-flow { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; 
            flex-direction: column; gap: 8px; background: #0e0e12;
        }

        /* BUBBLES */
        .msg { max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; }
        .sent { align-self: flex-end; background: var(--purple); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: #26262e; border-bottom-left-radius: 2px; border-left: 3px solid var(--accent); }
        .msg-sender { font-size: 10px; color: var(--accent); margin-bottom: 4px; display: block; font-weight: bold; }

        .input-area { padding: 15px; background: var(--panel); display: flex; gap: 10px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .msg-input { flex: 1; background: #000; border: none; padding: 12px 18px; border-radius: 25px; color: white; outline: none; }

        /* CALL UI */
        .call-ui { 
            position: fixed; inset: 0; background: #000; z-index: 8000; 
            display: none; flex-direction: column; 
        }
        .video-grid { flex: 1; display: grid; grid-template-columns: 1fr; grid-auto-rows: 1fr; gap: 5px; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; background: #111; }
        
        .call-btns { height: 100px; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.8); }
        
        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 8px 20px; border-radius: 20px; font-weight: bold; display: none; z-index: 10000; }
    </style>
</head>
<body>

    <div id="toast">LINK COPIADO</div>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="color: var(--accent); margin-bottom: 10px;">CRIS√ÅLIDA</h2>
            <p style="font-size: 12px; color: #888; margin-bottom: 20px;">SISTEMA DE GRUPOS P2P</p>
            <input type="text" id="user-id" placeholder="Seu Nickname">
            <input type="password" id="user-pass" placeholder="Senha da Conta">
            <div style="height: 1px; background: #333; margin: 15px 0;"></div>
            <input type="text" id="room-id" placeholder="Nome da Sala / Grupo">
            <button class="btn btn-main" onclick="handleAuth()">CONECTAR √Ä SALA</button>
        </div>
    </div>

    <div id="app">
        <header>
            <div style="flex: 1;">
                <h4 id="room-title">SALA: ...</h4>
                <span id="peer-status" style="font-size: 11px; color: #888;">Aguardando conex√µes...</span>
            </div>
            <button onclick="copyInvite()" style="background:none; border:none; color:var(--accent); font-size:20px; cursor:pointer; margin-right:15px;">üîó</button>
            <button onclick="startCall()" style="background:none; border:none; color:var(--accent); font-size:20px; cursor:pointer; margin-right:15px;">üìπ</button>
            <button onclick="logout()" style="background:none; border:none; color:var(--danger); font-size:20px; cursor:pointer;">üö™</button>
        </header>

        <main id="chat-flow"></main>

        <div class="input-area">
            <input type="text" id="msg-input" class="msg-input" placeholder="Conversar com o grupo..." onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()" style="background:var(--purple); border:none; color:white; width: 45px; height: 45px; border-radius:50%; font-size: 20px;">üöÄ</button>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <div id="video-grid" class="video-grid">
            <video id="local-video" autoplay muted playsinline></video>
        </div>
        <div class="call-btns">
            <button onclick="endCall()" style="width:65px; height:65px; background:var(--danger); border-radius:50%; border:none; color:white; font-size:30px;">‚úñ</button>
        </div>
    </div>

    <script>
        let peer, connections = {}, myStream;
        let myId, currentRoom;

        // 1. LOGIN E SALAS
        function handleAuth() {
            const user = document.getElementById('user-id').value.trim().toLowerCase();
            const pass = document.getElementById('user-pass').value.trim();
            const room = document.getElementById('room-id').value.trim().toLowerCase();
            
            if(!user || !pass || !room) return alert("Preencha todos os campos!");

            // Salvar conta
            let accs = JSON.parse(localStorage.getItem('cris_accs') || '{}');
            if(accs[user] && accs[user] !== pass) return alert("Senha incorreta para este usu√°rio!");
            accs[user] = pass;
            localStorage.setItem('cris_accs', JSON.stringify(accs));

            myId = user;
            currentRoom = room;
            
            // Salvar sess√£o para n√£o deslogar no F5
            localStorage.setItem('cris_session_user', user);
            localStorage.setItem('cris_session_room', room);

            startPeer();
        }

        window.onload = () => {
            const sUser = localStorage.getItem('cris_session_user');
            const sRoom = localStorage.getItem('cris_session_room');
            if(sUser && sRoom) {
                myId = sUser;
                currentRoom = sRoom;
                startPeer();
            }
        };

        function logout() {
            localStorage.removeItem('cris_session_user');
            location.href = window.location.pathname;
        }

        // 2. LOGICA MULTI-USU√ÅRIO (MESH NETWORK)
        function startPeer() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('room-title').innerText = "SALA: " + currentRoom.toUpperCase();

            // Usamos ID composto para evitar conflitos: sala_usuario
            const peerId = `${currentRoom}_${myId}`;
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                document.getElementById('peer-status').innerText = "Voc√™ entrou na sala.";
                // Tenta conectar em todos que estiverem na mesma sala (isso exigiria um servidor de sinaliza√ß√£o para listar usu√°rios,
                // mas como estamos 100% P2P, usaremos a l√≥gica de link de convite ou busca manual).
                checkInvite();
            });

            peer.on('connection', (conn) => {
                setupConnection(conn);
            });

            peer.on('call', (call) => {
                navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                    myStream = stream;
                    document.getElementById('call-ui').style.display = 'flex';
                    addVideo(stream, true);
                    call.answer(stream);
                    call.on('stream', remoteStream => addVideo(remoteStream));
                });
            });
        }

        function setupConnection(conn) {
            connections[conn.peer] = conn;
            conn.on('data', (data) => {
                if(data.type === 'chat') {
                    render(data.user, data.msg, 'received');
                }
            });
            document.getElementById('peer-status').innerText = Object.keys(connections).length + " conectado(s)";
        }

        function send() {
            const input = document.getElementById('msg-input');
            const msg = input.value.trim();
            if(!msg) return;

            // Enviar para todos os conectados na malha
            Object.values(connections).forEach(conn => {
                conn.send({ type: 'chat', user: myId, msg: msg });
            });

            render(myId, msg, 'sent');
            input.value = "";
        }

        function render(user, msg, type) {
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<span class="msg-sender">${user.toUpperCase()}</span>${msg}`;
            flow.appendChild(div);
            flow.scrollTop = flow.scrollHeight;
        }

        // 3. CONVITES E CALLS
        function copyInvite() {
            const url = `${window.location.origin}${window.location.pathname}?room=${currentRoom}&join=${myId}`;
            navigator.clipboard.writeText(url);
            const t = document.getElementById('toast');
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function checkInvite() {
            const params = new URLSearchParams(window.location.search);
            const targetUser = params.get('join');
            const targetRoom = params.get('room');

            if(targetUser && targetRoom === currentRoom) {
                const targetPeerId = `${targetRoom}_${targetUser}`;
                if(targetPeerId !== peer.id) {
                    const conn = peer.connect(targetPeerId);
                    setupConnection(conn);
                }
            }
        }

        async function startCall() {
            myStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('call-ui').style.display = 'flex';
            addVideo(myStream, true);

            Object.values(connections).forEach(conn => {
                const call = peer.call(conn.peer, myStream);
                call.on('stream', remoteStream => addVideo(remoteStream));
            });
        }

        function addVideo(stream, isLocal = false) {
            const grid = document.getElementById('video-grid');
            let video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if(isLocal) video.muted = true;
            grid.appendChild(video);
            
            // Ajustar grid baseado no numero de videos
            const count = grid.querySelectorAll('video').length;
            grid.style.gridTemplateColumns = count > 1 ? "1fr 1fr" : "1fr";
        }

        function endCall() {
            document.getElementById('call-ui').style.display = 'none';
            if(myStream) myStream.getTracks().forEach(t => t.stop());
            document.getElementById('video-grid').innerHTML = '<video id="local-video" autoplay muted playsinline></video>';
        }
    </script>
</body>
</html>
