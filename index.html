<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crimson Protocol | Secure Messaging</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #e53935;
            --primary-dark: #b71c1c;
            --surface: #0f0f12;
            --background: #08080a;
            --panel: #1a1a1e;
            --text: #f1f1f1;
            --text-dim: #9ca3af;
            --border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--background); color: var(--text); height: 100dvh; display: flex; overflow: hidden; }

        /* --- SISTEMA DE TELAS --- */
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--background); z-index: 10; }
        .screen-active { display: flex; }

        /* --- HEADERS --- */
        header { 
            height: 68px; 
            padding: 0 20px; 
            background: var(--surface); 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            gap: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .header-title { flex: 1; font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; }

        /* --- LISTAS (CHATS E CONTATOS) --- */
        .scroll-area { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .row-item { 
            padding: 16px 20px; 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .row-item:hover { background: rgba(255,255,255,0.03); }
        .avatar { 
            width: 52px; height: 52px; border-radius: 16px; 
            background: var(--primary); object-fit: cover;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: white; border: 1px solid var(--border);
        }

        /* --- CHAT BUBBLES --- */
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 6px; background-image: radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px); background-size: 20px 20px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 14px; font-size: 14px; line-height: 1.5; position: relative; }
        .sent { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 2px; box-shadow: 0 2px 4px rgba(229, 57, 53, 0.2); }
        .received { align-self: flex-start; background: var(--panel); border-bottom-left-radius: 2px; border: 1px solid var(--border); }
        .msg-info { display: flex; justify-content: flex-end; gap: 4px; font-size: 10px; opacity: 0.8; margin-top: 4px; }
        .status-tick { color: #ffcdd2; font-weight: bold; }
        .status-tick.read { color: #ffffff; }

        /* --- BOTÃO FLUTUANTE (FAB) --- */
        .fab { 
            position: fixed; bottom: 32px; right: 32px; 
            width: 60px; height: 60px; border-radius: 20px;
            background: var(--primary); color: white; border: none;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(183, 28, 28, 0.4);
            cursor: pointer; z-index: 100; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .fab:hover { transform: scale(1.1) rotate(5deg); background: var(--primary-dark); }

        /* --- INPUT AREA --- */
        .input-bar { padding: 16px 20px; background: var(--surface); border-top: 1px solid var(--border); display: flex; gap: 12px; }
        .input-field { flex: 1; padding: 12px 18px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; }
        .input-field:focus { border-color: var(--primary); }
        .btn-send { background: var(--primary); border: none; padding: 0 20px; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; }

        /* --- LOGIN --- */
        #auth-screen { z-index: 1000; align-items: center; justify-content: center; padding: 24px; }
        .auth-card { width: 100%; max-width: 400px; background: var(--surface); padding: 48px; border-radius: 32px; border: 1px solid var(--border); text-align: center; }

        .hidden { display: none !important; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 4px 8px; }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen screen-active">
        <div class="auth-card">
            <div style="width: 64px; height: 64px; background: var(--primary); border-radius: 20px; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800;">C</div>
            <h2 style="margin-bottom: 8px;">Protocolo Crimson</h2>
            <p style="color: var(--text-dim); margin-bottom: 32px; font-size: 0.9rem;">Acesse sua rede de comunicação criptografada.</p>
            <input type="text" id="login-id" class="input-field" placeholder="Identificador de Usuário" style="margin-bottom: 16px; text-align: center;">
            <button onclick="login()" class="btn-send" style="width: 100%; height: 50px;">INICIAR SESSÃO</button>
        </div>
    </div>

    <div id="dash-screen" class="screen">
        <header>
            <div id="my-profile-btn" class="avatar" style="width:40px; height:40px; cursor:pointer;" onclick="showScreen('profile-screen')">?</div>
            <div class="header-title">Crimson Chat</div>
            <button onclick="logout()" style="background:none; border:none; color:var(--text-dim);">Sair</button>
        </header>
        <div id="chats-list" class="scroll-area"></div>
        <button class="fab" onclick="showScreen('contacts-screen')">＋</button>
    </div>

    <div id="contacts-screen" class="screen">
        <header>
            <button class="back-btn" onclick="showScreen('dash-screen')">←</button>
            <div class="header-title">Adicionar Contato</div>
        </header>
        <div class="input-bar">
            <input type="text" id="target-id" class="input-field" placeholder="Nickname do contato...">
            <button onclick="addContact()" class="btn-send">Adicionar</button>
        </div>
        <div id="contacts-list" class="scroll-area"></div>
    </div>

    <div id="chat-screen" class="screen">
        <header>
            <button class="back-btn" onclick="showScreen('dash-screen')">←</button>
            <div id="chat-header-info" style="flex:1">
                <h4 id="active-nick">Nome</h4>
                <p id="active-status" style="font-size: 11px; color: var(--text-dim);">Offline</p>
            </div>
        </header>
        <div id="chat-flow"></div>
        <div class="input-bar">
            <input type="text" id="msg-input" class="input-field" placeholder="Mensagem..." onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()" class="btn-send">ENVIAR</button>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <header>
            <button class="back-btn" onclick="showScreen('dash-screen')">←</button>
            <div class="header-title">Meu Perfil</div>
        </header>
        <div style="padding: 40px; text-align: center;">
            <div id="p-avatar-preview" class="avatar" style="width:120px; height:120px; margin: 0 auto 24px; font-size: 3rem;">?</div>
            <input type="text" id="p-img" class="input-field" placeholder="URL da imagem de perfil" style="margin-bottom: 16px;">
            <input type="text" id="p-status" class="input-field" placeholder="Status / Recado" style="margin-bottom: 24px;">
            <button onclick="saveProfile()" class="btn-send" style="width: 100%; height: 50px;">SALVAR ALTERAÇÕES</button>
        </div>
    </div>

    <script>
        let peer, myId, conns = {}, activeChat = null;
        let db = {
            profile: JSON.parse(localStorage.getItem('crim_profile') || '{"img":"","status":"Disponível"}'),
            contacts: JSON.parse(localStorage.getItem('crim_contacts') || '[]'),
            history: JSON.parse(localStorage.getItem('crim_history') || '{}')
        };

        function login() {
            const id = document.getElementById('login-id').value.trim().toLowerCase();
            if(!id) return;
            localStorage.setItem('crim_user', id);
            location.reload();
        }

        function logout() { localStorage.removeItem('crim_user'); location.reload(); }

        window.onload = () => {
            myId = localStorage.getItem('crim_user');
            if(myId) {
                document.getElementById('auth-screen').classList.remove('screen-active');
                showScreen('dash-screen');
                initPeer();
                updateMyUI();
            }
        };

        function initPeer() {
            peer = new Peer(myId);
            peer.on('open', () => {
                renderDash();
                db.contacts.forEach(c => tryConnect(c));
            });
            peer.on('connection', conn => setupConnection(conn));
        }

        function setupConnection(conn) {
            conns[conn.peer] = conn;
            conn.on('open', () => {
                if(activeChat === conn.peer) document.getElementById('active-status').innerText = "Online agora";
                // Sincronizar mensagens não lidas
                const pending = (db.history[conn.peer] || []).filter(m => m.from === myId && !m.read);
                pending.forEach(m => conn.send(m));
            });
            conn.on('data', data => {
                if(data.type === 'msg') {
                    if(!db.history[conn.peer]) db.history[conn.peer] = [];
                    if(!db.history[conn.peer].find(m => m.id === data.id)) {
                        db.history[conn.peer].push({...data, read: true});
                        save(); renderDash(); if(activeChat === conn.peer) renderChat();
                        conn.send({type: 'ack', id: data.id});
                    }
                } else if(data.type === 'ack') {
                    const msg = db.history[conn.peer]?.find(m => m.id === data.id);
                    if(msg) { msg.read = true; save(); if(activeChat === conn.peer) renderChat(); }
                }
            });
        }

        function tryConnect(id) { if(!conns[id]) setupConnection(peer.connect(id)); }

        function send() {
            const input = document.getElementById('msg-input');
            if(!input.value || !activeChat) return;
            const msg = {
                id: Date.now(), type: 'msg', from: myId, text: input.value,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), read: false
            };
            if(!db.history[activeChat]) db.history[activeChat] = [];
            db.history[activeChat].push(msg);
            if(conns[activeChat]?.open) conns[activeChat].send(msg); else tryConnect(activeChat);
            input.value = ""; save(); renderChat(); renderDash();
        }

        function renderDash() {
            const list = document.getElementById('chats-list');
            list.innerHTML = "";
            const sorted = Object.keys(db.history).sort((a,b) => {
                const la = db.history[a].slice(-1)[0]?.id || 0;
                const lb = db.history[b].slice(-1)[0]?.id || 0;
                return lb - la;
            });
            sorted.forEach(id => {
                const last = db.history[id].slice(-1)[0];
                list.innerHTML += `
                    <div class="row-item" onclick="openChat('${id}')">
                        <div class="avatar">${id[0].toUpperCase()}</div>
                        <div style="flex:1">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <b>${id}</b> <span style="font-size:11px; color:var(--text-dim)">${last?.time || ''}</span>
                            </div>
                            <p style="font-size:13px; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${last?.text || 'Sem mensagens'}
                            </p>
                        </div>
                    </div>`;
            });
        }

        function renderContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = "";
            db.contacts.forEach(id => {
                list.innerHTML += `
                    <div class="row-item" onclick="openChat('${id}')">
                        <div class="avatar">${id[0].toUpperCase()}</div>
                        <b>${id}</b>
                    </div>`;
            });
        }

        function openChat(id) {
            activeChat = id;
            document.getElementById('active-nick').innerText = id;
            document.getElementById('active-status').innerText = conns[id]?.open ? "Online agora" : "Offline";
            showScreen('chat-screen');
            renderChat();
            tryConnect(id);
        }

        function renderChat() {
            const flow = document.getElementById('chat-flow');
            flow.innerHTML = "";
            (db.history[activeChat] || []).forEach(m => {
                const isMe = m.from === myId;
                flow.innerHTML += `
                    <div class="msg ${isMe ? 'sent' : 'received'}">
                        ${m.text}
                        <div class="msg-info">
                            ${m.time} ${isMe ? `<span class="status-tick ${m.read ? 'read' : ''}">${m.read ? '✓✓' : '✓'}</span>` : ''}
                        </div>
                    </div>`;
            });
            flow.scrollTop = flow.scrollHeight;
        }

        function addContact() {
            const id = document.getElementById('target-id').value.trim().toLowerCase();
            if(id && id !== myId && !db.contacts.includes(id)) {
                db.contacts.push(id);
                if(!db.history[id]) db.history[id] = [];
                save(); renderContacts();
                document.getElementById('target-id').value = "";
                openChat(id);
            }
        }

        function saveProfile() {
            db.profile.img = document.getElementById('p-img').value;
            db.profile.status = document.getElementById('p-status').value;
            localStorage.setItem('crim_profile', JSON.stringify(db.profile));
            updateMyUI();
            showScreen('dash-screen');
        }

        function updateMyUI() {
            const img = db.profile.img || `https://ui-avatars.com/api/?background=e53935&color=fff&name=${myId}`;
            document.getElementById('my-profile-btn').innerHTML = db.profile.img ? `<img src="${img}" style="width:100%;height:100%;border-radius:16px;">` : myId[0].toUpperCase();
            document.getElementById('p-avatar-preview').innerHTML = db.profile.img ? `<img src="${img}" style="width:100%;height:100%;border-radius:16px;">` : myId[0].toUpperCase();
            document.getElementById('p-img').value = db.profile.img;
            document.getElementById('p-status').value = db.profile.status;
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('screen-active'));
            document.getElementById(id).classList.add('screen-active');
            if(id === 'contacts-screen') renderContacts();
        }

        function save() {
            localStorage.setItem('crim_contacts', JSON.stringify(db.contacts));
            localStorage.setItem('crim_history', JSON.stringify(db.history));
        }
    </script>
</body>
</html>
