<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crimson Elite | Messaging Platform</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #d32f2f; /* Vermelho Profissional */
            --primary-dark: #b71c1c;
            --bg-deep: #0a0a0b;
            --bg-card: #141417;
            --bg-panel: #1c1c21;
            --text-main: #f5f5f7;
            --text-dim: #a0a0ab;
            --border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-deep); color: var(--text-main); height: 100dvh; display: flex; overflow: hidden; }

        /* --- TELAS --- */
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg-deep); z-index: 10; }
        .active-screen { display: flex; }

        /* --- COMPONENTES GLOBAIS --- */
        header { height: 64px; background: var(--bg-card); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border); gap: 15px; }
        .btn-icon { background: none; border: none; color: var(--text-main); cursor: pointer; font-size: 20px; padding: 10px; border-radius: 50%; transition: 0.2s; }
        .btn-icon:hover { background: rgba(255,255,255,0.05); }
        
        .input-group { padding: 15px; background: var(--bg-deep); }
        .input-field { width: 100%; padding: 12px 16px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; }
        .input-field:focus { border-color: var(--primary); }

        /* --- DASHBOARD & LISTAS --- */
        .list-container { flex: 1; overflow-y: auto; }
        .item-row { padding: 14px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .item-row:hover { background: rgba(255,255,255,0.02); }
        .avatar { width: 48px; height: 48px; border-radius: 14px; object-fit: cover; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid var(--border); }
        .item-body { flex: 1; min-width: 0; }
        .item-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-weight: 600; font-size: 15px; }
        .item-sub { font-size: 13px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- BOT√ÉO FLUTUANTE (ESTILO WHATSAPP) --- */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(211, 47, 47, 0.4); border: none; color: white; font-size: 24px; cursor: pointer; z-index: 100; transition: 0.3s; }
        .fab:hover { transform: scale(1.05); background: var(--primary-dark); }

        /* --- CHAT VIEW --- */
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background: #080809; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 14px; font-size: 14.5px; position: relative; line-height: 1.4; }
        .sent { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--bg-panel); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .msg-meta { display: flex; justify-content: flex-end; gap: 4px; font-size: 10px; opacity: 0.7; margin-top: 4px; }
        .tick-red { color: #ff8a80; font-weight: bold; }

        /* --- AUTH --- */
        #auth-screen { z-index: 1000; justify-content: center; align-items: center; padding: 25px; }
        .card { width: 100%; max-width: 380px; background: var(--bg-card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); text-align: center; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen active-screen">
        <div class="card">
            <h1 style="color: var(--primary); margin-bottom: 10px;">Crimson</h1>
            <p style="color: var(--text-dim); margin-bottom: 30px; font-size: 14px;">Plataforma de Comunica√ß√£o Segura</p>
            <input type="text" id="login-id" class="input-field" placeholder="Seu nickname..." style="margin-bottom: 15px;">
            <button onclick="auth()" class="input-field" style="background: var(--primary); border: none; font-weight: 700; cursor: pointer;">ACESSAR CONTA</button>
        </div>
    </div>

    <div id="dash-screen" class="screen">
        <header>
            <img id="my-avatar-img" class="avatar" style="width:36px; height:36px; cursor:pointer;" onclick="showScreen('profile-screen')">
            <h3 style="flex:1">Conversas</h3>
            <button class="btn-icon" onclick="logout()">üö™</button>
        </header>
        <div id="chats-list" class="list-container"></div>
        <button class="fab" onclick="showScreen('friends-screen')">üë§</button>
    </div>

    <div id="friends-screen" class="screen">
        <header>
            <button class="btn-icon" onclick="showScreen('dash-screen')">‚Üê</button>
            <h3 style="flex:1">Meus Amigos</h3>
        </header>
        <div class="input-group">
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-friend-id" class="input-field" placeholder="Nickname do amigo...">
                <button onclick="addFriend()" class="input-field" style="width:auto; background:var(--primary); border:none; padding:0 20px;">Adicionar</button>
            </div>
        </div>
        <div id="friends-list" class="list-container"></div>
    </div>

    <div id="chat-screen" class="screen">
        <header>
            <button class="btn-icon" onclick="showScreen('dash-screen')">‚Üê</button>
            <div style="flex:1">
                <h4 id="active-name">Nome</h4>
                <p id="active-status" style="font-size:11px; color:var(--text-dim);">Offline</p>
            </div>
            <button class="btn-icon" style="color:var(--primary)">üìû</button>
        </header>
        <div id="chat-flow"></div>
        <div class="input-group" style="display:flex; gap:10px; background:var(--bg-card);">
            <input type="text" id="chat-input" class="input-field" placeholder="Escreva..." onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()" class="btn-icon" style="color:var(--primary)">üöÄ</button>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <header>
            <button class="btn-icon" onclick="showScreen('dash-screen')">‚Üê</button>
            <h3>Meu Perfil</h3>
        </header>
        <div style="padding: 30px; text-align:center;">
            <div id="p-avatar-box" class="avatar" style="width:100px; height:100px; margin:0 auto 20px; font-size:32px;"></div>
            <input type="text" id="p-img-url" class="input-field" placeholder="URL da foto..." style="margin-bottom:15px;">
            <input type="text" id="p-bio" class="input-field" placeholder="Sua bio..." style="margin-bottom:20px;">
            <button onclick="saveProfile()" class="input-field" style="background:var(--primary); border:none; font-weight:700;">SALVAR ALTERA√á√ïES</button>
        </div>
    </div>

    <script>
        let peer, myId, activePeer = null, conns = {};
        let db = {
            me: JSON.parse(localStorage.getItem('cr_me') || '{"img":"","bio":"Dispon√≠vel"}'),
            friends: JSON.parse(localStorage.getItem('cr_friends') || '[]'),
            history: JSON.parse(localStorage.getItem('cr_history') || '{}')
        };

        function auth() {
            const id = document.getElementById('login-id').value.trim().toLowerCase();
            if(!id) return;
            localStorage.setItem('cr_user', id);
            location.reload();
        }

        function logout() { localStorage.removeItem('cr_user'); location.reload(); }

        window.onload = () => {
            myId = localStorage.getItem('cr_user');
            if(myId) {
                document.getElementById('auth-screen').classList.remove('active-screen');
                showScreen('dash-screen');
                initPeer();
                updateProfileUI();
            }
        };

        function initPeer() {
            peer = new Peer(myId);
            peer.on('open', () => {
                renderChats();
                db.friends.forEach(f => connectTo(f));
            });
            peer.on('connection', c => handleConn(c));
        }

        function handleConn(c) {
            conns[c.peer] = c;
            c.on('open', () => {
                if(activePeer === c.peer) document.getElementById('active-status').innerText = "Online";
                // Sincroniza pendentes
                (db.history[c.peer] || []).filter(m => m.from === myId && !m.read).forEach(m => c.send(m));
            });
            c.on('data', data => {
                if(data.type === 'msg') {
                    if(!db.history[c.peer]) db.history[c.peer] = [];
                    if(!db.history[c.peer].find(m => m.id === data.id)) {
                        db.history[c.peer].push({...data, read: true});
                        save(); renderChats(); if(activePeer === c.peer) renderChat();
                        c.send({type:'ack', id: data.id});
                    }
                } else if(data.type === 'ack') {
                    const m = db.history[c.peer]?.find(x => x.id === data.id);
                    if(m) { m.read = true; save(); if(activePeer === c.peer) renderChat(); }
                }
            });
        }

        function connectTo(id) { if(!conns[id]) handleConn(peer.connect(id)); }

        function send() {
            const input = document.getElementById('chat-input');
            if(!input.value || !activePeer) return;
            const msg = {
                id: Date.now(), type:'msg', from: myId, text: input.value,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), read: false
            };
            if(!db.history[activePeer]) db.history[activePeer] = [];
            db.history[activePeer].push(msg);
            if(conns[activePeer]?.open) conns[activePeer].send(msg); else connectTo(activePeer);
            input.value = ""; save(); renderChat(); renderChats();
        }

        function renderChats() {
            const list = document.getElementById('chats-list');
            list.innerHTML = "";
            Object.keys(db.history).reverse().forEach(id => {
                const last = db.history[id].slice(-1)[0];
                list.innerHTML += `
                    <div class="item-row" onclick="openChat('${id}')">
                        <div class="avatar">${id[0].toUpperCase()}</div>
                        <div class="item-body">
                            <div class="item-top"><span class="item-name">${id}</span><span style="font-size:10px">${last?.time || ''}</span></div>
                            <div class="item-sub">${last?.text || 'Sem mensagens'}</div>
                        </div>
                    </div>`;
            });
        }

        function renderFriends() {
            const list = document.getElementById('friends-list');
            list.innerHTML = "";
            db.friends.forEach(id => {
                list.innerHTML += `
                    <div class="item-row" onclick="openChat('${id}')">
                        <div class="avatar">${id[0].toUpperCase()}</div>
                        <div class="item-body"><div class="item-name">${id}</div></div>
                    </div>`;
            });
        }

        function openChat(id) {
            activePeer = id;
            document.getElementById('active-name').innerText = id;
            document.getElementById('active-status').innerText = conns[id]?.open ? "Online" : "Offline";
            showScreen('chat-screen');
            renderChat();
            connectTo(id);
        }

        function renderChat() {
            const flow = document.getElementById('chat-flow');
            flow.innerHTML = "";
            (db.history[activePeer] || []).forEach(m => {
                const isMe = m.from === myId;
                flow.innerHTML += `
                    <div class="msg ${isMe ? 'sent' : 'received'}">
                        ${m.text}
                        <div class="msg-meta">${m.time} ${isMe ? `<span class="${m.read?'tick-red':''}">${m.read?'‚úì‚úì':'‚úì'}</span>`:''}</div>
                    </div>`;
            });
            flow.scrollTop = flow.scrollHeight;
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            if(id === 'friends-screen') renderFriends();
            if(id === 'dash-screen') renderChats();
        }

        function addFriend() {
            const id = document.getElementById('new-friend-id').value.trim().toLowerCase();
            if(id && id !== myId && !db.friends.includes(id)) {
                db.friends.push(id);
                if(!db.history[id]) db.history[id] = [];
                save(); renderFriends();
                document.getElementById('new-friend-id').value = "";
            }
        }

        function saveProfile() {
            db.me.img = document.getElementById('p-img-url').value;
            db.me.bio = document.getElementById('p-bio').value;
            localStorage.setItem('cr_me', JSON.stringify(db.me));
            updateProfileUI();
            showScreen('dash-screen');
        }

        function updateProfileUI() {
            const img = db.me.img || `https://ui-avatars.com/api/?background=d32f2f&color=fff&name=${myId}`;
            document.getElementById('my-avatar-img').src = img;
            document.getElementById('p-avatar-box').innerHTML = db.me.img ? `<img src="${db.me.img}" style="width:100%;height:100%;border-radius:14px;">` : myId[0].toUpperCase();
        }

        function save() {
            localStorage.setItem('cr_friends', JSON.stringify(db.friends));
            localStorage.setItem('cr_history', JSON.stringify(db.history));
        }
    </script>
</body>
</html>
