<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cris√°lida PRO | Messaging Suite</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050507; --side: #0f0f13; --panel: #18181f;
            --accent: #00f2ff; --purple: #6366f1; --text: #f8fafc;
            --dim: #94a3b8; --border: rgba(255, 255, 255, 0.06);
            --success: #22c55e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; overflow: hidden; }

        /* --- AUTH & PROFILE SCREENS --- */
        .full-modal { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { width: 100%; max-width: 400px; background: var(--side); padding: 35px; border-radius: 28px; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); }

        /* --- LAYOUT --- */
        #sidebar { width: 380px; background: var(--side); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        /* --- HEADERS --- */
        .top-bar { height: 70px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(15,15,19,0.8); backdrop-filter: blur(12px); }
        .user-thumb { width: 42px; height: 42px; border-radius: 14px; object-fit: cover; background: var(--purple); cursor: pointer; border: 1px solid var(--border); }

        /* --- LISTS --- */
        .item { padding: 14px 20px; display: flex; align-items: center; gap: 14px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .item:hover { background: rgba(255,255,255,0.03); }
        .avatar-box { position: relative; }
        .status-dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--side); background: #4b5563; }
        .online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* --- MESSAGES --- */
        #msg-container { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 6px; }
        .bubble { max-width: 70%; padding: 10px 16px; border-radius: 18px; font-size: 14.5px; line-height: 1.5; position: relative; }
        .sent { align-self: flex-end; background: var(--purple); color: white; border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--panel); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .ticks { font-size: 11px; margin-left: 6px; float: right; margin-top: 4px; opacity: 0.7; }

        /* --- INPUT --- */
        .input-box { padding: 20px; background: var(--bg); display: flex; gap: 12px; }
        .field { flex: 1; padding: 12px 18px; background: var(--panel); border: 1px solid var(--border); border-radius: 14px; color: white; outline: none; transition: 0.2s; }
        .field:focus { border-color: var(--purple); background: var(--side); }

        /* --- FLOATING BUTTON --- */
        .fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background: var(--purple); border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 10px 25px rgba(99,102,241,0.4); z-index: 200; }

        .hidden { display: none !important; }
        @media (max-width: 768px) { #sidebar { width: 100%; position: absolute; } #sidebar.collapsed { transform: translateX(-100%); } }
    </style>
</head>
<body>

<div id="auth-screen" class="full-modal">
    <div class="card">
        <h2 style="margin-bottom: 10px; font-weight: 700;">Bem-vindo</h2>
        <p style="color: var(--dim); margin-bottom: 25px; font-size: 14px;">Inicie sua sess√£o segura.</p>
        <input type="text" id="login-id" class="field" placeholder="Nickname √önico" style="width:100%; margin-bottom:15px;">
        <button onclick="login()" class="field" style="background:var(--purple); font-weight:600; cursor:pointer; border:none;">Acessar Plataforma</button>
    </div>
</div>

<div id="profile-screen" class="full-modal hidden">
    <div class="card">
        <h3 style="margin-bottom: 20px;">Editar Perfil</h3>
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="p-preview" src="https://ui-avatars.com/api/?background=6366f1&color=fff&name=User" class="user-thumb" style="width:100px; height:100px; border-radius:30px;">
            <input type="text" id="p-img" class="field" placeholder="URL da Foto" style="margin-top:15px; font-size:12px;">
        </div>
        <input type="text" id="p-status" class="field" placeholder="Recado (Status)" style="width:100%; margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button onclick="saveProfile()" class="field" style="background:var(--purple); border:none;">Salvar</button>
            <button onclick="toggleProfile(false)" class="field" style="background:var(--panel); border:none;">Voltar</button>
        </div>
    </div>
</div>

<aside id="sidebar">
    <div class="top-bar">
        <img id="my-avatar" src="" class="user-thumb" onclick="toggleProfile(true)">
        <h4 style="font-weight: 700; flex:1; margin-left:12px;" id="my-nick-display">...</h4>
        <button onclick="logout()" style="background:none; border:none; color:var(--dim); font-size:20px;">üö™</button>
    </div>
    <div style="padding: 15px;">
        <input type="text" id="friend-search" class="field" placeholder="Buscar @nickname..." onkeyup="if(event.key==='Enter') addFriend()">
    </div>
    <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
</aside>

<main id="chat-main">
    <header class="top-bar">
        <div style="display:flex; align-items:center; gap:12px;">
            <button onclick="toggleSidebar(true)" id="back-btn" style="display:none; background:none; border:none; color:white; font-size:22px;">‚Üê</button>
            <img id="active-avatar" src="" class="user-thumb" style="width:38px; height:38px; display:none;">
            <div>
                <h4 id="active-name">Cris√°lida PRO</h4>
                <span id="active-status-text" style="font-size:11px; color:var(--dim);">Offline</span>
            </div>
        </div>
        <button onclick="copyInvite()" class="field" style="background:var(--panel); border:none; padding:8px 15px; font-size:12px;">üîó Convite</button>
    </header>

    <div id="msg-container"></div>

    <div class="input-box">
        <input type="text" id="msg-input" class="field" placeholder="Escreva uma mensagem..." onkeydown="if(event.key==='Enter') send()">
        <button onclick="send()" class="field" style="background:var(--purple); border:none; width:60px; flex:none;">üöÄ</button>
    </div>
</main>

<button class="fab" onclick="document.getElementById('friend-search').focus()">+</button>

<script>
    let peer, myId, activePeer = null, connMap = {};
    let db = {
        me: JSON.parse(localStorage.getItem('c_pro_me') || '{"img":"","status":"No Cris√°lida"}'),
        history: JSON.parse(localStorage.getItem('c_pro_history') || '{}'),
        friends: JSON.parse(localStorage.getItem('c_pro_friends') || '{}') // Armazena info do perfil dos amigos
    };

    // --- AUTH & PROFILE ---
    function login() {
        const id = document.getElementById('login-id').value.trim().toLowerCase();
        if(!id) return;
        localStorage.setItem('c_pro_user', id);
        location.reload();
    }

    function logout() { localStorage.removeItem('c_pro_user'); location.reload(); }

    function toggleProfile(show) {
        document.getElementById('profile-screen').classList.toggle('hidden', !show);
        if(show) {
            document.getElementById('p-img').value = db.me.img;
            document.getElementById('p-status').value = db.me.status;
            document.getElementById('p-preview').src = db.me.img || `https://ui-avatars.com/api/?background=6366f1&color=fff&name=${myId}`;
        }
    }

    function saveProfile() {
        db.me.img = document.getElementById('p-img').value;
        db.me.status = document.getElementById('p-status').value;
        localStorage.setItem('c_pro_me', JSON.stringify(db.me));
        toggleProfile(false);
        updateMyUI();
        // Avisar conex√µes ativas sobre a mudan√ßa
        Object.values(connMap).forEach(c => c.send({type:'profile_update', profile: db.me}));
    }

    function updateMyUI() {
        document.getElementById('my-avatar').src = db.me.img || `https://ui-avatars.com/api/?background=6366f1&color=fff&name=${myId}`;
        document.getElementById('my-nick-display').innerText = myId;
    }

    // --- PEER CORE ---
    window.onload = () => {
        myId = localStorage.getItem('c_pro_user');
        if(myId) {
            document.getElementById('auth-screen').classList.add('hidden');
            updateMyUI();
            initPeer();
        }
    };

    function initPeer() {
        peer = new Peer(myId);
        peer.on('open', () => {
            renderChatList();
            Object.keys(db.history).forEach(id => tryConnect(id));
        });
        peer.on('connection', c => setupConn(c));
    }

    function tryConnect(id) {
        if(connMap[id]) return;
        setupConn(peer.connect(id));
    }

    function setupConn(c) {
        connMap[c.peer] = c;
        c.on('open', () => {
            if(activePeer === c.peer) updateStatusUI(true);
            c.send({type:'profile_update', profile: db.me}); // Troca de perfil
            syncMessages(c);
        });
        c.on('data', data => {
            if(data.type === 'msg') {
                handleIncomingMsg(c.peer, data);
                c.send({type: 'ack', id: data.id});
            } else if(data.type === 'ack') {
                handleAck(c.peer, data.id);
            } else if(data.type === 'profile_update') {
                db.friends[c.peer] = data.profile;
                localStorage.setItem('c_pro_friends', JSON.stringify(db.friends));
                renderChatList();
                if(activePeer === c.peer) updateHeaderUI(c.peer);
            }
        });
        c.on('close', () => {
            if(activePeer === c.peer) updateStatusUI(false);
            delete connMap[c.peer];
        });
    }

    // --- MESSAGING ---
    function send() {
        const input = document.getElementById('msg-input');
        if(!input.value || !activePeer) return;

        const msg = {
            id: Date.now() + Math.random(),
            type: 'msg',
            from: myId,
            text: input.value,
            read: false, // O primeiro tick "enviado" √© autom√°tico na UI
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        };

        if(!db.history[activePeer]) db.history[activePeer] = [];
        db.history[activePeer].push(msg);
        
        const c = connMap[activePeer];
        if(c && c.open) c.send(msg); else tryConnect(activePeer);

        save(); renderChat(); renderChatList();
        input.value = "";
    }

    function handleIncomingMsg(from, msg) {
        if(!db.history[from]) db.history[from] = [];
        if(!db.history[from].find(m => m.id === msg.id)) {
            db.history[from].push({...msg, read: true});
            save();
            if(activePeer === from) renderChat();
            renderChatList();
        }
    }

    function handleAck(from, id) {
        const m = db.history[from]?.find(m => m.id === id);
        if(m) { m.read = true; save(); if(activePeer === from) renderChat(); }
    }

    function syncMessages(c) {
        const pendentes = (db.history[c.peer] || []).filter(m => m.from === myId && !m.read);
        pendentes.forEach(m => c.send(m));
    }

    // --- UI RENDERING ---
    function openChat(id) {
        activePeer = id;
        updateHeaderUI(id);
        if(window.innerWidth < 768) toggleSidebar(false);
        renderChat();
        tryConnect(id);
    }

    function updateHeaderUI(id) {
        const f = db.friends[id] || {img: '', status: '...'}
        document.getElementById('active-name').innerText = id;
        document.getElementById('active-status-text').innerText = f.status;
        const img = document.getElementById('active-avatar');
        img.src = f.img || `https://ui-avatars.com/api/?background=6366f1&color=fff&name=${id}`;
        img.style.display = 'block';
        updateStatusUI(!!connMap[id]);
    }

    function updateStatusUI(isOnline) {
        const s = document.getElementById('active-status-text');
        if(isOnline) { s.innerText = "Online agora"; s.style.color = "var(--success)"; }
        else { s.innerText = (db.friends[activePeer]?.status || "Offline"); s.style.color = "var(--dim)"; }
    }

    function renderChat() {
        const box = document.getElementById('msg-container');
        box.innerHTML = "";
        (db.history[activePeer] || []).forEach(m => {
            const isMe = m.from === myId;
            const ticks = isMe ? (m.read ? '‚úì‚úì' : '‚úì') : '';
            box.innerHTML += `<div class="bubble ${isMe ? 'sent' : 'received'}">${m.text}<span class="ticks">${ticks}</span></div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function renderChatList() {
        const list = document.getElementById('chat-list');
        list.innerHTML = "";
        Object.keys(db.history).sort((a,b) => (db.history[b].slice(-1)[0]?.id || 0) - (db.history[a].slice(-1)[0]?.id || 0)).forEach(id => {
            const last = db.history[id].slice(-1)[0];
            const f = db.friends[id] || {};
            const isOnline = connMap[id]?.open;
            list.innerHTML += `
                <div class="item" onclick="openChat('${id}')">
                    <div class="avatar-box">
                        <img src="${f.img || `https://ui-avatars.com/api/?background=6366f1&color=fff&name=${id}`}" class="user-thumb">
                        <div class="status-dot ${isOnline ? 'online' : ''}"></div>
                    </div>
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between"><b>${id}</b> <span style="font-size:10px; color:var(--dim)">${last?.time || ''}</span></div>
                        <p style="font-size:12px; color:var(--dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${last?.text || 'Sem mensagens'}</p>
                    </div>
                </div>`;
        });
    }

    function addFriend() {
        const nick = document.getElementById('friend-search').value.trim().toLowerCase();
        if(nick && nick !== myId) {
            if(!db.history[nick]) db.history[nick] = [];
            openChat(nick);
            document.getElementById('friend-search').value = "";
        }
    }

    function save() { localStorage.setItem('c_pro_history', JSON.stringify(db.history)); }
    function toggleSidebar(show) {
        document.getElementById('sidebar').classList.toggle('collapsed', !show);
        document.getElementById('back-btn').style.display = show ? 'none' : 'block';
    }
    function copyInvite() {
        navigator.clipboard.writeText(window.location.origin + window.location.pathname + "?u=" + myId);
        alert("Link de perfil copiado!");
    }
</script>
</body>
</html>
