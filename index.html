<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRIS√ÅLIDA | GAMER OS</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #050505;
            --bg-side: #0d0d0f;
            --bg-panel: #121214;
            --accent: #00ff9d; /* Verde Gamer */
            --purple: #8a2be2;
            --text-primary: #e0e0e0;
            --text-dim: #71717a;
            --border: rgba(255, 255, 255, 0.05);
            --msg-sent: #054640;
            --msg-received: #202024;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-main); color: var(--text-primary); height: 100dvh; display: flex; overflow: hidden; }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; inset: 0; background: var(--bg-main); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 380px; background: var(--bg-side); padding: 40px; border-radius: 24px; border: 1px solid var(--accent); text-align: center; box-shadow: 0 0 30px rgba(0, 255, 157, 0.1); }
        .auth-card h1 { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--accent); margin-bottom: 20px; letter-spacing: -1px; }

        /* --- LAYOUT WHATSAPP STYLE --- */
        #app-container { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR (LISTA DE CHATS) */
        #sidebar { width: 400px; min-width: 320px; background: var(--bg-side); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; }
        .sidebar-header { height: 64px; padding: 10px 16px; background: var(--bg-side); display: flex; align-items: center; justify-content: space-between; }
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); cursor: pointer; }
        
        .search-area { padding: 8px 14px; border-bottom: 1px solid var(--border); }
        .search-box { width: 100%; padding: 10px 16px; background: var(--bg-panel); border: none; border-radius: 8px; color: white; outline: none; font-size: 14px; }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 16px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .chat-item:hover { background: var(--bg-panel); }
        .chat-item.active { background: #2a2a2e; }
        .chat-item .avatar { width: 50px; height: 50px; border-radius: 50%; background: #2a2a2e; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .chat-item .info { flex: 1; min-width: 0; }
        .chat-item .info .top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-item .info h4 { font-size: 16px; font-weight: 500; }
        .chat-item .info p { font-size: 13px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* MAIN CHAT AREA */
        #main-content { flex: 1; display: flex; flex-direction: column; background: #0b0b0d; background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 20px 20px; }
        .chat-header { height: 64px; padding: 10px 16px; background: var(--bg-side); display: flex; align-items: center; border-bottom: 1px solid var(--border); z-index: 10; }
        
        #messages-flow { flex: 1; overflow-y: auto; padding: 20px 5%; display: flex; flex-direction: column; gap: 4px; }
        
        /* BUBBLES */
        .bubble { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14.5px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .sent { align-self: flex-end; background: var(--msg-sent); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--msg-received); border-top-left-radius: 0; }
        .bubble-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px; }
        .tick-blue { color: #53bdeb; }

        /* INPUT AREA */
        .input-bar { min-height: 62px; padding: 10px 16px; background: var(--bg-side); display: flex; align-items: center; gap: 12px; }
        .text-input { flex: 1; padding: 12px 16px; background: var(--bg-panel); border: none; border-radius: 8px; color: white; outline: none; font-size: 15px; }

        /* PROFILE MODAL */
        #profile-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items: center; justify-content: center; }
        
        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            #sidebar { width: 100%; min-width: 100%; position: absolute; z-index: 50; }
            #sidebar.hidden { transform: translateX(-100%); }
            .bubble { max-width: 85%; }
        }

        .hidden { display: none !important; }
        .btn-icon { background: none; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer; padding: 8px; }
        .btn-icon:hover { color: var(--accent); }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h1>CRIS√ÅLIDA_OS</h1>
        <input type="text" id="login-id" class="search-box" placeholder="DIGITE SEU NICKNAME" style="margin-bottom: 15px; text-align: center; border: 1px solid var(--border);">
        <button onclick="doLogin()" style="width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 8px; font-weight: 800; cursor: pointer; color: black;">BOOT SYSTEM</button>
    </div>
</div>

<div id="profile-modal">
    <div class="auth-card">
        <h2 style="color: var(--accent); margin-bottom: 20px;">PERFIL DO USU√ÅRIO</h2>
        <input type="text" id="p-img" class="search-box" placeholder="URL DA FOTO">
        <input type="text" id="p-status" class="search-box" placeholder="RECADO" style="margin-top:10px;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="saveProfile()" style="flex:1; padding:10px; background:var(--accent); border:none; border-radius:8px; font-weight:700; cursor:pointer;">SALVAR</button>
            <button onclick="closeProfile()" style="flex:1; padding:10px; background:#333; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">FECHAR</button>
        </div>
    </div>
</div>

<div id="app-container">
    <aside id="sidebar">
        <div class="sidebar-header">
            <img id="my-avatar" src="https://ui-avatars.com/api/?background=202024&color=fff&name=?" class="my-avatar" onclick="openProfile()">
            <div style="display:flex;">
                <button class="btn-icon" onclick="copyMyLink()">üîó</button>
                <button class="btn-icon" onclick="doLogout()">üö™</button>
            </div>
        </div>
        
        <div class="search-area">
            <input type="text" id="add-friend-input" class="search-box" placeholder="Procurar ou come√ßar conversa..." onkeyup="if(event.key==='Enter') addFriend()">
        </div>

        <div id="chat-list" class="chat-list">
            </div>
    </aside>

    <main id="main-content">
        <header class="chat-header">
            <button id="back-btn" class="btn-icon hidden" onclick="toggleSidebar(true)">‚Üê</button>
            <div id="active-info" style="display:flex; align-items:center; gap:12px; margin-left:10px;">
                <div id="active-avatar-circle" class="avatar" style="width:40px; height:40px; font-size:14px; background: #202024; border-radius: 50%; display: flex; align-items:center; justify-content:center;">?</div>
                <div>
                    <h4 id="active-nick">Selecione uma conversa</h4>
                    <p id="active-status" style="font-size:12px; color:var(--text-dim);">Clique em um contato para iniciar</p>
                </div>
            </div>
        </header>

        <div id="messages-flow">
            </div>

        <div class="input-bar hidden" id="chat-input-area">
            <button class="btn-icon">üòä</button>
            <input type="text" id="main-input" class="text-input" placeholder="Mensagem" onkeydown="if(event.key==='Enter') send()">
            <button class="btn-icon" onclick="send()" style="color:var(--accent)">‚û§</button>
        </div>
    </main>
</div>

<script>
    let peer, myId, activePeer = null;
    let connections = {};
    let db = {
        me: JSON.parse(localStorage.getItem('cris_me_v5') || '{"img":"","status":"Dispon√≠vel"}'),
        history: JSON.parse(localStorage.getItem('cris_history_v5') || '{}'),
        friends: JSON.parse(localStorage.getItem('cris_friends_v5') || '{}')
    };

    // --- BOOT ---
    function doLogin() {
        const id = document.getElementById('login-id').value.trim().toLowerCase();
        if(!id) return;
        localStorage.setItem('cris_user_v5', id);
        location.reload();
    }

    function doLogout() { localStorage.removeItem('cris_user_v5'); location.reload(); }

    window.onload = () => {
        myId = localStorage.getItem('cris_user_v5');
        if(myId) {
            document.getElementById('auth-screen').classList.add('hidden');
            initPeer();
            updateMyUI();
        }
    };

    function initPeer() {
        peer = new Peer(myId, { debug: 1 });
        peer.on('open', () => {
            renderChatList();
            checkUrlParams();
            // Tenta conectar com todos do hist√≥rico para sync
            Object.keys(db.history).forEach(id => connectTo(id));
        });
        peer.on('connection', conn => handleConn(conn));
    }

    // --- LOGICA DE CONEX√ÉO ---
    function connectTo(id) {
        if(connections[id]) return;
        handleConn(peer.connect(id));
    }

    function handleConn(conn) {
        connections[conn.peer] = conn;
        conn.on('open', () => {
            conn.send({type: 'profile', data: db.me});
            syncPending(conn);
            if(activePeer === conn.peer) document.getElementById('active-status').innerText = "Online";
            renderChatList();
        });
        conn.on('data', data => {
            if(data.type === 'msg') {
                receiveMsg(conn.peer, data);
                conn.send({type: 'ack', id: data.id});
            } else if(data.type === 'ack') {
                updateTick(conn.peer, data.id);
            } else if(data.type === 'profile') {
                db.friends[conn.peer] = data.data;
                save(); renderChatList();
                if(activePeer === conn.peer) updateHeader(conn.peer);
            }
        });
        conn.on('close', () => {
            delete connections[conn.peer];
            if(activePeer === conn.peer) document.getElementById('active-status').innerText = "Offline";
            renderChatList();
        });
    }

    // --- MENSAGENS ---
    function send() {
        const input = document.getElementById('main-input');
        const text = input.value.trim();
        if(!text || !activePeer) return;

        const msg = {
            id: Date.now() + Math.random(),
            type: 'msg',
            from: myId,
            text: text,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            read: false
        };

        if(!db.history[activePeer]) db.history[activePeer] = [];
        db.history[activePeer].push(msg);
        
        const c = connections[activePeer];
        if(c && c.open) c.send(msg); else connectTo(activePeer);

        input.value = "";
        save(); renderMessages(); renderChatList();
    }

    function receiveMsg(from, msg) {
        if(!db.history[from]) db.history[from] = [];
        if(!db.history[from].find(m => m.id === msg.id)) {
            db.history[from].push({...msg, read: true});
            save();
            if(activePeer === from) renderMessages();
            renderChatList();
        }
    }

    function syncPending(conn) {
        const p = (db.history[conn.peer] || []).filter(m => m.from === myId && !m.read);
        p.forEach(m => conn.send(m));
    }

    function updateTick(from, id) {
        const m = db.history[from]?.find(x => x.id === id);
        if(m) { m.read = true; save(); if(activePeer === from) renderMessages(); }
    }

    // --- UI RENDERING ---
    function renderChatList() {
        const list = document.getElementById('chat-list');
        list.innerHTML = "";
        const sorted = Object.keys(db.history).sort((a,b) => {
            const la = db.history[a].slice(-1)[0]?.id || 0;
            const lb = db.history[b].slice(-1)[0]?.id || 0;
            return lb - la;
        });

        sorted.forEach(id => {
            const last = db.history[id].slice(-1)[0];
            const f = db.friends[id] || {};
            const online = connections[id]?.open;
            const item = document.createElement('div');
            item.className = `chat-item ${activePeer === id ? 'active' : ''}`;
            item.onclick = () => openChat(id);
            item.innerHTML = `
                <div class="avatar" style="border: 2px solid ${online ? 'var(--accent)' : 'transparent'}">
                    ${f.img ? `<img src="${f.img}" style="width:100%;height:100%;border-radius:50%">` : id[0].toUpperCase()}
                </div>
                <div class="info">
                    <div class="top"><h4>${id}</h4> <span class="time">${last?.time || ''}</span></div>
                    <p>${last?.text || ''}</p>
                </div>
            `;
            list.appendChild(item);
        });
    }

    function openChat(id) {
        activePeer = id;
        document.getElementById('chat-input-area').classList.remove('hidden');
        if(window.innerWidth <= 768) toggleSidebar(false);
        updateHeader(id);
        renderMessages();
        renderChatList();
        connectTo(id);
    }

    function updateHeader(id) {
        const f = db.friends[id] || {};
        document.getElementById('active-nick').innerText = id;
        document.getElementById('active-status').innerText = connections[id] ? "Online" : (f.status || "Offline");
        const av = document.getElementById('active-avatar-circle');
        av.innerHTML = f.img ? `<img src="${f.img}" style="width:100%;height:100%;border-radius:50%">` : id[0].toUpperCase();
    }

    function renderMessages() {
        const flow = document.getElementById('messages-flow');
        flow.innerHTML = "";
        (db.history[activePeer] || []).forEach(m => {
            const isMe = m.from === myId;
            const bubble = document.createElement('div');
            bubble.className = `bubble ${isMe ? 'sent' : 'received'}`;
            bubble.innerHTML = `
                ${m.text}
                <div class="bubble-meta">
                    ${m.time} ${isMe ? `<span class="${m.read ? 'tick-blue' : ''}">${m.read ? '‚úì‚úì' : '‚úì'}</span>` : ''}
                </div>
            `;
            flow.appendChild(bubble);
        });
        flow.scrollTop = flow.scrollHeight;
    }

    // --- PROPRIEDADES ---
    function openProfile() { document.getElementById('profile-modal').style.display = 'flex'; }
    function closeProfile() { document.getElementById('profile-modal').style.display = 'none'; }
    function saveProfile() {
        db.me.img = document.getElementById('p-img').value;
        db.me.status = document.getElementById('p-status').value;
        save(); updateMyUI(); closeProfile();
        Object.values(connections).forEach(c => c.send({type:'profile', data: db.me}));
    }
    function updateMyUI() {
        document.getElementById('my-avatar').src = db.me.img || `https://ui-avatars.com/api/?background=202024&color=fff&name=${myId}`;
    }

    // --- UTIL ---
    function toggleSidebar(show) {
        document.getElementById('sidebar').classList.toggle('hidden', !show);
        document.getElementById('back-btn').classList.toggle('hidden', show);
    }
    function addFriend() {
        const nick = document.getElementById('add-friend-input').value.trim().toLowerCase();
        if(nick && nick !== myId) {
            if(!db.history[nick]) db.history[nick] = [];
            openChat(nick);
            document.getElementById('add-friend-input').value = "";
        }
    }
    function save() {
        localStorage.setItem('cris_me_v5', JSON.stringify(db.me));
        localStorage.setItem('cris_history_v5', JSON.stringify(db.history));
        localStorage.setItem('cris_friends_v5', JSON.stringify(db.friends));
    }
    function copyMyLink() {
        const url = window.location.origin + window.location.pathname + "?u=" + myId;
        navigator.clipboard.writeText(url);
        alert("Link de contato copiado!");
    }
    function checkUrlParams() {
        const u = new URLSearchParams(window.location.search).get('u');
        if(u && u !== myId) addFriend(u);
    }
</script>
</body>
</html>
