<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Crimson">
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/106/106195.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/106/106195.png">
    
    <title>CRIMSON | ENTERPRISE</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <div style="margin-bottom: 40px; text-align: center;">
            <i class="ri-shield-keyhole-fill" style="font-size: 64px; color: var(--primary);"></i>
            <h1 style="font-size: 28px; font-weight: 800;">CRIMSON</h1>
            <p style="color: var(--text-dim); font-size: 14px;">ENTERPRISE EDITION</p>
        </div>
        <div class="auth-content">
            <input type="text" id="auth-id" class="field" placeholder="Usuﾃ｡rio (ID)" style="text-align:center;">
            <input type="password" id="auth-pass" class="field" placeholder="Senha" style="text-align:center;">
            <button class="btn" onclick="sys.auth(false)">ENTRAR</button>
            <button class="btn" onclick="sys.auth(true)" style="background: var(--card); border: 1px solid var(--border);">CRIAR CONTA</button>
        </div>
    </div>

    <header>
        <div class="user-meta" onclick="sys.openView('view-me')">
            <div class="avatar" id="header-av"></div>
            <div>
                <div id="header-name" style="font-weight: 700; font-size: 15px;">...</div>
                <div id="connection-status" style="font-size: 11px; color: var(--text-dim); font-weight: 700;">OFFLINE</div>
            </div>
        </div>
        <i class="ri-settings-4-line" style="font-size: 24px; color: var(--text-dim);" onclick="sys.openView('view-me')"></i>
    </header>

    <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
    
    <div class="fab-menu" id="fab-menu">
        <div class="fab-item" onclick="sys.openView('view-create-group'); sys.toggleFab();">
            <span style="font-size:13px; font-weight:600; background:rgba(0,0,0,0.8); padding:4px 8px; border-radius:6px;">Novo Grupo</span>
            <div class="fab-btn-mini"><i class="ri-group-line"></i></div>
        </div>
        <div class="fab-item" onclick="sys.openView('view-add'); sys.toggleFab();">
            <span style="font-size:13px; font-weight:600; background:rgba(0,0,0,0.8); padding:4px 8px; border-radius:6px;">Novo Contato</span>
            <div class="fab-btn-mini"><i class="ri-user-add-line"></i></div>
        </div>
    </div>
    <div class="fab" onclick="sys.toggleFab()"><i class="ri-add-line" id="fab-icon" style="transition:0.3s"></i></div>

    <div id="view-chat" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeChat()" style="font-size: 28px; padding-right: 10px; cursor: pointer;"></i>
            <div style="flex:1; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="sys.showContact()">
                <div class="avatar" id="chat-av" style="width:36px; height:36px;"></div>
                <div>
                    <div id="chat-name" style="font-weight: 700; font-size: 15px;">Nome</div>
                    <div id="chat-status-text" style="font-size: 11px; color: var(--text-dim);">...</div>
                </div>
            </div>
            <div style="display:flex; gap:15px; font-size: 22px; color: var(--primary);">
                <i class="ri-phone-fill" onclick="sys.call(false)"></i>
                <i class="ri-vidicon-fill" onclick="sys.call(true)"></i>
            </div>
        </header>
        <div id="messages" class="chat-area"></div>
        
        <div class="input-bar">
            <input type="text" id="msg-input" class="field" placeholder="Mensagem..." oninput="sys.handleInput()">
            
            <button class="btn-action" id="btn-action" onclick="sys.handleAction()">
                <i class="ri-mic-fill" id="icon-mic"></i>
                <i class="ri-send-plane-fill" id="icon-send" style="display:none; transform: translateX(-2px) translateY(1px);"></i>
            </button>
        </div>
    </div>

    <div id="view-add" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-add')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Nova Conexﾃ｣o</h3>
        </header>
        <div style="padding: 30px;">
            <p style="color:var(--text-dim); margin-bottom:10px;">ID do Usuﾃ｡rio</p>
            <input type="text" id="target-id" class="field" style="margin-bottom: 20px;">
            <button class="btn" style="width:100%;" onclick="sys.addContact()">CONECTAR</button>
        </div>
    </div>

    <div id="view-create-group" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-create-group')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Novo Grupo</h3>
        </header>
        <div style="padding: 20px; flex:1; display:flex; flex-direction:column;">
            <input type="text" id="group-name-input" class="field" placeholder="Nome do Grupo" style="margin-bottom:20px;">
            <h4 style="color:var(--text-dim); margin-bottom:10px; font-size:12px;">SELECIONAR MEMBROS</h4>
            <div id="group-contact-list" style="flex:1; overflow-y:auto; border:1px solid var(--border); border-radius:12px; margin-bottom:20px;"></div>
            <button class="btn" style="width:100%;" onclick="sys.createGroup()">CRIAR GRUPO</button>
        </div>
    </div>

    <div id="view-me" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-me')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Editar Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="me-large-av"></div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">NOME DE EXIBIﾃﾃグ</label>
                <input type="text" id="edit-name" class="field" style="width:100%; margin-top:5px; background:var(--bg);">
            </div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">RECADO (BIO)</label>
                <input type="text" id="edit-bio" class="field" style="width:100%; margin-top:5px; background:var(--bg);">
            </div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px;">FOTO DE PERFIL (URL)</label>
                <input type="text" id="edit-pic" class="field" style="width:100%; margin-top:5px; background:var(--bg);" placeholder="https://...">
            </div>
            <button class="btn" style="width:100%; margin-top:30px;" onclick="sys.saveProfile()">SALVAR</button>
            <button class="btn" style="width:100%; margin-top:15px; background:transparent; border:1px solid #ff3b30; color:#ff3b30;" onclick="sys.logout()">SAIR DA CONTA</button>
        </div>
    </div>

    <div id="view-contact" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-contact')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="contact-large-av"></div>
            <h2 id="contact-real-name" style="margin-bottom:5px;">Nome</h2>
            <div id="contact-real-id" style="color:var(--primary); font-family:monospace; background:rgba(255,0,51,0.1); padding:4px 10px; border-radius:6px;">@id</div>
            <div class="info-box">
                <label style="color:var(--text-dim); font-size:12px; font-weight:bold;">RECADO</label>
                <p id="contact-real-bio" style="margin-top:10px; line-height:1.5; color:#fff;">...</p>
            </div>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="voice-info">
            <div class="voice-avatar-container">
                <div class="voice-avatar-pulse"></div>
                <img id="voice-call-img" src="" alt="User">
            </div>
            <div class="call-name" id="voice-call-name">Usuﾃ｡rio</div>
            <div class="call-status" id="voice-call-status">Chamada de Voz Crimsom</div>
        </div>
        <div class="call-controls">
            <button class="ctrl-btn" id="btn-mic" onclick="sys.toggleMic()"><i class="ri-mic-fill"></i></button>
            <button class="ctrl-btn" id="btn-speaker" onclick="sys.toggleSpeaker()"><i class="ri-volume-up-fill"></i></button>
            <button class="ctrl-btn end-call" onclick="sys.endCall()"><i class="ri-phone-fill" style="transform: rotate(135deg);"></i></button>
        </div>
    </div>
</div>

<script>
const manifest = {
  "name": "Crimson Enterprise",
  "short_name": "Crimson",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#000000",
  "orientation": "portrait",
  "icons": [
    { "src": "https://cdn-icons-png.flaticon.com/512/106/106195.png", "sizes": "192x192", "type": "image/png" }
  ]
};
const link = document.createElement('link');
link.rel = 'manifest';
link.href = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
document.head.appendChild(link);

const sys = {
    ws: null,
    serverUrl: 'wss://serverweb-3zfo.onrender.com', 
    peer: null,
    uid: null,
    db: {}, 
    activeConns: {}, 
    currentChat: null,
    callStream: null,
    incomingCall: null,
    isVoiceOnly: false,
    fabOpen: false,
    selectedGroupMembers: [],
    micEnabled: true,
    speakerEnabled: true,
    statusInterval: null,
    audioRecorder: null,
    audioChunks: [],
    canSendText: false,

    init() {
        const raw = localStorage.getItem('crimson_db');
        this.db = raw ? JSON.parse(raw) : {};
        const session = localStorage.getItem('crimson_session');
        
        if(session && this.db[session]) {
            this.uid = session;
            this.startApp();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
        
        document.getElementById('msg-input').onkeydown = (e) => {
            if(e.key === 'Enter') this.send();
        };
    },

    auth(isRegister) {
        const id = document.getElementById('auth-id').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value.trim();
        if(id.length < 3 || pass.length < 3) return alert("Mﾃｭnimo 3 caracteres");

        if(isRegister) {
            if(this.db[id]) return alert("ID jﾃ｡ existe");
            this.db[id] = { pass, name: id, bio: "Crimson User", pic: "", friends: {}, groups: {}, pending: {} };
            this.saveDb();
            alert("Conta criada! Clique em Entrar.");
        } else {
            if(!this.db[id] || this.db[id].pass !== pass) return alert("Credenciais invﾃ｡lidas");
            this.uid = id;
            if(!this.db[id].pending) this.db[id].pending = {}; 
            localStorage.setItem('crimson_session', id);
            this.startApp();
        }
    },

    startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        this.setupPeer();
        this.connectServer();
        this.updateHeader();
        this.renderHome();
        
        this.statusInterval = setInterval(() => {
            if(this.currentChat && !this.currentChat.startsWith('group_')) {
                this.updateChatStatusUI(this.currentChat);
            }
        }, 60000);
    },

    logout() {
        localStorage.removeItem('crimson_session');
        location.reload();
    },

    saveDb() {
        localStorage.setItem('crimson_db', JSON.stringify(this.db));
    },

    connectServer() {
        try {
            this.ws = new WebSocket(this.serverUrl);
            
            this.ws.onopen = () => {
                console.log('Server Connected');
                this.ws.send(JSON.stringify({ type: 'auth', id: this.uid }));
                document.getElementById('connection-status').innerText = 'ONLINE';
                document.getElementById('connection-status').style.color = 'var(--primary)';
            };

            this.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.handleServerData(data);
                } catch(e) { console.error("Bad JSON", e); }
            };

            this.ws.onclose = () => {
                console.log('Server Disconnected... Trying to reconnect');
                document.getElementById('connection-status').innerText = 'CONECTANDO...';
                document.getElementById('connection-status').style.color = 'var(--text-dim)';
                setTimeout(() => this.connectServer(), 3000);
            };
        } catch (e) {
            console.log("Erro ao conectar WS:", e);
        }
    },

    handleServerData(data) {
        if(data.type === 'receipt') {
            if(data.status === 'sent') this.markAsSent(this.currentChat, data.msgId); 
            if(data.status === 'delivered') this.markAsDelivered(this.currentChat, data.msgId); 
            return;
        }

        if(data.type === 'msg' || data.type === 'audio') {
            const msgType = data.type === 'audio' ? 'audio' : 'text';
            const sender = data.senderId;

            if(data.groupId) {
                this.handleGroupMessage(data);
            } else {
                // CORREﾃﾃグ OFFLINE: Se o remetente nﾃ｣o existe, cria ele no DB local
                if(!this.db[this.uid].friends[sender]) {
                    this.db[this.uid].friends[sender] = { name: sender, history: [], bio: '', pic: '', lastSeen: Date.now() };
                }
                
                // Grava a mensagem no histﾃｳrico local imediatamente
                this.pushMessage(sender, sender, data.text, 'received', data.id, msgType);
                
                if(this.currentChat === sender) {
                    this.renderMessages();
                } else {
                    this.renderHome();
                }
            }
        }
    },

    setupPeer() {
        this.peer = new Peer(this.uid);
        this.peer.on('open', (id) => {
            console.log('PeerJS Online:', id);
            this.checkAndFlushPending(); 
        });

        this.peer.on('connection', (conn) => {
            this.setupConnectionEvents(conn);
        });

        this.peer.on('call', (call) => {
            if(confirm(`Chamada de ${call.peer}. Aceitar?`)) {
                this.incomingCall = call;
                this.answerCall();
            }
        });
    },

    setupConnectionEvents(conn) {
        this.activeConns[conn.peer] = conn;
        conn.on('open', () => {
            this.updateUserStatus(conn.peer, 'online');
            this.sendProfile(conn);
        });
        conn.on('data', (data) => this.handleData(conn.peer, data));
        conn.on('close', () => this.updateUserStatus(conn.peer, 'offline'));
        conn.on('error', () => this.updateUserStatus(conn.peer, 'offline'));
    },

    handleData(senderId, data) {
        if(data.type === 'receipt') {
            this.markAsDelivered(senderId, data.msgId);
            return;
        }

        if(data.type === 'sync') {
            if(!this.db[this.uid].friends[senderId]) {
                this.db[this.uid].friends[senderId] = { history: [], lastSeen: Date.now() };
            }
            const f = this.db[this.uid].friends[senderId];
            f.name = data.name; f.bio = data.bio; f.pic = data.pic;
            this.saveDb();
            this.renderHome();
            if(this.currentChat === senderId) this.updateChatHeader(senderId);
            return;
        }
        
        if(data.type === 'call_type' && data.mode === 'voice') {
            this.isVoiceOnly = true;
            this.updateCallUI();
            return;
        }

        if(data.type === 'msg' || data.type === 'audio') {
            const conn = this.activeConns[senderId];
            if(conn && conn.open) conn.send({ type: 'receipt', msgId: data.id });

            if(data.groupId) {
                this.handleGroupMessage(data);
            } else {
                const msgType = data.type === 'audio' ? 'audio' : 'text';
                this.pushMessage(senderId, senderId, data.text, 'received', data.id, msgType);
                if(this.currentChat === senderId) this.renderMessages();
                else this.renderHome();
            }
        }
    },

    send(content = null, type = 'text') {
        let text = content;
        const input = document.getElementById('msg-input');
        
        if(!text) {
            text = input.value.trim();
            input.value = '';
            this.handleInput(); 
        }
        
        const target = this.currentChat;
        if(!text || !target) return;

        const msgId = Date.now() + Math.random().toString(36).substr(2, 9);
        
        if(target.startsWith('group_')) {
            this.sendGroupMsg(target, text, type, msgId);
        } else {
            this.pushMessage(target, this.uid, text, 'queued', msgId, type);
            this.renderMessages();
            
            if(this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify({
                    type: type === 'text' ? 'msg' : type,
                    targetId: target,
                    senderId: this.uid,
                    text: text,
                    id: msgId
                }));
            } else {
                const payload = { type: type === 'audio' ? 'audio' : 'msg', text, id: msgId };
                this.sendMessageToPeer(target, payload);
            }
        }
        this.renderHome();
    },

    sendGroupMsg(groupId, text, type, msgId) {
        const grp = this.db[this.uid].groups[groupId];
        grp.history.push({ sender: this.uid, text, time: Date.now(), status: 'sent', id: msgId, type });
        this.saveDb();
        this.renderMessages();

        if(this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({
                type: type === 'text' ? 'msg' : type,
                groupId: groupId,
                senderId: this.uid,
                text: text,
                id: msgId,
                groupName: grp.name,
                members: grp.members 
            }));
        } else {
            grp.members.forEach(memberId => {
                if(memberId !== this.uid) {
                    this.sendMessageToPeer(memberId, { 
                        type: type === 'audio' ? 'audio' : 'msg',
                        text, 
                        id: msgId, 
                        groupId: groupId, 
                        groupName: grp.name, 
                        senderId: this.uid 
                    });
                }
            });
        }
    },

    sendMessageToPeer(targetId, payload) {
        if(this.activeConns[targetId] && this.activeConns[targetId].open) {
            this.activeConns[targetId].send(payload);
            if(!payload.groupId) this.markAsSent(targetId, payload.id);
        } else {
            this.queueMessage(targetId, payload);
            const conn = this.peer.connect(targetId);
            this.setupConnectionEvents(conn);
        }
    },

    pushMessage(friendId, senderId, text, status, id, type='text') {
        if(!this.db[this.uid].friends[friendId]) {
            this.db[this.uid].friends[friendId] = { history: [], lastSeen: Date.now() };
        }
        const hist = this.db[this.uid].friends[friendId].history;
        const exists = hist.find(m => m.id === id);
        if(exists) return; 

        hist.push({ sender: senderId, text, time: Date.now(), status, id, type });
        this.saveDb();
    },

    handleGroupMessage(data) {
        let groups = this.db[this.uid].groups || {};
        const gid = data.groupId;
        if(!groups[gid]) {
            groups[gid] = { name: data.groupName || 'Grupo', members: data.members || [], history: [] };
        }
        const exists = groups[gid].history.find(m => m.id === data.id);
        if(exists) return;

        const type = data.type === 'audio' ? 'audio' : 'text';
        groups[gid].history.push({
            sender: data.senderId, text: data.text, time: Date.now(), status: 'read', id: data.id, type
        });
        this.db[this.uid].groups = groups;
        this.saveDb();
        if(this.currentChat === gid) this.renderMessages();
        else this.renderHome();
    },

    handleInput() {
        const input = document.getElementById('msg-input');
        const micIcon = document.getElementById('icon-mic');
        const sendIcon = document.getElementById('icon-send');
        if(input.value.trim().length > 0) {
            this.canSendText = true;
            micIcon.style.display = 'none';
            sendIcon.style.display = 'block';
        } else {
            this.canSendText = false;
            micIcon.style.display = 'block';
            sendIcon.style.display = 'none';
        }
    },

    handleAction() {
        if(this.canSendText) this.send();
        else this.toggleVoiceMsg();
    },

    async toggleVoiceMsg() {
        const btn = document.getElementById('btn-action');
        if(!this.audioRecorder) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.audioRecorder = new MediaRecorder(stream);
                this.audioChunks = [];
                this.audioRecorder.ondataavailable = e => this.audioChunks.push(e.data);
                this.audioRecorder.onstop = () => {
                    const blob = new Blob(this.audioChunks, { type: 'audio/webm;codecs=opus' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result; 
                        this.send(base64, 'audio');
                    };
                    reader.readAsDataURL(blob);
                    stream.getTracks().forEach(t => t.stop());
                    this.audioRecorder = null;
                };
                this.audioRecorder.start();
                btn.classList.add('recording');
            } catch(e) { alert("Erro ao acessar microfone."); }
        } else {
            this.audioRecorder.stop();
            btn.classList.remove('recording');
        }
    },

    toggleAudio(id) {
        const audio = document.getElementById(`audio-${id}`);
        const icon = document.getElementById(`btn-icon-${id}`);
        document.querySelectorAll('audio').forEach(a => {
            if(a.id !== `audio-${id}` && !a.paused) {
                a.pause();
                const otherId = a.id.replace('audio-','');
                const otherIcon = document.getElementById(`btn-icon-${otherId}`);
                if(otherIcon) otherIcon.className = 'ri-play-fill';
            }
        });
        if (audio.paused) { audio.play(); icon.className = 'ri-pause-fill'; }
        else { audio.pause(); icon.className = 'ri-play-fill'; }
    },

    resetAudio(id) {
        const audio = document.getElementById(`audio-${id}`);
        const icon = document.getElementById(`btn-icon-${id}`);
        const slider = document.getElementById(`slider-${id}`);
        audio.pause(); audio.currentTime = 0;
        icon.className = 'ri-play-fill'; slider.value = 0;
    },

    updateAudioUI(id) {
        const audio = document.getElementById(`audio-${id}`);
        const slider = document.getElementById(`slider-${id}`);
        const timeDisplay = document.getElementById(`time-${id}`);
        if (!isNaN(audio.duration)) {
            const percent = (audio.currentTime / audio.duration) * 100;
            slider.value = percent;
            timeDisplay.innerText = this.formatTime(audio.currentTime);
        }
    },

    seekAudio(id) {
        const audio = document.getElementById(`audio-${id}`);
        const slider = document.getElementById(`slider-${id}`);
        if (!isNaN(audio.duration)) {
            audio.currentTime = (slider.value / 100) * audio.duration;
        }
    },

    formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    },

    updateUserStatus(id, status) {
        if(!this.db[this.uid].friends[id]) return;
        const friend = this.db[this.uid].friends[id];
        friend.status = status;
        if(status === 'offline') friend.lastSeen = Date.now();
        this.saveDb();
        if(this.currentChat === id) this.updateChatStatusUI(id);
    },

    updateChatStatusUI(id) {
        if(id.startsWith('group_')) return;
        const f = this.db[this.uid].friends[id];
        const statusEl = document.getElementById('chat-status-text');
        if(this.activeConns[id] && this.activeConns[id].open) {
             statusEl.innerHTML = '<span class="online-dot"></span>Online';
             statusEl.className = 'status-online';
        } else {
            const ts = f.lastSeen || Date.now(); 
            const time = new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const date = new Date(ts).toLocaleDateString();
            statusEl.innerText = `Visto ${date === new Date().toLocaleDateString() ? 'hoje' : date} ﾃs ${time}`;
            statusEl.className = 'status-offline';
        }
    },

    markAsSent(friendId, msgId) {
        if(!friendId || friendId.startsWith('group_')) return;
        const f = this.db[this.uid].friends[friendId];
        if(f) {
            const msg = f.history.find(m => m.id === msgId);
            if(msg) { msg.status = 'sent'; this.saveDb(); if(this.currentChat === friendId) this.renderMessages(); }
        }
    },

    markAsDelivered(friendId, msgId) {
        if(!friendId || friendId.startsWith('group_')) return;
        const f = this.db[this.uid].friends[friendId];
        if(f) {
            const msg = f.history.find(m => m.id === msgId);
            if(msg) { msg.status = 'delivered'; this.saveDb(); if(this.currentChat === friendId) this.renderMessages(); }
        }
    },

    queueMessage(targetId, payload) {
        if(!this.db[this.uid].pending[targetId]) this.db[this.uid].pending[targetId] = [];
        this.db[this.uid].pending[targetId].push(payload);
        this.saveDb();
    },

    checkAndFlushPending() {
        Object.keys(this.db[this.uid].pending).forEach(targetId => {
            if(!this.activeConns[targetId] || !this.activeConns[targetId].open) {
                const conn = this.peer.connect(targetId);
                this.setupConnectionEvents(conn);
            }
        });
    },

    sendProfile(conn) {
        const me = this.db[this.uid];
        conn.send({ type: 'sync', name: me.name, bio: me.bio, pic: me.pic });
    },

    renderMessages() {
        const area = document.getElementById('messages');
        area.innerHTML = '';
        let msgs = [];
        if(this.currentChat && this.currentChat.startsWith('group_')) {
            msgs = this.db[this.uid].groups[this.currentChat].history || [];
        } else if (this.currentChat) {
            msgs = this.db[this.uid].friends[this.currentChat].history || [];
        }
        
        msgs.forEach(m => {
            const isMe = m.sender === this.uid;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'sent' : 'received'}`;
            let ticks = '';
            if(isMe && !this.currentChat.startsWith('group_')) {
                let icon = '<i class="ri-time-line"></i>'; 
                let cls = 'tick queued';
                if(m.status === 'sent') { icon = '<i class="ri-check-line"></i>'; cls = 'tick sent'; }
                if(m.status === 'delivered') { icon = '<i class="ri-check-double-line"></i>'; cls = 'tick delivered'; }
                ticks = `<span class="${cls}">${icon}</span>`;
            }
            let senderName = '';
            if(!isMe && this.currentChat.startsWith('group_')) {
                 const f = this.db[this.uid].friends[m.sender];
                 senderName = `<div style="font-size:10px; color:var(--primary); font-weight:bold; margin-bottom:2px;">${f ? f.name : m.sender}</div>`;
            }
            let content = m.type === 'audio' ? `
                <div class="audio-player">
                    <div class="play-btn" onclick="sys.toggleAudio('${m.id}')"><i class="ri-play-fill" id="btn-icon-${m.id}"></i></div>
                    <div class="audio-info">
                        <input type="range" min="0" max="100" value="0" class="custom-slider" id="slider-${m.id}" oninput="sys.seekAudio('${m.id}')">
                        <div class="audio-duration" id="time-${m.id}">0:00</div>
                    </div>
                    <div class="mic-avatar"><i class="ri-mic-fill"></i><div class="audio-dot"></div></div>
                    <audio id="audio-${m.id}" src="${m.text}" ontimeupdate="sys.updateAudioUI('${m.id}')" onended="sys.resetAudio('${m.id}')" style="display:none;"></audio>
                </div>` : m.text;

            div.innerHTML = `${senderName}${content}<div class="msg-meta"><span>${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>${ticks}</div>`;
            area.appendChild(div);
        });
        area.scrollTop = area.scrollHeight;
    },

    renderHome() {
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        const friends = this.db[this.uid].friends || {};
        const groups = this.db[this.uid].groups || {};
        let allChats = [];
        Object.keys(friends).forEach(id => {
            const f = friends[id];
            const last = f.history.length ? f.history[f.history.length-1] : null;
            allChats.push({ id, name: f.name || id, pic: f.pic, lastMsg: last ? (last.type === 'audio' ? '七 ﾃ「dio' : last.text) : 'Nova conexﾃ｣o', time: last ? last.time : 0, type: 'user' });
        });
        Object.keys(groups).forEach(id => {
            const g = groups[id];
            const last = g.history.length ? g.history[g.history.length-1] : null;
            allChats.push({ id, name: g.name, pic: null, lastMsg: last ? `${last.sender}: ${last.type === 'audio' ? '七 ﾃ「dio' : last.text}` : 'Grupo criado', time: last ? last.time : 0, type: 'group' });
        });
        allChats.sort((a,b) => b.time - a.time).forEach(c => {
            const htmlAv = c.pic ? `<img src="${c.pic}">` : (c.type === 'group' ? '<i class="ri-group-fill"></i>' : c.name[0].toUpperCase());
            const div = document.createElement('div');
            div.style.cssText = "display:flex; align-items:center; gap:15px; padding:16px 20px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;";
            div.innerHTML = `<div class="avatar">${htmlAv}</div><div style="flex:1; overflow:hidden;"><div style="font-weight:600; font-size:15px; margin-bottom:2px;">${c.name}</div><div style="color:var(--text-dim); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.lastMsg}</div></div>`;
            div.onclick = () => this.openChat(c.id);
            list.appendChild(div);
        });
    },

    openChat(id) {
        this.currentChat = id;
        this.updateChatHeader(id);
        this.renderMessages();
        this.openView('view-chat');
        document.getElementById('msg-input').value = '';
        this.handleInput(); 
        if(!id.startsWith('group_')) {
            if(!this.activeConns[id] || !this.activeConns[id].open) {
                const conn = this.peer.connect(id);
                this.setupConnectionEvents(conn);
            } else this.updateChatStatusUI(id);
        }
    },

    updateChatHeader(id) {
        let name, pic;
        if(id.startsWith('group_')) {
            const g = this.db[this.uid].groups[id];
            name = g.name; pic = null;
            document.getElementById('chat-status-text').innerText = `${g.members.length} membros`;
        } else {
            const f = this.db[this.uid].friends[id];
            name = f.name || id; pic = f.pic;
            this.updateChatStatusUI(id);
        }
        document.getElementById('chat-name').innerText = name;
        document.getElementById('chat-av').innerHTML = pic ? `<img src="${pic}">` : (id.startsWith('group_') ? '<i class="ri-group-fill"></i>' : name[0].toUpperCase());
    },

    closeChat() { this.currentChat = null; this.closeView('view-chat'); this.renderHome(); },

    addContact() {
        const id = document.getElementById('target-id').value.trim().toLowerCase();
        if(id && id !== this.uid) {
            if(!this.db[this.uid].friends[id]) this.db[this.uid].friends[id] = { name: id, history: [], bio: '', pic: '', lastSeen: Date.now() };
            this.saveDb(); this.closeView('view-add'); this.openChat(id);
        }
    },

    renderCreateGroup() {
        const list = document.getElementById('group-contact-list');
        list.innerHTML = ''; this.selectedGroupMembers = [];
        Object.keys(this.db[this.uid].friends).forEach(id => {
            const f = this.db[this.uid].friends[id];
            const div = document.createElement('div');
            div.className = 'contact-select-item';
            div.onclick = () => {
                div.classList.toggle('selected');
                if(this.selectedGroupMembers.includes(id)) this.selectedGroupMembers = this.selectedGroupMembers.filter(m => m !== id);
                else this.selectedGroupMembers.push(id);
            };
            div.innerHTML = `<div class="checkbox-fake"></div><div style="font-weight:600;">${f.name || id}</div>`;
            list.appendChild(div);
        });
    },

    createGroup() {
        const name = document.getElementById('group-name-input').value.trim();
        if(name.length < 1 || this.selectedGroupMembers.length < 1) return alert("Erro");
        const gid = 'group_' + Date.now();
        if(!this.db[this.uid].groups) this.db[this.uid].groups = {};
        this.db[this.uid].groups[gid] = { name, members: [this.uid, ...this.selectedGroupMembers], history: [] };
        this.saveDb(); this.closeView('view-create-group'); this.openChat(gid);
    },

    saveProfile() {
        const me = this.db[this.uid];
        me.name = document.getElementById('edit-name').value;
        me.bio = document.getElementById('edit-bio').value;
        me.pic = document.getElementById('edit-pic').value;
        this.saveDb(); this.updateHeader(); this.closeView('view-me');
        Object.values(this.activeConns).forEach(conn => { if(conn.open) this.sendProfile(conn); });
    },

    updateHeader() {
        const me = this.db[this.uid];
        document.getElementById('header-name').innerText = me.name || this.uid;
        document.getElementById('edit-name').value = me.name || "";
        document.getElementById('edit-bio').value = me.bio || "";
        document.getElementById('edit-pic').value = me.pic || "";
        const html = me.pic ? `<img src="${me.pic}">` : this.uid[0].toUpperCase();
        document.getElementById('header-av').innerHTML = html;
        document.getElementById('me-large-av').innerHTML = html;
    },

    showContact() {
        if(!this.currentChat || this.currentChat.startsWith('group_')) return;
        const f = this.db[this.uid].friends[this.currentChat];
        document.getElementById('contact-real-name').innerText = f.name || this.currentChat;
        document.getElementById('contact-real-id').innerText = '@' + this.currentChat;
        document.getElementById('contact-real-bio').innerText = f.bio || "Sem recado.";
        document.getElementById('contact-large-av').innerHTML = f.pic ? `<img src="${f.pic}">` : `<span style="font-size:40px; color:var(--primary); font-weight:bold;">${this.currentChat[0].toUpperCase()}</span>`;
        this.openView('view-contact');
    },

    async call(isVideo) {
        if(this.currentChat.startsWith('group_')) return;
        this.isVoiceOnly = !isVideo;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
            this.callStream = stream; this.updateCallUI();
            if(this.isVoiceOnly && this.activeConns[this.currentChat]) this.activeConns[this.currentChat].send({ type: 'call_type', mode: 'voice' });
            this.handleMediaCall(this.peer.call(this.currentChat, stream));
        } catch(e) { alert("Erro mﾃｭdia."); }
    },

    async answerCall() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: !this.isVoiceOnly, audio: true });
            this.callStream = stream; this.updateCallUI(); this.incomingCall.answer(stream); this.handleMediaCall(this.incomingCall);
        } catch(e) { alert("Erro."); }
    },

    handleMediaCall(call) {
        this.incomingCall = call;
        call.on('stream', rs => { document.getElementById('remote-video').srcObject = rs; });
        call.on('close', () => this.endCall());
    },

    updateCallUI() {
        const ui = document.getElementById('call-ui'); ui.classList.add('active');
        if(this.isVoiceOnly) {
            ui.classList.add('voice-mode');
            const f = this.db[this.uid].friends[this.currentChat] || { name: '...' };
            document.getElementById('voice-call-name').innerText = f.name;
            document.getElementById('voice-call-img').src = f.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        } else document.getElementById('local-video').srcObject = this.callStream;
    },

    toggleMic() {
        const t = this.callStream.getAudioTracks()[0]; this.micEnabled = !this.micEnabled; t.enabled = this.micEnabled;
        document.getElementById('btn-mic').classList.toggle('active');
    },

    toggleSpeaker() {
        this.speakerEnabled = !this.speakerEnabled; document.getElementById('remote-video').muted = !this.speakerEnabled;
        document.getElementById('btn-speaker').classList.toggle('active');
    },

    endCall() {
        if(this.incomingCall) this.incomingCall.close();
        if(this.callStream) this.callStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-ui').classList.remove('active', 'voice-mode');
        this.incomingCall = null; this.callStream = null;
    },

    toggleFab() {
        this.fabOpen = !this.fabOpen; document.getElementById('fab-menu').classList.toggle('show');
        const icon = document.getElementById('fab-icon');
        icon.className = this.fabOpen ? 'ri-close-line' : 'ri-add-line';
        icon.style.transform = this.fabOpen ? "rotate(90deg)" : "rotate(0deg)";
    },
    openView(id) { if(id === 'view-create-group') this.renderCreateGroup(); document.getElementById(id).classList.add('active'); },
    closeView(id) { document.getElementById(id).classList.remove('active'); }
};

sys.init();
</script>
</body>
</html>
