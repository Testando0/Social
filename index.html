<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crimson | Encrypted Messenger</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM PROFISSIONAL --- */
        :root {
            --primary: #dc2626;      /* Vermelho Profissional */
            --primary-dark: #b91c1c;
            --bg-app: #0f0f0f;       /* Preto Fosco */
            --bg-header: #18181b;    /* Cinza Chumbo */
            --bg-card: #27272a;
            --bg-bubble-in: #27272a;
            --bg-bubble-out: #dc2626;
            
            --text-main: #f4f4f5;
            --text-sec: #a1a1aa;
            
            --border: 1px solid rgba(255,255,255,0.08);
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-app);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* Container Principal para limitar largura em Desktop */
        #app-frame {
            width: 100%;
            max-width: 600px; /* Estilo Mobile em PC */
            height: 100%;
            position: relative;
            background: var(--bg-app);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        /* --- TELAS E TRANSIÇÕES --- */
        .screen {
            position: absolute; inset: 0;
            background: var(--bg-app);
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10;
        }
        .screen.active { transform: translateX(0); z-index: 20; }
        .screen.base { transform: translateX(0); z-index: 10; } /* Tela inicial */

        /* --- COMPONENTES UI --- */
        header {
            height: 60px;
            background: var(--bg-header);
            border-bottom: var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            z-index: 50;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-title { font-weight: 600; font-size: 18px; }
        .header-status { font-size: 12px; color: var(--text-sec); }
        
        .btn-icon {
            background: none; border: none; color: var(--text-main);
            font-size: 24px; padding: 8px; border-radius: 50%;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center;
        }
        .btn-icon:active { background: rgba(255,255,255,0.1); }

        /* --- LOGIN --- */
        #login-screen { z-index: 100; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .brand-logo { 
            width: 80px; height: 80px; background: var(--primary); 
            border-radius: 22px; margin: 0 auto 24px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: white; box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
        }
        .input-field {
            width: 100%; padding: 16px; border-radius: 12px;
            background: var(--bg-card); border: 1px solid transparent;
            color: white; font-size: 16px; outline: none; margin-bottom: 16px;
            transition: 0.3s;
        }
        .input-field:focus { border-color: var(--primary); }
        
        .btn-primary {
            width: 100%; padding: 16px; border-radius: 12px;
            background: var(--primary); color: white; font-weight: 600;
            border: none; font-size: 16px; cursor: pointer;
        }

        /* --- LISTA DE CHATS --- */
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            display: flex; align-items: center; gap: 14px;
            padding: 12px 16px; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: background 0.2s;
        }
        .chat-item:active { background: rgba(255,255,255,0.05); }

        .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, #3f3f46, #27272a);
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 20px; color: #fff; flex-shrink: 0;
            position: relative;
        }
        /* Indicador Online no Avatar */
        .avatar.online::after {
            content: ''; position: absolute; bottom: 2px; right: 2px;
            width: 12px; height: 12px; background: #10b981;
            border: 2px solid var(--bg-app); border-radius: 50%;
        }

        .chat-info { flex: 1; min-width: 0; }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-weight: 600; font-size: 16px; }
        .chat-time { font-size: 12px; color: var(--text-sec); }
        
        .chat-bottom { display: flex; justify-content: space-between; align-items: center; }
        .chat-msg { color: var(--text-sec); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85%; }
        
        .badge {
            background: var(--primary); color: white;
            font-size: 11px; font-weight: 700; height: 20px; min-width: 20px;
            padding: 0 6px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- TELA DE CONVERSA --- */
        #chat-view { 
            background-image: radial-gradient(var(--bg-card) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .messages-container {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .msg-bubble {
            max-width: 75%; padding: 10px 14px; border-radius: 16px;
            font-size: 15px; line-height: 1.4; position: relative;
            word-wrap: break-word;
        }
        .msg-sent {
            align-self: flex-end; background: var(--primary);
            color: white; border-bottom-right-radius: 4px;
        }
        .msg-received {
            align-self: flex-start; background: var(--bg-card);
            color: var(--text-main); border-bottom-left-radius: 4px;
        }
        
        .msg-meta {
            display: flex; justify-content: flex-end; align-items: center;
            gap: 4px; margin-top: 2px; opacity: 0.7; font-size: 11px;
        }
        .checks i { font-size: 14px; }
        .checks.read { color: #6ee7b7; } /* Verde claro para lido */

        .input-bar {
            background: var(--bg-header); padding: 10px 16px;
            display: flex; align-items: center; gap: 10px;
            border-top: var(--border);
        }

        /* --- TOAST NOTIFICATION --- */
        #toast {
            position: absolute; top: -60px; left: 16px; right: 16px;
            background: rgba(30,30,30,0.95); backdrop-filter: blur(10px);
            padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 12px;
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        #toast.visible { top: 16px; }

        /* Fab Button */
        .fab {
            position: absolute; bottom: 24px; right: 24px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white; border: none;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        
        /* Modal */
        .modal-bg {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal-bg.open { display: flex; }
        .modal-box { width: 90%; max-width: 320px; background: var(--bg-header); padding: 20px; border-radius: 16px; }
    </style>
</head>
<body>

<div id="app-frame">
    
    <div id="toast" onclick="hideToast()">
        <div style="background:var(--primary); width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-message-3-fill text-white"></i></div>
        <div>
            <div style="font-weight:600; font-size:14px;">Nova Mensagem</div>
            <div id="toast-text" style="font-size:12px; color:var(--text-sec);">Você tem novas mensagens</div>
        </div>
    </div>

    <div id="login-screen" class="screen base active">
        <div class="brand-logo"><i class="ri-shield-keyhole-line"></i></div>
        <h2>Crimson ID</h2>
        <p style="color:var(--text-sec); margin-bottom: 30px; font-size:14px;">Protocolo de Mensagem Segura</p>
        
        <input type="text" id="my-username" class="input-field" placeholder="Escolha seu Nickname" autocomplete="off">
        <button onclick="login()" class="btn-primary">Entrar no Sistema</button>
    </div>

    <div id="home-screen" class="screen">
        <header>
            <div class="header-left">
                <div class="avatar" id="my-avatar-mini" style="width:36px; height:36px; font-size:14px;">E</div>
                <div>
                    <div class="header-title">Conversas</div>
                    <div id="connection-status" class="header-status" style="color:#ef4444;">Desconectado</div>
                </div>
            </div>
            <button class="btn-icon" onclick="logout()"><i class="ri-logout-box-r-line"></i></button>
        </header>
        
        <div id="chat-list" class="chat-list"></div>
        <button class="fab" onclick="openContactModal()"><i class="ri-add-line"></i></button>
    </div>

    <div id="chat-screen" class="screen">
        <header>
            <div class="header-left">
                <button class="btn-icon" onclick="goBack()"><i class="ri-arrow-left-s-line"></i></button>
                <div class="avatar" id="current-chat-avatar" style="width:36px; height:36px; font-size:14px;">U</div>
                <div style="cursor: pointer;">
                    <div id="chat-title" class="header-title" style="font-size:16px;">Usuario</div>
                    <div id="chat-status" class="header-status">Visto por último recentemente</div>
                </div>
            </div>
        </header>
        
        <div id="messages-area" class="messages-container"></div>
        
        <div class="input-bar">
            <input type="text" id="msg-input" class="input-field" style="margin:0; padding:12px;" placeholder="Mensagem..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button class="btn-icon" style="background:var(--primary); width:44px; height:44px; color:white;" onclick="sendMessage()">
                <i class="ri-send-plane-fill"></i>
            </button>
        </div>
    </div>

    <div id="contact-modal" class="modal-bg">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">Novo Contato</h3>
            <input type="text" id="new-contact-id" class="input-field" placeholder="Nickname do destino">
            <div style="display:flex; gap:10px;">
                <button onclick="closeContactModal()" class="btn-primary" style="background:var(--bg-card);">Cancelar</button>
                <button onclick="addNewContact()" class="btn-primary">Adicionar</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- LÓGICA DO SISTEMA ---
    
    // Configurações e Estado
    const DB_PREFIX = "crimson_v2_";
    let state = {
        myId: localStorage.getItem(DB_PREFIX + 'uid'),
        peer: null,
        conns: {}, // conexões ativas
        activeChat: null,
        contacts: JSON.parse(localStorage.getItem(DB_PREFIX + 'contacts') || '[]'),
        history: JSON.parse(localStorage.getItem(DB_PREFIX + 'history') || '{}'),
        unread: JSON.parse(localStorage.getItem(DB_PREFIX + 'unread') || '{}')
    };

    // --- INICIALIZAÇÃO ---
    window.onload = () => {
        if(state.myId) {
            initSystem();
        }
    };

    function login() {
        const input = document.getElementById('my-username');
        const id = input.value.trim().toLowerCase().replace(/\s/g, '');
        if(!id) return alert("Digite um nome válido");
        
        localStorage.setItem(DB_PREFIX + 'uid', id);
        state.myId = id;
        initSystem();
    }

    function initSystem() {
        // UI Transition
        document.getElementById('login-screen').classList.remove('active');
        document.getElementById('home-screen').classList.add('base'); // Torna home a base
        document.getElementById('my-avatar-mini').innerText = state.myId[0].toUpperCase();
        
        renderChatList();
        connectNetwork();
    }

    function logout() {
        if(confirm("Sair do Crimson?")) {
            state.peer.destroy();
            localStorage.removeItem(DB_PREFIX + 'uid');
            location.reload();
        }
    }

    // --- REDE P2P (PEERJS) ---
    function connectNetwork() {
        const statusEl = document.getElementById('connection-status');
        statusEl.innerText = "Conectando...";
        
        // Cria Peer
        state.peer = new Peer(state.myId);

        state.peer.on('open', (id) => {
            statusEl.innerText = "Online";
            statusEl.style.color = "#10b981"; // Verde
            reconnectContacts();
        });

        state.peer.on('error', (err) => {
            console.log(err);
            if(err.type === 'unavailable-id') {
                alert("Este ID já está em uso em outra aba/dispositivo.");
                localStorage.clear(); location.reload();
            }
            statusEl.innerText = "Erro de Rede";
            statusEl.style.color = "#ef4444";
        });

        state.peer.on('connection', (conn) => {
            setupConnection(conn);
        });
        
        state.peer.on('disconnected', () => {
            statusEl.innerText = "Reconectando...";
            statusEl.style.color = "#f59e0b"; // Laranja
            state.peer.reconnect();
        });
    }

    function reconnectContacts() {
        // Tenta conectar com todos os contatos conhecidos para garantir canal aberto
        state.contacts.forEach(contactId => {
            if(!state.conns[contactId]) {
                const conn = state.peer.connect(contactId);
                setupConnection(conn);
            }
        });
    }

    function setupConnection(conn) {
        state.conns[conn.peer] = conn;

        conn.on('open', () => {
            // Se tivermos mensagens "pendentes" (status: sending), poderíamos reenviar aqui
        });

        conn.on('data', (data) => {
            handleIncomingData(conn.peer, data);
        });

        conn.on('close', () => {
            delete state.conns[conn.peer];
        });
    }

    // --- MANIPULAÇÃO DE MENSAGENS ---
    function handleIncomingData(senderId, data) {
        if(data.type === 'chat') {
            // 1. Salvar Mensagem
            const msgObj = {
                id: data.id,
                text: data.text,
                timestamp: data.timestamp,
                sender: senderId,
                isMe: false,
                read: false
            };
            
            saveMessage(senderId, msgObj);

            // 2. Lógica de UI
            if(state.activeChat === senderId) {
                // Se o chat está aberto, marca como lido e mostra
                msgObj.read = true;
                appendMessageToView(msgObj);
                saveHistory(); // Atualiza o read status no DB
                // Enviar confirmação de leitura (Ack) seria implementado aqui
            } else {
                // Se o chat não está aberto, incrementa contador
                state.unread[senderId] = (state.unread[senderId] || 0) + 1;
                saveUnread();
                showToast(`Nova mensagem de ${senderId}`);
            }
            
            // Verifica se é um contato novo
            if(!state.contacts.includes(senderId)) {
                state.contacts.push(senderId);
                saveContacts();
            }

            renderChatList();
        }
    }

    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text || !state.activeChat) return;

        const msgObj = {
            id: Date.now(),
            text: text,
            timestamp: Date.now(),
            sender: state.myId,
            isMe: true,
            read: false // Só fica true quando receber ACK (futuro)
        };

        // UI Instantânea
        appendMessageToView(msgObj);
        saveMessage(state.activeChat, msgObj);
        input.value = '';

        // Envio Rede
        const conn = state.conns[state.activeChat];
        if(conn && conn.open) {
            conn.send({
                type: 'chat',
                id: msgObj.id,
                text: msgObj.text,
                timestamp: msgObj.timestamp
            });
        } else {
            // Tenta conectar e enviar
            const newConn = state.peer.connect(state.activeChat);
            setupConnection(newConn);
            newConn.on('open', () => {
                newConn.send({
                    type: 'chat',
                    id: msgObj.id,
                    text: msgObj.text,
                    timestamp: msgObj.timestamp
                });
            });
        }
        
        renderChatList(); // Atualiza snippet na home
    }

    // --- PERSISTÊNCIA DE DADOS ---
    function saveMessage(chatId, msg) {
        if(!state.history[chatId]) state.history[chatId] = [];
        state.history[chatId].push(msg);
        saveHistory();
    }

    function saveHistory() { localStorage.setItem(DB_PREFIX + 'history', JSON.stringify(state.history)); }
    function saveUnread() { localStorage.setItem(DB_PREFIX + 'unread', JSON.stringify(state.unread)); }
    function saveContacts() { localStorage.setItem(DB_PREFIX + 'contacts', JSON.stringify(state.contacts)); }

    // --- UI RENDERERS ---
    
    function renderChatList() {
        const listEl = document.getElementById('chat-list');
        listEl.innerHTML = '';

        // Ordenar contatos por mensagem mais recente
        const sortedContacts = [...state.contacts].sort((a, b) => {
            const lastA = state.history[a]?.slice(-1)[0]?.timestamp || 0;
            const lastB = state.history[b]?.slice(-1)[0]?.timestamp || 0;
            return lastB - lastA;
        });

        sortedContacts.forEach(id => {
            const msgs = state.history[id] || [];
            const lastMsg = msgs[msgs.length - 1];
            const unreadCount = state.unread[id] || 0;
            
            const timeStr = lastMsg ? new Date(lastMsg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            const msgPreview = lastMsg ? (lastMsg.isMe ? 'Você: ' : '') + lastMsg.text : 'Nova conversa';

            const html = `
                <div class="chat-item" onclick="openChat('${id}')">
                    <div class="avatar">${id[0].toUpperCase()}</div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <span class="chat-name">${id}</span>
                            <span class="chat-time">${timeStr}</span>
                        </div>
                        <div class="chat-bottom">
                            <span class="chat-msg" style="${unreadCount > 0 ? 'color:white; font-weight:600;' : ''}">${msgPreview}</span>
                            ${unreadCount > 0 ? `<div class="badge">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            listEl.innerHTML += html;
        });
    }

    function appendMessageToView(msg) {
        const container = document.getElementById('messages-area');
        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        const html = `
            <div class="msg-bubble ${msg.isMe ? 'msg-sent' : 'msg-received'}">
                ${msg.text}
                <div class="msg-meta">
                    ${time}
                    ${msg.isMe ? `<span class="checks ${msg.read ? 'read':''}"><i class="ri-check-double-line"></i></span>` : ''}
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        container.scrollTop = container.scrollHeight;
    }

    // --- NAVEGAÇÃO ---
    function openChat(id) {
        state.activeChat = id;
        
        // Zera unread
        state.unread[id] = 0;
        saveUnread();
        renderChatList();

        // Configura Tela Chat
        document.getElementById('chat-title').innerText = id;
        document.getElementById('current-chat-avatar').innerText = id[0].toUpperCase();
        document.getElementById('chat-status').innerText = state.conns[id] && state.conns[id].open ? "Online" : "Offline";
        
        // Renderiza Histórico
        const container = document.getElementById('messages-area');
        container.innerHTML = '';
        const msgs = state.history[id] || [];
        msgs.forEach(m => appendMessageToView(m));

        // Transição
        document.getElementById('chat-screen').classList.add('active');
        
        // Tenta conectar se não estiver
        if(!state.conns[id]) {
            const conn = state.peer.connect(id);
            setupConnection(conn);
        }
    }

    function goBack() {
        state.activeChat = null;
        document.getElementById('chat-screen').classList.remove('active');
        renderChatList();
    }

    // --- MODAL CONTATOS ---
    function openContactModal() { document.getElementById('contact-modal').classList.add('open'); }
    function closeContactModal() { document.getElementById('contact-modal').classList.remove('open'); }
    
    function addNewContact() {
        const id = document.getElementById('new-contact-id').value.trim().toLowerCase();
        if(id && id !== state.myId) {
            if(!state.contacts.includes(id)) {
                state.contacts.push(id);
                saveContacts();
                renderChatList();
            }
            closeContactModal();
            openChat(id);
        }
    }

    // --- UTILS ---
    function showToast(msg) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-text').innerText = msg;
        toast.classList.add('visible');
        setTimeout(() => toast.classList.remove('visible'), 4000);
    }
    function hideToast() {
        document.getElementById('toast').classList.remove('visible');
    }

</script>
</body>
</html>
