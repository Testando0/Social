<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cris√°lida PRO | P2P</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0b0b0e; --panel: #16161d; --accent: #00f2ff;
            --purple: #7000ff; --text: #ffffff; --danger: #ff3b30;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* LOGIN SCREEN */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box { 
            width: 100%; max-width: 350px; background: var(--panel); padding: 30px; 
            border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); text-align: center;
        }
        input { 
            width: 100%; padding: 14px; background: #000; border: 1px solid #333; 
            border-radius: 12px; color: white; margin-bottom: 12px; outline: none; 
        }
        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; 
            font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-main { background: var(--purple); color: white; }

        /* APP LAYOUT */
        #app { display: none; flex-direction: column; height: 100%; }
        header { 
            height: 65px; background: var(--panel); display: flex; 
            align-items: center; padding: 0 15px; border-bottom: 1px solid #222; 
        }
        #chat-flow { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; 
            flex-direction: column; gap: 10px; background: #0e0e12;
        }

        /* BUBBLES */
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; }
        .sent { align-self: flex-end; background: var(--purple); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: #26262e; border-bottom-left-radius: 2px; border-left: 3px solid var(--accent); }

        .input-area { padding: 15px; background: var(--panel); display: flex; gap: 10px; }
        .call-ui { 
            position: fixed; inset: 0; background: #000; z-index: 8000; 
            display: none; flex-direction: column; 
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { 
            position: absolute; top: 20px; right: 20px; width: 100px; 
            height: 150px; border: 2px solid var(--accent); border-radius: 10px; z-index: 10;
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="color: var(--accent); margin-bottom: 20px;">CRIS√ÅLIDA LOGIN</h2>
            <input type="text" id="user-id" placeholder="Usu√°rio">
            <input type="password" id="user-pass" placeholder="Senha">
            <button class="btn btn-main" onclick="handleAuth()">ENTRAR / CRIAR</button>
        </div>
    </div>

    <div id="app">
        <header>
            <div style="flex: 1;">
                <h4 id="display-name">Carregando...</h4>
                <span id="peer-status" style="font-size: 11px; color: #888;">Offline</span>
            </div>
            <button onclick="copyLink()" style="background:none; border:none; color:var(--accent); font-size:20px; cursor:pointer; margin-right:15px;">üîó</button>
            <button onclick="startCall()" style="background:none; border:none; color:var(--accent); font-size:20px; cursor:pointer; margin-right:15px;">üìû</button>
            <button onclick="logout()" style="background:none; border:none; color:var(--danger); font-size:20px; cursor:pointer;">üö™</button>
        </header>

        <main id="chat-flow"></main>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Mensagem..." onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()" style="background:var(--purple); border:none; color:white; padding:0 20px; border-radius:10px;">ENVIAR</button>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <video id="local-video" autoplay muted playsinline></video>
        <video id="remote-video" autoplay playsinline></video>
        <button onclick="endCall()" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); width:70px; height:70px; background:var(--danger); border-radius:50%; border:none; color:white; font-size:30px; cursor:pointer;">‚úñ</button>
    </div>

    <script>
        let peer, conn, myStream;
        const storageKey = 'crisalida_accounts';
        const sessionKey = 'crisalida_logged_user';

        // 1. SISTEMA DE CONTA E PERSIST√äNCIA
        function handleAuth() {
            const id = document.getElementById('user-id').value.trim().toLowerCase();
            const pass = document.getElementById('user-pass').value.trim();
            if(!id || !pass) return alert("Preencha os campos!");

            let accounts = JSON.parse(localStorage.getItem(storageKey) || '{}');
            
            if(accounts[id]) {
                if(accounts[id] !== pass) return alert("Senha incorreta!");
            } else {
                accounts[id] = pass;
                localStorage.setItem(storageKey, JSON.stringify(accounts));
            }

            localStorage.setItem(sessionKey, id);
            startSession(id);
        }

        // Auto-login se j√° estiver logado
        window.onload = () => {
            const logged = localStorage.getItem(sessionKey);
            if(logged) startSession(logged);
        };

        function logout() {
            localStorage.removeItem(sessionKey);
            location.href = window.location.pathname; // Limpa URL e desloga
        }

        // 2. INICIALIZA√á√ÉO DO PEER
        function startSession(userId) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('display-name').innerText = userId.toUpperCase();

            // O ID do Peer √© o pr√≥prio nome de usu√°rio para ser est√°tico
            peer = new Peer(userId);

            peer.on('open', (id) => {
                document.getElementById('peer-status').innerText = "Online como: " + id;
                document.getElementById('peer-status').style.color = "var(--accent)";
                checkInvite();
            });

            peer.on('connection', (connection) => {
                conn = connection;
                bindEvents();
            });

            peer.on('call', (call) => {
                if(confirm("Chamada recebida! Atender?")) {
                    navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                        myStream = stream;
                        document.getElementById('call-ui').style.display = 'flex';
                        document.getElementById('local-video').srcObject = stream;
                        call.answer(stream);
                        call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
                    });
                }
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') alert("Erro: Este usu√°rio j√° est√° logado em outra aba.");
                console.error(err);
            });
        }

        // 3. LOGICA DE COMUNICA√á√ÉO
        function bindEvents() {
            conn.on('open', () => {
                addMessage("Sistema", "Conex√£o estabelecida com " + conn.peer);
                conn.on('data', (data) => render(conn.peer, data, 'received'));
            });
        }

        function send() {
            const input = document.getElementById('msg-input');
            if(!input.value || !conn) return alert("Ningu√©m conectado. Envie o link primeiro!");
            conn.send(input.value);
            render("Voc√™", input.value, 'sent');
            input.value = "";
        }

        function render(user, text, type) {
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            flow.appendChild(div);
            flow.scrollTop = flow.scrollHeight;
        }

        function addMessage(user, text) {
            render(user, text, 'received');
        }

        // 4. CHAMADAS E LINKS
        function copyLink() {
            const id = localStorage.getItem(sessionKey);
            const url = `${window.location.origin}${window.location.pathname}?join=${id}`;
            navigator.clipboard.writeText(url);
            alert("Link de convite copiado! Mande para seu amigo.");
        }

        function checkInvite() {
            const urlParams = new URLSearchParams(window.location.search);
            const target = urlParams.get('join');
            const myId = localStorage.getItem(sessionKey);
            
            if(target && target !== myId) {
                // Tenta conectar ao ID do link
                conn = peer.connect(target);
                bindEvents();
            }
        }

        async function startCall() {
            if(!conn) return alert("Conecte-se no chat antes de ligar!");
            myStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('local-video').srcObject = myStream;
            const call = peer.call(conn.peer, myStream);
            call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
        }

        function endCall() {
            document.getElementById('call-ui').style.display = 'none';
            if(myStream) myStream.getTracks().forEach(t => t.stop());
        }
    </script>
</body>
</html>
