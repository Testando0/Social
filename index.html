<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cris√°lida PRO | Cloud-Sync</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #08080a; --side: #121217; --panel: #1c1c24;
            --accent: #00f2ff; --purple: #7000ff; --text: #ffffff;
            --text-dim: #a1a1aa; --border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; overflow: hidden; }

        /* LOGIN */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 380px; background: var(--side); padding: 40px; border-radius: 24px; border: 1px solid var(--border); text-align: center; }

        /* SIDEBAR */
        #sidebar { width: 350px; background: var(--side); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; z-index: 100; }
        .chat-item { padding: 16px 20px; display: flex; align-items: center; gap: 14px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .chat-item:hover { background: rgba(255,255,255,0.03); }
        .avatar { width: 45px; height: 45px; border-radius: 12px; background: var(--purple); display: flex; align-items: center; justify-content: center; font-weight: 700; }

        /* MAIN */
        #main-chat { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-header { height: 70px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* BUBBLES */
        .msg { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 14px; position: relative; }
        .sent { align-self: flex-end; background: var(--purple); border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--panel); border-bottom-left-radius: 4px; }
        .status-icon { font-size: 10px; margin-left: 5px; opacity: 0.6; }

        .input-area { padding: 20px; display: flex; gap: 10px; background: var(--bg); }
        input { width: 100%; padding: 12px 18px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; }
        .btn-action { background: var(--purple); border: none; padding: 10px 20px; border-radius: 10px; color: white; cursor: pointer; font-weight: 600; }

        @media (max-width: 768px) { #sidebar { width: 100%; position: absolute; } #sidebar.hidden { transform: translateX(-100%); } }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h2>Cris√°lida Pro</h2>
        <p style="color: var(--text-dim); margin-bottom: 20px;">Mensagens Sincronizadas P2P</p>
        <input type="text" id="login-user" placeholder="Seu Nickname">
        <button onclick="auth()" class="btn-action" style="width: 100%; margin-top: 10px;">ENTRAR</button>
    </div>
</div>

<aside id="sidebar">
    <div style="padding: 20px;">
        <input type="text" id="user-search" placeholder="Adicionar @usu√°rio..." onkeyup="if(event.key==='Enter') searchUser()">
    </div>
    <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
</aside>

<main id="main-chat">
    <header class="chat-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="toggleSide()" id="back-btn" style="display:none; background:none; border:none; color:white;">‚Üê</button>
            <div>
                <h4 id="active-user">Selecione um chat</h4>
                <span id="active-status" style="font-size:10px; color:var(--text-dim);">Offline</span>
            </div>
        </div>
        <button onclick="copyInvite()" class="btn-action" style="background:var(--accent); color:black;">üîó Link</button>
    </header>

    <div id="messages"></div>

    <div class="input-area">
        <input type="text" id="msg-input" placeholder="Escreva..." onkeydown="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()" class="btn-action">üöÄ</button>
    </div>
</main>

<script>
    let peer, connections = {}, myStream;
    let myId = localStorage.getItem('cris_u');
    let activeChat = null;
    let history = JSON.parse(localStorage.getItem('cris_h') || '{}');

    function auth() {
        const u = document.getElementById('login-user').value.trim().toLowerCase();
        if(!u) return;
        localStorage.setItem('cris_u', u);
        location.reload();
    }

    if(myId) {
        document.getElementById('auth-screen').style.display = 'none';
        initPeer();
    }

    function initPeer() {
        peer = new Peer(myId);

        peer.on('open', (id) => {
            renderChatList();
            // Tenta reconectar com todos os chats do hist√≥rico para entregar pendentes
            Object.keys(history).forEach(peerId => connectToUser(peerId));
        });

        peer.on('connection', (conn) => {
            handleNewConn(conn);
        });
    }

    function handleNewConn(conn) {
        connections[conn.peer] = conn;
        
        conn.on('open', () => {
            if(activeChat === conn.peer) {
                document.getElementById('active-status').innerText = "Online";
                document.getElementById('active-status').style.color = "var(--accent)";
            }
            // Sincroniza mensagens que EU enviei enquanto ele estava offline
            syncMessages(conn);
        });

        conn.on('data', (data) => {
            if(data.type === 'msg') {
                receiveMessage(conn.peer, data);
                conn.send({ type: 'ack', id: data.id }); // Manda confirma√ß√£o
            } else if(data.type === 'ack') {
                markAsDelivered(conn.peer, data.id);
            }
        });

        conn.on('close', () => {
            if(activeChat === conn.peer) document.getElementById('active-status').innerText = "Offline";
            delete connections[conn.peer];
        });
    }

    function connectToUser(peerId) {
        if(connections[peerId]) return;
        const conn = peer.connect(peerId);
        handleNewConn(conn);
    }

    function sendMessage() {
        const input = document.getElementById('msg-input');
        if(!input.value || !activeChat) return;

        const msgObj = {
            id: Date.now() + Math.random(),
            type: 'msg',
            text: input.value,
            user: myId,
            delivered: false
        };

        // Salva no hist√≥rico local primeiro
        if(!history[activeChat]) history[activeChat] = [];
        history[activeChat].push(msgObj);
        save();
        renderMessages();

        // Tenta enviar se estiver online
        const conn = connections[activeChat];
        if(conn && conn.open) {
            conn.send(msgObj);
        } else {
            connectToUser(activeChat); // Tenta reconectar em background
        }
        
        input.value = "";
        renderChatList();
    }

    function receiveMessage(peerId, data) {
        if(!history[peerId]) history[peerId] = [];
        // Evita duplicatas
        if(!history[peerId].find(m => m.id === data.id)) {
            history[peerId].push({...data, delivered: true});
            save();
            if(activeChat === peerId) renderMessages();
            renderChatList();
        }
    }

    function syncMessages(conn) {
        const pendentes = (history[conn.peer] || []).filter(m => !m.delivered && m.user === myId);
        pendentes.forEach(m => conn.send(m));
    }

    function markAsDelivered(peerId, msgId) {
        const msg = history[peerId].find(m => m.id === msgId);
        if(msg) {
            msg.delivered = true;
            save();
            if(activeChat === peerId) renderMessages();
        }
    }

    function searchUser() {
        const val = document.getElementById('user-search').value.trim().toLowerCase();
        if(val && val !== myId) {
            openChat(val);
            document.getElementById('user-search').value = "";
        }
    }

    function openChat(peerId) {
        activeChat = peerId;
        document.getElementById('active-user').innerText = "@" + peerId;
        document.getElementById('active-status').innerText = connections[peerId] ? "Online" : "Offline";
        if(window.innerWidth < 768) toggleSide();
        renderMessages();
        connectToUser(peerId);
    }

    function renderMessages() {
        const box = document.getElementById('messages');
        box.innerHTML = "";
        (history[activeChat] || []).forEach(m => {
            const div = document.createElement('div');
            const isMe = m.user === myId;
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `${m.text} <span class="status-icon">${isMe ? (m.delivered ? '‚úì‚úì' : 'üïí') : ''}</span>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    function renderChatList() {
        const list = document.getElementById('chat-list');
        list.innerHTML = "";
        Object.keys(history).forEach(id => {
            const last = history[id][history[id].length - 1];
            list.innerHTML += `
                <div class="chat-item" onclick="openChat('${id}')">
                    <div class="avatar">${id[0].toUpperCase()}</div>
                    <div style="flex:1">
                        <b>${id}</b>
                        <p style="font-size:12px; color:var(--text-dim)">${last ? last.text.substring(0,20) : ''}</p>
                    </div>
                </div>`;
        });
    }

    function save() { localStorage.setItem('cris_h', JSON.stringify(history)); }
    function toggleSide() { 
        document.getElementById('sidebar').classList.toggle('hidden');
        document.getElementById('back-btn').style.display = document.getElementById('sidebar').classList.contains('hidden') ? 'block' : 'none';
    }
    function copyInvite() {
        const url = window.location.origin + window.location.pathname + "?u=" + myId;
        navigator.clipboard.writeText(url);
        alert("Link copiado!");
    }
</script>
</body>
</html>
