<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>CRIMSON | ENTERPRISE</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #ff0033;
            --primary-dark: #cc0029;
            --bg: #000000;
            --surface: #0a0a0b;
            --card: #141417;
            --border: #27272a;
            --text: #ffffff;
            --text-dim: #a1a1aa;
            --bubble-sent: #ff0033;
            --bubble-rec: #1f1f22;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        input, textarea { user-select: text; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* APP */
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; background: var(--bg); border-left: 1px solid var(--border); border-right: 1px solid var(--border); }

        /* AUTH */
        #auth-screen { position: absolute; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .auth-content { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }

        /* HEADER */
        header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(10,10,11,0.95); border-bottom: 1px solid var(--border); z-index: 800; height: 70px; }
        .user-meta { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* VIEWS */
        .view { position: absolute; inset: 0; background: var(--bg); z-index: 900; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .view.active { transform: translateX(0); }

        /* CHAT AREA */
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 30px; }
        
        /* BUBBLES */
        .bubble { max-width: 85%; padding: 8px 10px; border-radius: 12px; font-size: 15px; position: relative; word-wrap: break-word; display: flex; flex-direction: column; user-select: text; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .sent { align-self: flex-end; background: var(--bubble-sent); color: #fff; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--bubble-rec); border: 1px solid var(--border); border-bottom-left-radius: 2px; }

        .msg-meta { font-size: 10px; margin-top: 2px; display: flex; align-items: center; gap: 3px; align-self: flex-end; opacity: 0.7; padding-left: 10px; }
        .tick { font-size: 14px; }
        
        /* --- DESIGN CUSTOMIZADO DE √ÅUDIO (WHATSAPP STYLE) --- */
        .audio-container {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 240px;
            padding: 5px 0;
        }
        
        /* Avatar no √°udio (Opcional, estilo grupo) */
        .audio-headshot {
            width: 40px; height: 40px; border-radius: 50%; 
            background: #000; overflow: hidden; position: relative;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .audio-headshot img { width: 100%; height: 100%; object-fit: cover; }
        .audio-mic-icon { position: absolute; bottom: -2px; right: -2px; font-size: 12px; color: var(--primary); background: #000; border-radius: 50%; padding: 2px; }

        /* Controles */
        .audio-ctrls { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 6px; }
        
        .audio-top { display: flex; align-items: center; gap: 10px; }
        
        .play-btn {
            width: 32px; height: 32px; flex-shrink: 0;
            border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; transition: 0.2s;
        }
        
        /* Cores enviadas (Fundo Vermelho) */
        .sent .play-btn { background: rgba(0,0,0,0.2); color: #fff; }
        .sent .play-btn:active { background: rgba(0,0,0,0.4); }
        
        /* Cores recebidas (Fundo Cinza) */
        .received .play-btn { background: var(--border); color: var(--primary); }
        .received .play-btn:active { background: #333; }

        /* Slider de Progresso */
        .seek-bar {
            -webkit-appearance: none; width: 100%; height: 4px;
            border-radius: 2px; outline: none; cursor: pointer;
            position: relative; margin: 0;
        }
        /* Track Style - Sent */
        .sent .seek-bar { background: rgba(255,255,255,0.3); }
        .sent .seek-bar::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #fff; border: none; }
        
        /* Track Style - Received */
        .received .seek-bar { background: #3f3f46; }
        .received .seek-bar::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--primary); border: none; }

        .audio-time { font-size: 11px; font-family: monospace; opacity: 0.9; margin-left: 2px; min-width: 35px; }


        /* INPUT BAR */
        .input-bar { padding: 8px 10px; display: flex; gap: 8px; background: var(--surface); border-top: 1px solid var(--border); align-items: center; min-height: 65px; }
        .field { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 24px; color: #fff; padding: 10px 18px; font-size: 15px; transition: 0.2s; height: 45px; }
        .field:focus { border-color: var(--primary); }
        
        /* BOT√ÉO A√á√ÉO (MIC/SEND) */
        .btn-action { 
            width: 48px; height: 48px; border-radius: 50%; 
            background: var(--primary); border: none; 
            color: white; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.3s;
            flex-shrink: 0;
        }
        .btn-action:active { transform: scale(0.9); }
        .btn-action i { font-size: 20px; transition: 0.2s; }
        
        .btn-action.recording { 
            background: #ff3b30; 
            animation: pulse-rec 1.5s infinite;
        }
        @keyframes pulse-rec { 
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 
            50% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(255, 59, 48, 0); } 
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } 
        }

        /* OUTROS ESTILOS */
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; }
        .fab { position: absolute; bottom: 30px; right: 20px; width: 54px; height: 54px; background: var(--primary); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; box-shadow: 0 8px 20px rgba(255,0,51,0.4); cursor: pointer; z-index: 500; transition: 0.3s; }
        
        .contact-select-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .contact-select-item.selected { background: rgba(255,0,51,0.1); }
        .checkbox-fake { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-dim); display: flex; align-items: center; justify-content: center; }
        .selected .checkbox-fake { background: var(--primary); border-color: var(--primary); }
        .selected .checkbox-fake::after { content: '‚úî'; font-size: 14px; color: white; }

        /* VIDEO CALL */
        .call-ui { position: fixed; inset: 0; z-index: 99999; background: #0c0c0c; display: none; flex-direction: column; }
        .call-ui.active { display: flex; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 150px; position: absolute; bottom: 120px; right: 20px; border-radius: 12px; border: 2px solid var(--primary); background: #222; z-index: 10; object-fit: cover; }
        .call-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .end-call { background: #ff3b30; }

        .profile-hero { display: flex; flex-direction: column; align-items: center; padding: 40px 20px; text-align: center; }
        .big-av { width: 120px; height: 120px; border-radius: 50%; background: var(--card); border: 2px solid var(--primary); margin-bottom: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .big-av img { width: 100%; height: 100%; object-fit: cover; }
        
        .status-offline { color: var(--text-dim); }
        .status-online { color: #4ade80; font-weight: 700; }
        .online-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <div style="margin-bottom: 40px; text-align: center;">
            <i class="ri-shield-keyhole-fill" style="font-size: 64px; color: var(--primary);"></i>
            <h1 style="font-size: 28px; font-weight: 800;">CRIMSON</h1>
        </div>
        <div class="auth-content">
            <input type="text" id="auth-id" class="field" placeholder="Usu√°rio (ID)" style="text-align:center;">
            <input type="password" id="auth-pass" class="field" placeholder="Senha" style="text-align:center;">
            <button class="btn" onclick="sys.auth(false)">ENTRAR</button>
            <button class="btn" onclick="sys.auth(true)" style="background: var(--card); border: 1px solid var(--border);">CRIAR CONTA</button>
        </div>
    </div>

    <header>
        <div class="user-meta" onclick="sys.openView('view-me')">
            <div class="avatar" id="header-av"></div>
            <div>
                <div id="header-name" style="font-weight: 700; font-size: 15px;">...</div>
                <div style="font-size: 11px; color: var(--primary); font-weight: 700;">ONLINE</div>
            </div>
        </div>
        <i class="ri-settings-4-line" style="font-size: 24px; color: var(--text-dim);" onclick="sys.openView('view-me')"></i>
    </header>

    <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
    
    <div class="fab" onclick="sys.openView('view-add')"><i class="ri-add-line"></i></div>

    <div id="view-chat" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeChat()" style="font-size: 28px; padding-right: 10px; cursor: pointer;"></i>
            <div style="flex:1; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="sys.showContact()">
                <div class="avatar" id="chat-av" style="width:36px; height:36px;"></div>
                <div>
                    <div id="chat-name" style="font-weight: 700; font-size: 15px;">Nome</div>
                    <div id="chat-status-text" style="font-size: 11px; color: var(--text-dim);">...</div>
                </div>
            </div>
            <div style="display:flex; gap:15px; font-size: 22px; color: var(--primary);">
                <i class="ri-phone-fill" onclick="sys.call(false)"></i>
                <i class="ri-vidicon-fill" onclick="sys.call(true)"></i>
            </div>
        </header>
        
        <div id="messages" class="chat-area"></div>
        
        <div class="input-bar">
            <input type="text" id="msg-input" class="field" placeholder="Mensagem" oninput="sys.handleInput()">
            
            <button class="btn-action" id="btn-action" onclick="sys.handleAction()">
                <i class="ri-mic-fill" id="icon-mic"></i>
                <i class="ri-send-plane-fill" id="icon-send" style="display:none; transform: translate(-1px, 1px);"></i>
            </button>
        </div>
    </div>

    <div id="view-add" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-add')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Nova Conex√£o</h3>
        </header>
        <div style="padding: 30px;">
            <button class="btn" style="width:100%; margin-bottom:20px; background:var(--card); border:1px solid var(--border);" onclick="sys.openView('view-create-group')">CRIAR GRUPO</button>
            <p style="color:var(--text-dim); margin-bottom:10px;">Ou adicione por ID</p>
            <input type="text" id="target-id" class="field" style="margin-bottom: 20px;">
            <button class="btn" style="width:100%;" onclick="sys.addContact()">CONECTAR</button>
        </div>
    </div>

    <div id="view-create-group" class="view">
        <header>
            <i class="ri-close-line" onclick="sys.closeView('view-create-group')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Novo Grupo</h3>
        </header>
        <div style="padding: 20px; flex:1; display:flex; flex-direction:column;">
            <input type="text" id="group-name-input" class="field" placeholder="Nome do Grupo" style="margin-bottom:20px;">
            <div id="group-contact-list" style="flex:1; overflow-y:auto; border:1px solid var(--border); border-radius:12px; margin-bottom:20px;"></div>
            <button class="btn" style="width:100%;" onclick="sys.createGroup()">CRIAR</button>
        </div>
    </div>

    <div id="view-me" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-me')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Editar Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="me-large-av"></div>
            <input type="text" id="edit-name" class="field" style="width:100%; margin-bottom:10px;" placeholder="Nome">
            <input type="text" id="edit-bio" class="field" style="width:100%; margin-bottom:10px;" placeholder="Bio">
            <input type="text" id="edit-pic" class="field" style="width:100%; margin-bottom:20px;" placeholder="URL Foto">
            <button class="btn" style="width:100%; margin-bottom:10px;" onclick="sys.saveProfile()">SALVAR</button>
            <button class="btn" style="width:100%; background:transparent; border:1px solid #ff3b30; color:#ff3b30;" onclick="sys.logout()">SAIR</button>
        </div>
    </div>

    <div id="view-contact" class="view">
        <header>
            <i class="ri-arrow-left-s-line" onclick="sys.closeView('view-contact')" style="font-size: 28px;"></i>
            <h3 style="flex:1; text-align:center; padding-right:28px;">Perfil</h3>
        </header>
        <div class="profile-hero">
            <div class="big-av" id="contact-large-av"></div>
            <h2 id="contact-real-name" style="margin-bottom:5px;">Nome</h2>
            <div id="contact-real-id" style="color:var(--primary); font-family:monospace; margin-bottom:15px;">@id</div>
            <p id="contact-real-bio" style="color:var(--text-dim);">...</p>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-controls">
            <button class="ctrl-btn" onclick="sys.toggleMic()"><i class="ri-mic-fill"></i></button>
            <button class="ctrl-btn end-call" onclick="sys.endCall()"><i class="ri-phone-fill" style="transform: rotate(135deg);"></i></button>
        </div>
    </div>
</div>

<script>
const sys = {
    peer: null, uid: null, db: {}, activeConns: {}, currentChat: null,
    callStream: null, incomingCall: null,
    audioRecorder: null, audioChunks: [], canSendText: false,
    audioPlayers: {}, // Armazena estado dos players

    init() {
        const raw = localStorage.getItem('crimson_db');
        this.db = raw ? JSON.parse(raw) : {};
        const session = localStorage.getItem('crimson_session');
        if(session && this.db[session]) {
            this.uid = session;
            this.startApp();
        }
        document.getElementById('msg-input').onkeydown = (e) => { if(e.key === 'Enter') this.send(); };
    },

    auth(isRegister) {
        const id = document.getElementById('auth-id').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value.trim();
        if(id.length < 3) return alert("M√≠nimo 3 chars");
        if(isRegister) {
            if(this.db[id]) return alert("J√° existe");
            this.db[id] = { pass, name: id, bio: "", pic: "", friends: {}, groups: {} };
            this.saveDb(); alert("Criado. Entre agora.");
        } else {
            if(!this.db[id] || this.db[id].pass !== pass) return alert("Erro");
            this.uid = id; localStorage.setItem('crimson_session', id);
            this.startApp();
        }
    },

    startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        this.peer = new Peer(this.uid);
        this.peer.on('open', () => {
            Object.keys(this.db[this.uid].friends).forEach(fid => this.connectTo(fid));
        });
        this.peer.on('connection', c => this.setupConn(c));
        this.peer.on('call', call => {
            if(confirm('Recebendo chamada...')) { this.incomingCall = call; this.answerCall(); }
        });
        this.updateHeader();
        this.renderHome();
    },

    connectTo(fid) {
        if(!this.activeConns[fid]) this.setupConn(this.peer.connect(fid));
    },

    setupConn(conn) {
        this.activeConns[conn.peer] = conn;
        conn.on('open', () => {
            this.updateStatus(conn.peer, 'online');
            conn.send({ type: 'sync', name: this.db[this.uid].name, pic: this.db[this.uid].pic });
        });
        conn.on('data', d => this.handleData(conn.peer, d));
        conn.on('close', () => this.updateStatus(conn.peer, 'offline'));
    },

    handleData(sender, data) {
        if(data.type === 'msg' || data.type === 'audio') {
            if(data.groupId) this.saveGroupMsg(data);
            else this.saveMsg(sender, sender, data.text, 'received', data.type);
        }
        if(data.type === 'sync') {
            const f = this.db[this.uid].friends[sender];
            if(f) { f.name = data.name; f.pic = data.pic; this.saveDb(); this.renderHome(); }
        }
    },

    // --- INPUT & ACTION BUTTON LOGIC ---
    handleInput() {
        const input = document.getElementById('msg-input');
        const micIcon = document.getElementById('icon-mic');
        const sendIcon = document.getElementById('icon-send');
        
        if(input.value.trim().length > 0) {
            this.canSendText = true;
            micIcon.style.display = 'none';
            sendIcon.style.display = 'block';
        } else {
            this.canSendText = false;
            micIcon.style.display = 'block';
            sendIcon.style.display = 'none';
        }
    },

    handleAction() {
        if(this.canSendText) {
            this.send();
        } else {
            this.toggleRecord();
        }
    },

    // --- RECORDING ---
    async toggleRecord() {
        const btn = document.getElementById('btn-action');
        
        if(!this.audioRecorder) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.audioRecorder = new MediaRecorder(stream);
                this.audioChunks = [];
                this.audioRecorder.ondataavailable = e => this.audioChunks.push(e.data);
                this.audioRecorder.onstop = () => {
                    const blob = new Blob(this.audioChunks, { type: 'audio/webm;codecs=opus' });
                    const reader = new FileReader();
                    reader.onloadend = () => this.send(reader.result, 'audio');
                    reader.readAsDataURL(blob);
                    stream.getTracks().forEach(t => t.stop());
                    this.audioRecorder = null;
                };
                this.audioRecorder.start();
                btn.classList.add('recording');
            } catch(e) { alert("Erro Mic"); }
        } else {
            this.audioRecorder.stop();
            btn.classList.remove('recording');
        }
    },

    send(content = null, type = 'text') {
        let text = content;
        const input = document.getElementById('msg-input');
        if(!text) { text = input.value.trim(); input.value = ''; this.handleInput(); }
        if(!text || !this.currentChat) return;

        if(this.currentChat.startsWith('group_')) {
            const grp = this.db[this.uid].groups[this.currentChat];
            const msg = { sender: this.uid, text, time: Date.now(), status: 'sent', type };
            grp.history.push(msg);
            this.saveDb(); this.renderMessages();
            grp.members.forEach(m => {
                if(m !== this.uid && this.activeConns[m]) 
                    this.activeConns[m].send({ ...msg, groupId: this.currentChat });
            });
        } else {
            this.saveMsg(this.currentChat, this.uid, text, 'sent', type);
            if(this.activeConns[this.currentChat]) 
                this.activeConns[this.currentChat].send({ type, text });
        }
        this.renderHome();
    },

    saveMsg(fid, sender, text, status, type) {
        if(!this.db[this.uid].friends[fid]) this.db[this.uid].friends[fid] = { history: [] };
        this.db[this.uid].friends[fid].history.push({ sender, text, time: Date.now(), status, type });
        this.saveDb();
        if(this.currentChat === fid) this.renderMessages();
        else this.renderHome();
    },

    saveGroupMsg(data) {
        const grp = this.db[this.uid].groups[data.groupId];
        if(grp) {
            grp.history.push({ sender: data.sender, text: data.text, time: Date.now(), status: 'read', type: data.type });
            this.saveDb();
            if(this.currentChat === data.groupId) this.renderMessages();
            else this.renderHome();
        }
    },

    // --- RENDERIZADOR ---
    renderMessages() {
        const area = document.getElementById('messages');
        area.innerHTML = '';
        let msgs = [];
        if(this.currentChat) {
            if(this.currentChat.startsWith('group_')) msgs = this.db[this.uid].groups[this.currentChat].history;
            else msgs = this.db[this.uid].friends[this.currentChat].history;
        }

        msgs.forEach((m, idx) => {
            const isMe = m.sender === this.uid;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'sent' : 'received'}`;
            
            // Meta info (hora)
            const timeStr = new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            let meta = `<div class="msg-meta"><span>${timeStr}</span>`;
            if(isMe) meta += `<span class="tick"><i class="ri-check-double-line"></i></span>`;
            meta += `</div>`;

            // Conte√∫do
            if(m.type === 'audio') {
                // Unique ID para o player
                const pid = 'audio_' + idx + '_' + Date.now();
                let avatarHtml = '';
                
                // Se for grupo ou recebido, mostrar avatar
                if(!isMe) {
                    let picSrc = '';
                    if(this.currentChat.startsWith('group_')) {
                         const f = this.db[this.uid].friends[m.sender];
                         picSrc = f ? f.pic : '';
                    } else {
                        const f = this.db[this.uid].friends[m.sender];
                        picSrc = f ? f.pic : '';
                    }
                    if(!picSrc) picSrc = 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
                    avatarHtml = `<div class="audio-headshot"><img src="${picSrc}"><div class="audio-mic-icon"><i class="ri-mic-fill"></i></div></div>`;
                }

                div.innerHTML = `
                    <div class="audio-container">
                        ${avatarHtml}
                        <div class="audio-top">
                            <button class="play-btn" id="btn_${pid}" onclick="sys.toggleAudio('${pid}')">
                                <i class="ri-play-fill"></i>
                            </button>
                            <div class="audio-ctrls">
                                <input type="range" min="0" max="100" value="0" class="seek-bar" id="seek_${pid}" oninput="sys.seekAudio('${pid}')">
                            </div>
                        </div>
                        <div class="audio-time" id="time_${pid}">0:00</div>
                    </div>
                    <audio id="${pid}" src="${m.text}" preload="metadata" ontimeupdate="sys.updateAudioUI('${pid}')" onended="sys.resetAudioUI('${pid}')" onloadedmetadata="sys.setDuration('${pid}')"></audio>
                    ${meta}
                `;
            } else {
                // Texto normal
                let senderName = '';
                if(!isMe && this.currentChat.startsWith('group_')) {
                    const f = this.db[this.uid].friends[m.sender];
                    senderName = `<div style="font-size:11px; font-weight:700; color:var(--primary); margin-bottom:2px;">${f ? f.name : m.sender}</div>`;
                }
                div.innerHTML = `${senderName}<span>${m.text}</span>${meta}`;
            }
            area.appendChild(div);
        });
        area.scrollTop = area.scrollHeight;
    },

    // --- PLAYER DE √ÅUDIO CUSTOMIZADO LOGIC ---
    toggleAudio(pid) {
        const audio = document.getElementById(pid);
        const btn = document.getElementById('btn_' + pid);
        
        // Pausar outros
        document.querySelectorAll('audio').forEach(a => {
            if(a.id !== pid && !a.paused) {
                a.pause();
                this.resetAudioUI(a.id);
            }
        });

        if(audio.paused) {
            audio.play();
            btn.innerHTML = '<i class="ri-pause-fill"></i>';
        } else {
            audio.pause();
            btn.innerHTML = '<i class="ri-play-fill"></i>';
        }
    },

    updateAudioUI(pid) {
        const audio = document.getElementById(pid);
        const seek = document.getElementById('seek_' + pid);
        const time = document.getElementById('time_' + pid);
        
        if(!isNaN(audio.duration)) {
            const pct = (audio.currentTime / audio.duration) * 100;
            seek.value = pct;
            
            // Format time mm:ss
            let mins = Math.floor(audio.currentTime / 60);
            let secs = Math.floor(audio.currentTime % 60);
            if(secs < 10) secs = '0' + secs;
            time.innerText = mins + ':' + secs;
        }
    },

    seekAudio(pid) {
        const audio = document.getElementById(pid);
        const seek = document.getElementById('seek_' + pid);
        const goTo = audio.duration * (seek.value / 100);
        audio.currentTime = goTo;
    },

    resetAudioUI(pid) {
        const btn = document.getElementById('btn_' + pid);
        const seek = document.getElementById('seek_' + pid);
        const time = document.getElementById('time_' + pid);
        const audio = document.getElementById(pid);
        
        btn.innerHTML = '<i class="ri-play-fill"></i>';
        seek.value = 0;
        // Resetar para dura√ß√£o total
        if(!isNaN(audio.duration)) {
             let mins = Math.floor(audio.duration / 60);
             let secs = Math.floor(audio.duration % 60);
             if(secs < 10) secs = '0' + secs;
             time.innerText = mins + ':' + secs;
        } else {
            time.innerText = "0:00";
        }
    },

    setDuration(pid) {
        const audio = document.getElementById(pid);
        const time = document.getElementById('time_' + pid);
        if(!isNaN(audio.duration)) {
             let mins = Math.floor(audio.duration / 60);
             let secs = Math.floor(audio.duration % 60);
             if(secs < 10) secs = '0' + secs;
             time.innerText = mins + ':' + secs;
        }
    },

    // --- RESTO DO SISTEMA (Grupos, Header, etc) ---
    renderHome() {
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        let chats = [];
        
        Object.keys(this.db[this.uid].friends).forEach(id => {
            const f = this.db[this.uid].friends[id];
            const last = f.history[f.history.length-1];
            chats.push({ id, name: f.name || id, pic: f.pic, last: last, type: 'user' });
        });
        Object.keys(this.db[this.uid].groups).forEach(id => {
            const g = this.db[this.uid].groups[id];
            const last = g.history[g.history.length-1];
            chats.push({ id, name: g.name, pic: null, last: last, type: 'group' });
        });
        
        chats.sort((a,b) => (b.last?.time || 0) - (a.last?.time || 0));

        chats.forEach(c => {
            let msg = 'Nova conversa';
            if(c.last) msg = c.last.type === 'audio' ? 'üéµ √Åudio' : c.last.text;
            
            const av = c.pic ? `<img src="${c.pic}">` : (c.type==='group'?'<i class="ri-group-fill"></i>':c.name[0]);
            
            const div = document.createElement('div');
            div.style.cssText = "display:flex; align-items:center; gap:15px; padding:16px 20px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;";
            div.innerHTML = `
                <div class="avatar">${av}</div>
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:15px;">${c.name}</div>
                    <div style="color:var(--text-dim); font-size:13px;">${msg}</div>
                </div>`;
            div.onclick = () => this.openChat(c.id);
            list.appendChild(div);
        });
    },

    openChat(id) {
        this.currentChat = id;
        const isGroup = id.startsWith('group_');
        const data = isGroup ? this.db[this.uid].groups[id] : this.db[this.uid].friends[id];
        
        document.getElementById('chat-name').innerText = data.name || id;
        document.getElementById('chat-av').innerHTML = data.pic ? `<img src="${data.pic}">` : (isGroup?'<i class="ri-group-fill"></i>':data.name[0]);
        this.updateStatus(id, 'offline'); 
        this.renderMessages();
        this.openView('view-chat');
        // Reset input
        document.getElementById('msg-input').value = '';
        this.handleInput();
    },

    updateStatus(id, status) {
        if(!this.currentChat || this.currentChat.startsWith('group_')) return;
        const el = document.getElementById('chat-status-text');
        if(id === this.currentChat) {
            if(status === 'online') {
                 el.innerHTML = '<span class="online-dot"></span>Online';
                 el.className = 'status-online';
            } else {
                 el.innerText = 'Offline';
                 el.className = 'status-offline';
            }
        }
    },

    createGroup() {
        const name = document.getElementById('group-name-input').value;
        const gid = 'group_' + Date.now();
        this.db[this.uid].groups[gid] = { name, members: [this.uid, ...this.selectedMembers], history: [] };
        this.saveDb(); this.closeView('view-create-group'); this.openChat(gid);
    },
    
    renderCreateGroup() {
        this.selectedMembers = [];
        const list = document.getElementById('group-contact-list'); list.innerHTML = '';
        Object.keys(this.db[this.uid].friends).forEach(id => {
            const f = this.db[this.uid].friends[id];
            const d = document.createElement('div');
            d.className = 'contact-select-item';
            d.innerHTML = `<div class="checkbox-fake"></div><div>${f.name}</div>`;
            d.onclick = () => {
                d.classList.toggle('selected');
                if(d.classList.contains('selected')) this.selectedMembers.push(id);
                else this.selectedMembers = this.selectedMembers.filter(m => m!==id);
            };
            list.appendChild(d);
        });
    },

    // Helpers
    saveDb() { localStorage.setItem('crimson_db', JSON.stringify(this.db)); },
    saveProfile() {
        const me = this.db[this.uid];
        me.name = document.getElementById('edit-name').value;
        me.bio = document.getElementById('edit-bio').value;
        me.pic = document.getElementById('edit-pic').value;
        this.saveDb(); this.updateHeader(); this.closeView('view-me');
    },
    updateHeader() {
        const me = this.db[this.uid];
        document.getElementById('header-name').innerText = me.name;
        document.getElementById('header-av').innerHTML = me.pic ? `<img src="${me.pic}">` : this.uid[0];
        document.getElementById('edit-name').value = me.name;
        document.getElementById('edit-bio').value = me.bio;
        document.getElementById('edit-pic').value = me.pic;
    },
    addContact() {
        const id = document.getElementById('target-id').value.trim().toLowerCase();
        if(id && id !== this.uid) {
            if(!this.db[this.uid].friends[id]) this.db[this.uid].friends[id] = { history: [], name: id };
            this.saveDb(); this.closeView('view-add'); this.openChat(id);
        }
    },
    logout() { localStorage.removeItem('crimson_session'); location.reload(); },
    openView(id) { if(id==='view-create-group') this.renderCreateGroup(); document.getElementById(id).classList.add('active'); },
    closeView(id) { document.getElementById(id).classList.remove('active'); },
    closeChat() { this.currentChat = null; this.closeView('view-chat'); this.renderHome(); },
    showContact() { if(this.currentChat) this.openView('view-contact'); },
    
    // Calls placeholder
    call(v) { alert('Chamada iniciada...'); },
    endCall() { document.getElementById('call-ui').classList.remove('active'); }
};

sys.init();
</script>
</body>
</html>
